name: Build and Push As Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (e.g. 2025.1.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: 'Source/Reef.sln'
  PROJECT_PATH: 'Source/Reef/Reef.csproj'
  SOURCE_DIR: 'Source/Reef'
  DEPLOYMENT_PATH: 'Deployment'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          dotnet tool install -g dotnet-project-licenses

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ github.event.inputs.tag_name }}" -m "Release ${{ github.event.inputs.tag_name }}"
          git push origin "${{ github.event.inputs.tag_name }}"

      - name: Clean deployment directory
        run: |
          rm -rf ${{ env.DEPLOYMENT_PATH }}
          mkdir -p ${{ env.DEPLOYMENT_PATH }}

      - name: Restore and build
        run: |
          echo "Working directory: $(pwd)"
          echo "Looking for solution at: ${{ env.SOLUTION_PATH }}"
          ls -la Source/ || true
          echo ""
          echo "Restoring solution..."
          dotnet clean ${{ env.SOURCE_DIR }} -c Release || true
          dotnet restore ${{ env.SOLUTION_PATH }}
          echo ""
          echo "Building solution..."
          dotnet build ${{ env.SOLUTION_PATH }} -c Release --no-restore

      - name: Publish application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c Release \
            -r win-x64 \
            --self-contained false \
            -p:PublishSingleFile=true \
            -p:DebugType=None \
            -p:DebugSymbols=false \
            --framework net9.0 \
            -o ${{ env.DEPLOYMENT_PATH }}

      - name: Create deployment structure
        run: |
          cd ${{ env.DEPLOYMENT_PATH }}
          
          # Create required folders
          mkdir -p exports log .core license/packages
          
          # Remove unnecessary files
          rm -f *.pdb *.xml *.deps.json web.config *.Development.json \
                *.staticwebassets.endpoints.json
          
          # Copy documentation
          cp ../LICENSE license/LICENSE.txt || true
          cp ../README.md . || true
          
          # Create source reference
          echo "https://github.com/${{ github.repository }}" > license/source.txt

      - name: Generate third-party licenses
        run: |
          dotnet-project-licenses \
            --input ${{ env.PROJECT_PATH }} \
            --export-license-texts \
            --output-directory ${{ env.DEPLOYMENT_PATH }}/license/packages \
            || echo "⚠️  Warning: Could not generate package licenses"

      - name: Create service management script
        run: |
          cat > ${{ env.DEPLOYMENT_PATH }}/Reef.bat << 'EOFBAT'
          @echo off
          setlocal enabledelayedexpansion
          
          set SERVICE_NAME=ReefExportService
          set DISPLAY_NAME=Reef Export Service
          set DESCRIPTION=Enterprise data export and automation service
          set EXE_PATH=%~dp0Reef.exe
          
          if "%1"=="" goto :usage
          
          if /i "%1"=="install" goto :install
          if /i "%1"=="uninstall" goto :uninstall
          if /i "%1"=="start" goto :start
          if /i "%1"=="stop" goto :stop
          if /i "%1"=="restart" goto :restart
          if /i "%1"=="status" goto :status
          if /i "%1"=="test" goto :test
          goto :usage
          
          :install
            echo Installing Reef Service...
            sc create "%SERVICE_NAME%" ^
              binPath= "\"%EXE_PATH%\"" ^
              start= auto ^
              displayname= "%DISPLAY_NAME%"
            
            if !ERRORLEVEL! EQU 0 (
              sc description "%SERVICE_NAME%" "%DESCRIPTION%"
              echo ✓ Service installed successfully
              echo Run '%~nx0 start' to start the service
            ) else (
              echo ✗ Installation failed. Run as Administrator.
            )
            goto :eof
          
          :uninstall
            echo Stopping service...
            sc stop "%SERVICE_NAME%" >nul 2>&1
            timeout /t 3 /nobreak >nul
            
            echo Uninstalling Reef Service...
            sc delete "%SERVICE_NAME%"
            
            if !ERRORLEVEL! EQU 0 (
              echo ✓ Service uninstalled successfully
            ) else (
              echo ✗ Uninstall failed. Run as Administrator.
            )
            goto :eof
          
          :start
            echo Starting Reef Service...
            sc start "%SERVICE_NAME%"
            
            if !ERRORLEVEL! EQU 0 (
              echo ✓ Service started successfully
              echo Access web UI at: http://localhost:8085
            ) else (
              echo ✗ Failed to start service
            )
            goto :eof
          
          :stop
            echo Stopping Reef Service...
            sc stop "%SERVICE_NAME%"
            
            if !ERRORLEVEL! EQU 0 (
              echo ✓ Service stopped successfully
            ) else (
              echo ✗ Failed to stop service
            )
            goto :eof
          
          :restart
            call :stop
            timeout /t 3 /nobreak >nul
            call :start
            goto :eof
          
          :status
            echo Reef Service Status:
            echo ====================
            sc query "%SERVICE_NAME%"
            echo.
            echo Recent logs:
            if exist "%~dp0log\reef-*.log" (
              powershell -Command "Get-Content '%~dp0log\reef-*.log' -Tail 20"
            ) else (
              echo No logs found
            )
            goto :eof
          
          :test
            echo Running Reef in console mode...
            echo Press Ctrl+C to stop
            echo.
            echo Web UI will be available at: http://localhost:8085
            echo.
            "%EXE_PATH%"
            goto :eof
          
          :usage
            echo Reef Export Service Manager
            echo ============================
            echo.
            echo Usage: %~nx0 {command}
            echo.
            echo Commands:
            echo   install   - Install as Windows service (requires Admin)
            echo   uninstall - Remove Windows service (requires Admin)
            echo   start     - Start the service
            echo   stop      - Stop the service
            echo   restart   - Restart the service
            echo   status    - Show service status and recent logs
            echo   test      - Run in console mode for testing
            echo.
            goto :eof
          EOFBAT

      - name: Create README
        run: |
          cat > ${{ env.DEPLOYMENT_PATH }}/README.txt << 'EOFREADME'
          ╔═══════════════════════════════════════════════════════════╗
          ║                  REEF EXPORT SERVICE                      ║
          ║                      Version 2.0                          ║
          ╚═══════════════════════════════════════════════════════════╝
          
          PREREQUISITES
          =============
          
          ** REQUIRED: .NET 9.0 Runtime **
          Download from: https://dotnet.microsoft.com/download/dotnet/9.0
          Install "ASP.NET Core Runtime 9.0.x" for Windows x64
          
          QUICK START
          ===========
          
          1. TEST MODE (Recommended First)
             Run: Reef.bat test
             Access: http://localhost:8085
             Stop: Press Ctrl+C
          
          2. INSTALL AS WINDOWS SERVICE
             Run as Administrator: Reef.bat install
             Start service: Reef.bat start
             Access: http://localhost:8085
          
          3. DEFAULT LOGIN
             Username: admin
             Password: (set on first login)
          
          CONFIGURATION
          =============
          
          Required Configuration:
          - Set encryption key (HIGHLY RECOMMENDED):
            Set Windows environment variable:
            REEF_ENCRYPTION_KEY=your-secure-random-key-here
          
          - Edit appsettings.json for:
            * Port (default: 8085)
            * JWT secret
            * SMTP settings
            * Export path
          
          Optional:
          - Edit appsettings.Development.json for development
          - Create .env file in deployment folder
          
          SERVICE MANAGEMENT
          ==================
          
          Reef.bat commands:
            install   - Install Windows service (requires Admin)
            start     - Start the service
            stop      - Stop the service
            restart   - Restart the service
            status    - Show status and recent logs
            uninstall - Remove Windows service (requires Admin)
            test      - Run in console mode
          
          FOLDER STRUCTURE
          ================
          
          exports/     - Exported data files (configurable)
          log/         - Application logs (Serilog)
          .core/       - Encryption keys (DO NOT DELETE)
          wwwroot/     - Web UI static files
          Reef.db      - SQLite database
          
          TROUBLESHOOTING
          ===============
          
          Service won't start:
          1. Run: Reef.bat test (check console errors)
          2. Check logs in: log/reef-YYYYMMDD.log
          3. Verify port 8085 is available
          4. Ensure REEF_ENCRYPTION_KEY is set
          
          Web UI not accessible:
          1. Check service status: Reef.bat status
          2. Verify firewall allows port 8085
          3. Try: http://localhost:8085/health
          
          Database issues:
          1. Check Reef.db exists and is writable
          2. Check file permissions
          3. Review logs for SQLite errors
          
          SECURITY NOTES
          ==============
          
          ⚠️  IMPORTANT:
          - Set REEF_ENCRYPTION_KEY environment variable
          - Change default JWT secret in appsettings.json
          - Use HTTPS in production (reverse proxy)
          - Backup Reef.db regularly
          - Backup .core/ folder (encryption keys)
          - Limit network access to port 8085
          
          DOCUMENTATION
          =============
          
          Full documentation: https://github.com/hawkinslabdev/reef
          API Reference: http://localhost:8085/
          
          LICENSE
          =======
          
          AGPL-3.0-or-later
          See license/LICENSE.txt
          
          SUPPORT
          =======
          
          Issues: https://github.com/hawkinslabdev/reef/issues
          EOFREADME

      - name: Create version file
        run: |
          echo "${{ github.event.inputs.tag_name }}" > ${{ env.DEPLOYMENT_PATH }}/.version.txt
          echo "Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ${{ env.DEPLOYMENT_PATH }}/.version.txt
          echo "Commit: ${{ github.sha }}" >> ${{ env.DEPLOYMENT_PATH }}/.version.txt

      - name: Create deployment archive
        run: |
          cd ${{ env.DEPLOYMENT_PATH }}
          zip -r ../Reef-${{ github.event.inputs.tag_name }}-win-x64.zip .
          cd ..
          # Create checksums
          sha256sum Reef-${{ github.event.inputs.tag_name }}-win-x64.zip > \
            Reef-${{ github.event.inputs.tag_name }}-win-x64.zip.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            Reef-${{ github.event.inputs.tag_name }}-win-x64.zip
            Reef-${{ github.event.inputs.tag_name }}-win-x64.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reef-${{ github.event.inputs.tag_name }}
          path: Reef-${{ github.event.inputs.tag_name }}-win-x64.zip
          retention-days: 90