<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destinations &middot; Reef</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/assets/js/_tailwind.3.4.17.js"></script>
    <script src="/assets/js/_lucide.0.552.0.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/filter.js"></script>
    <script src="/assets/js/main.js"></script>
</head>
<!-- To-do: Azure Blob has no advanced settings in UI -->
<body class="bg-slate-50">
    <script>
        requireAuth();
    </script>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:flex md:flex-col md:w-60 bg-slate-800 text-slate-300">
            <div class="flex items-center justify-left px-6 h-16 border-b border-slate-700">
                <i data-lucide="waves" class="h-6 w-6 stroke-blue-400/80"></i> 
                
                <div class="flex items-center ml-3 select-none mt-0.5">
                    <span class="text-slate-100 text-lg font-semibold font-inter tracking-tight">
                    Reef
                    </span>
                    <span class="ml-3 px-3 py-1 rounded border border-slate-700 text-slate-400 text-[10px] uppercase tracking-wide leading-none">
                    beta
                    </span>
                </div>
            </div>
            
            <nav class="flex-1 px-4 py-4">
                <a href="/dashboard" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Management</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/connections" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="plug" class="h-5 w-5"></i>
                            <span class="ml-3">Connections</span>
                        </a>
                        <a href="/destinations" class="flex items-center px-4 py-3 rounded-lg bg-slate-900 text-slate-100">
                            <i data-lucide="send" class="h-5 w-5"></i>
                            <span class="ml-3">Destinations</span>
                        </a>
                        <a href="/templates" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="file-text" class="h-5 w-5"></i>
                            <span class="ml-3">Templates</span>
                        </a>
                        <a href="/groups" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="folder" class="h-5 w-5"></i>
                            <span class="ml-3">Groups</span>
                        </a>
                        <a href="/profiles" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="file-code" class="h-5 w-5"></i>
                            <span class="ml-3">Profiles</span>
                        </a>
                    </div>
                </div>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Automation</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/jobs" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="briefcase" class="h-5 w-5"></i>
                            <span class="ml-3">Jobs</span>
                        </a>
                        <a href="/executions" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="activity" class="h-5 w-5"></i>
                            <span class="ml-3">Executions</span>
                        </a>
                        <a href="/email-approvals" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="check-square" class="h-5 w-5"></i>
                            <span class="ml-3">Approvals</span>
                        </a>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Reference</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/documentation" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="book-open" class="h-5 w-5"></i>
                            <span class="ml-3">Documentation</span>
                        </a>
                    </div>
                </div>
            </nav>
            <!-- User Section with Expandable Menu -->
            <div class="border-t border-gray-700">
                <button onclick="toggleUserMenu()" class="w-full flex items-center justify-between p-4 hover:bg-gray-800 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <span id="user-initial" class="text-white font-bold text-lg">&nbsp;</span>
                        </div>
                        <div class="text-left">
                            <div id="username-display" class="text-white font-semibold">&nbsp;</div>
                            <div class="text-xs text-gray-400">View menu</div>
                        </div>
                    </div>
                    <i id="chevron-icon" data-lucide="chevron-up" class="h-4 w-4 text-gray-400 transition-transform"></i>
                </button>
                
                <!-- Expandable Menu -->
                <div id="user-menu" class="overflow-hidden user-menu-collapsed">
                    <div class="px-2 pb-2 space-y-1">
                        <a href="/admin" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="settings" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Settings</span>
                        </a>
                        <a href="https://github.com/melosso/reef" target="_blank" rel="noopener noreferrer" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="github" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">GitHub</span>
                            <i data-lucide="external-link" class="h-3 w-3 ml-auto"></i>
                        </a>
                        <button onclick="logout()" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="log-out" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm z-10">
                <div class="flex items-center justify-between px-6 py-3">
                    <h1 class="text-2xl font-semibold text-gray-900 disable-select">Destinations</h1>
                    <div class="flex space-x-3 items-center">
                        <button onclick="openHelpModal()" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out" aria-label="Help">
                            <i data-lucide="help-circle" class="h-5 w-5"></i>
                        </button>
                        <button onclick="openAddDestinationModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Add Destination
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto bg-gray-100 p-6">
                <!-- Filter Bar - with placeholder to prevent layout shift -->
                <div id="filter-container" class="mb-6">
                    <div class="bg-white rounded-lg shadow p-4 animate-pulse">
                        <div class="h-10 bg-gray-200 rounded mb-3"></div>
                        <div class="flex gap-2 mb-3">
                            <div class="h-8 bg-gray-200 rounded-full w-16"></div>
                            <div class="h-8 bg-gray-200 rounded-full w-16"></div>
                            <div class="h-8 bg-gray-200 rounded-full w-16"></div>
                        </div>
                    </div>
                </div>

                <!-- Destinations List -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="destinations-list" class="space-y-4">
                            <p class="text-sm text-gray-500">Loading destinations...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Destination Modal -->
    <div id="add-destination-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="destination-modal-title" class="text-lg font-semibold text-gray-900">Add New Destination</h3>
                <div class="flex items-center space-x-2">
                    <!-- More Options Menu (only visible when editing) -->
                    <div id="destination-more-options" class="relative hidden">
                        <button type="button" onclick="toggleDestinationOptionsMenu()" class="text-gray-400 hover:text-gray-600 p-1">
                            <i data-lucide="more-vertical" class="h-6 w-6"></i>
                        </button>
                        <div id="destination-options-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                            <div class="py-1">
                                <button type="button" onclick="toggleDestinationActiveStatus()" 
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <i data-lucide="power" class="h-4 w-4 mr-2"></i>
                                    <span id="destination-toggle-text">Disable</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeAddDestinationModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            
            <form id="add-destination-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="destination-name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Production S3 Bucket">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="destination-type" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            onchange="updateConfigFields()">
                        <option value="">Select type...</option>
                        <option value="Local">File System</option>
                        <option value="Ftp">FTP/FTPS</option>
                        <option value="Sftp">SFTP</option>
                        <option value="AzureBlob">Azure Blob Storage</option>
                        <option value="S3">AWS S3</option>
                        <option value="Email">Email</option>
                        <option value="Http">HTTP/HTTPS REST API</option>
                        <option value="NetworkShare">SMB/CIFS</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="destination-description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Optional description"></textarea>
                </div>

                <div id="config-fields" class="space-y-4">
                    <!-- Dynamic configuration fields will be inserted here -->
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input type="text" id="destination-tags"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="production, aws">
                    <p class="text-xs text-gray-500 mt-1">Comma-separated tags</p>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="test-destination-btn" onclick="testDestination()" 
                            class="disabled px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex items-center">
                        <svg id="test-destination-spinner" class="animate-spin h-4 w-4 mr-2 text-gray-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                        <span id="test-destination-btn-text">Test Connection</span>
                    </button>
                    <button type="button" onclick="closeAddDestinationModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Save Destination
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white mb-20" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
            <div id="help-modal-content-area">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="help-modal-title" class="text-xl font-bold text-gray-900 flex items-center">
                        <i data-lucide="lightbulb" class="h-6 w-6 mr-2 text-yellow-500"></i>
                        How to use Destinations
                    </h3>
                    <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-500 p-1" aria-label="Close help guide">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="space-y-4 text-gray-700">
                    <p>The <b>Destinations</b> page allows you to configure your destinations. In other words, your profiles will retrieve data and sent it to a destination. The target where you'll be exporting the data to, that's what you're configuring here.</p>

                    <h4 class="text-l font-semibold text-gray-800"><b>Things to know:</b></h4>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li><b>Add Destination:</b> Click the <b>"Add Destination"</b> button to create a new destination by specifying its type, configuration, and details.</li>
                        <li><b>Edit/Delete:</b> Use the <i data-lucide="edit" class="h-4 w-4 inline text-blue-600"></i> (Edit) and <i data-lucide="trash-2" class="h-4 w-4 inline text-red-600"></i> (Delete) icons to modify or remove existing destinations.</li>
                        <li><b>Status:</b> Each destination shows whether it is <span class="bg-green-100 text-green-800 px-1 rounded text-xs">Active</span> or <span class="bg-gray-200 text-gray-500 px-1 rounded text-xs">Inactive</span>.</li>
                        <li><b>Test Connection:</b> Use the <b>Test Connection</b> button in the add/edit form to verify your configuration before saving.</li>
                        <li><b>Tags:</b> You can add comma-separated tags to help organize and filter your destinations.</li>
                    </ul>

                    <blockquote class="border-l-4 border-blue-500 pl-4 py-2 italic text-gray-600 bg-blue-50 rounded-r-md pr-2">
                        <p><strong>Tip:</strong> Reef supports various destination types, including File System, FTP/SFTP, Azure Blob, AWS S3, HTTP/HTTPS REST APIs, and SMB. Choose the one that fits your export needs.</p>
                    </blockquote>
                </div>
            </div>
        </div>
    </div>
    <script>
        queueLucideRender();
    </script>
    <script>
        const API_BASE = '/api/destinations';

        function getAuthHeaders() {
            const token = localStorage.getItem('reef_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        function updateConfigFields() {
            const type = document.getElementById('destination-type').value;
            const configFields = document.getElementById('config-fields');
            
            let html = '';
            
            switch(type) {
                case 'Local':
                    html = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Base Path</label>
                            <input type="text" id="config-BasePath" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="C:/Apps/reef/exports or ./exports">
                            <p class="text-xs text-gray-500 mt-1">Absolute path (C:/data) or relative path (./exports, exports/data)</p>
                        </div>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="config-UseRelativePath"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="config-UseRelativePath" class="ml-2 block text-sm text-gray-700">
                                Use Relative Path (relative to application directory)
                            </label>
                        </div>
                    `;
                    break;
                case 'Ftp':
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Host *</label>
                                <input type="text" id="config-host" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="ftp.example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                                <input type="number" id="config-port" value="21"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="config-username"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="config-password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Remote Path</label>
                            <input type="text" id="config-remotePath"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="/uploads">
                        </div>

                        <!-- Advanced Settings Accordion -->
                        <div class="border border-gray-200 rounded-lg">
                            <button type="button" onclick="toggleFtpAdvanced(event)"
                                    class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
                                    <span class="text-sm font-medium text-gray-700">Advanced Settings</span>
                                </div>
                                <i data-lucide="chevron-down" id="ftpAdvancedChevron" class="w-4 h-4 text-gray-400 transition-transform"></i>
                            </button>
                            <div id="ftpAdvanced" class="hidden px-4 pb-4 space-y-4 border-t border-gray-200">
                                <div class="pt-4">
                                    <div class="flex items-start">
                                        <div class="flex items-center h-5">
                                            <input type="checkbox" id="config-usePassiveMode" checked
                                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="ml-3">
                                            <label for="config-usePassiveMode" class="text-sm font-medium text-gray-700">Use Passive Mode</label>
                                            <p class="text-xs text-gray-500 mt-1">Enable passive mode (PASV/EPSV). Required for servers behind NAT/firewalls. Disable if your network requires active mode.</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-start">
                                        <div class="flex items-center h-5">
                                            <input type="checkbox" id="config-useSsl"
                                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="ml-3">
                                            <label for="config-useSsl" class="text-sm font-medium text-gray-700">Use SSL/TLS (FTPS)</label>
                                            <p class="text-xs text-gray-500 mt-1">Enable explicit FTPS encryption for secure file transfers</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (seconds)</label>
                                    <input type="number" id="config-timeoutSeconds" value="60" min="10" max="300"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <p class="text-xs text-gray-500 mt-1">Connection and data transfer timeout</p>
                                </div>

                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-start">
                                        <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0"></i>
                                        <div class="text-xs text-blue-800">
                                            <strong>Troubleshooting:</strong> If uploads fail with "connection refused", try:
                                            <ul class="list-disc ml-4 mt-1 space-y-0.5">
                                                <li>Ensure Passive Mode is enabled (recommended for most servers)</li>
                                                <li>Check that your FTP server's passive port range is accessible</li>
                                                <li>For Docker/containerized FTP servers, configure PASV_ADDRESS with external IP</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'Sftp':
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Host *</label>
                                <input type="text" id="config-host" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="sftp.example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                                <input type="number" id="config-port" value="22"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                            <input type="text" id="config-username" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="sftpuser">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Authentication Type</label>
                            <select id="sftp-auth-type" onchange="updateSftpAuthFields()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="password">Password</option>
                                <option value="privatekey">Private Key (SSH)</option>
                            </select>
                        </div>

                        <!-- Password Auth Fields -->
                        <div id="sftp-password-auth" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                                <input type="password" id="config-password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                            </div>
                        </div>

                        <!-- Private Key Auth Fields -->
                        <div id="sftp-privatekey-auth" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Private Key (PEM format) *</label>
                                <textarea id="config-privateKey" rows="8"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm"
                                          placeholder="-----BEGIN RSA PRIVATE KEY-----&#10;MIIEpAIBAAKCAQEA...&#10;-----END RSA PRIVATE KEY-----"
                                          data-secret-field="true"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Paste your private key content (supports RSA, DSA, ECDSA, ED25519)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Passphrase (if encrypted)</label>
                                <input type="password" id="config-privateKeyPassphrase"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="Leave blank if key is not encrypted"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Only required if your private key is password-protected</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Remote Path</label>
                            <input type="text" id="config-remotePath"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="/uploads">
                        </div>

                        <!-- Advanced Settings Accordion -->
                        <div class="border border-gray-200 rounded-lg">
                            <button type="button" onclick="toggleSftpAdvanced(event)"
                                    class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
                                    <span class="text-sm font-medium text-gray-700">Advanced Settings</span>
                                </div>
                                <i data-lucide="chevron-down" id="sftpAdvancedChevron" class="w-4 h-4 text-gray-400 transition-transform"></i>
                            </button>
                            <div id="sftpAdvanced" class="hidden px-4 pb-4 space-y-4 border-t border-gray-200">
                                <div class="pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (seconds)</label>
                                    <input type="number" id="config-timeoutSeconds" value="60" min="10" max="300"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <p class="text-xs text-gray-500 mt-1">Connection timeout</p>
                                </div>

                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-start">
                                        <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0"></i>
                                        <div class="text-xs text-blue-800">
                                            <strong>SSH Key Generation:</strong> Generate a key pair on Linux/Mac with:
                                            <code class="block bg-white px-2 py-1 rounded mt-1 text-gray-900">ssh-keygen -t rsa -b 4096 -f reef_sftp_key</code>
                                            Then copy the private key content (reef_sftp_key) to the Private Key field above, and add the public key (reef_sftp_key.pub) to your SFTP server's authorized_keys.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'AzureBlob':
                    html = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Connection String</label>
                            <textarea id="config-connectionString" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                      placeholder="DefaultEndpointsProtocol=https;AccountName=..."
                                      data-secret-field="true"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Container Name</label>
                            <input type="text" id="config-containerName" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="exports">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prefix</label>
                            <input type="text" id="config-prefix"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="data/">
                        </div>
                    `;
                    break;
                case 'S3':
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Access Key *</label>
                                <input type="text" id="config-accessKey"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="AKIAIOSFODNN7EXAMPLE"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave blank to keep existing value</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Secret Key *</label>
                                <input type="password" id="config-secretKey"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave blank to keep existing value</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Region *</label>
                                <select id="config-region" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Select region...</option>
                                    <option value="us-east-1">US East (N. Virginia) — us-east-1</option>
                                    <option value="us-east-2">US East (Ohio) — us-east-2</option>
                                    <option value="us-west-1">US West (N. California) — us-west-1</option>
                                    <option value="us-west-2">US West (Oregon) — us-west-2</option>

                                    <option value="eu-west-1">Europe (Ireland) — eu-west-1</option>
                                    <option value="eu-west-2">Europe (London) — eu-west-2</option>
                                    <option value="eu-west-3">Europe (Paris) — eu-west-3</option>
                                    <option value="eu-central-1">Europe (Frankfurt) — eu-central-1</option>

                                    <option value="ap-southeast-1">Asia Pacific (Singapore) — ap-southeast-1</option>
                                    <option value="ap-southeast-2">Asia Pacific (Sydney) — ap-southeast-2</option>
                                    <option value="ap-northeast-1">Asia Pacific (Tokyo) — ap-northeast-1</option>
                                    <option value="ap-south-1">Asia Pacific (Mumbai) — ap-south-1</option>

                                    <option value="sa-east-1">South America (São Paulo) — sa-east-1</option>
                                    <option value="ca-central-1">Canada (Central) — ca-central-1</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bucket Name *</label>
                                <input type="text" id="config-bucketName" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="my-export-bucket">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Path / Prefix</label>
                            <input type="text" id="config-prefix"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="exports/">
                            <p class="text-xs text-gray-500 mt-1">Optional folder prefix within the bucket (e.g., "exports/" or "data/{date}/")</p>
                        </div>

                        <!-- Advanced Settings Accordion -->
                        <div class="border border-gray-200 rounded-lg">
                            <button type="button" onclick="toggleS3Advanced(event)"
                                    class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
                                    <span class="text-sm font-medium text-gray-700">Advanced Settings</span>
                                </div>
                                <i data-lucide="chevron-down" id="s3AdvancedChevron" class="w-4 h-4 text-gray-400 transition-transform"></i>
                            </button>
                            <div id="s3Advanced" class="hidden px-4 pb-4 space-y-4 border-t border-gray-200">
                                <div class="pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Endpoint URL</label>
                                    <input type="url" id="config-serviceUrl"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                                           placeholder="https://minio.example.com:9000">
                                    <p class="text-xs text-gray-500 mt-1">Leave blank for AWS S3. Use for MinIO, Wasabi, DigitalOcean Spaces, Backblaze B2, or other S3-compatible storage</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Access Control (ACL)</label>
                                    <select id="config-acl"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="private" selected>Private (bucket owner full control)</option>
                                        <option value="public-read">Public Read (anyone can read)</option>
                                        <option value="public-read-write">Public Read-Write (anyone can read/write)</option>
                                        <option value="authenticated-read">Authenticated Read (AWS users can read)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Controls who can access uploaded objects</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Storage Class</label>
                                    <select id="config-storageClass"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="STANDARD" selected>Standard (frequently accessed data)</option>
                                        <option value="STANDARD_IA">Standard-IA (infrequent access)</option>
                                        <option value="ONEZONE_IA">One Zone-IA (cheaper, single AZ)</option>
                                        <option value="INTELLIGENT_TIERING">Intelligent-Tiering (auto-optimize)</option>
                                        <option value="GLACIER">Glacier (archive, retrieval time)</option>
                                        <option value="GLACIER_IR">Glacier Instant Retrieval</option>
                                        <option value="DEEP_ARCHIVE">Deep Archive (lowest cost, long retrieval)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Affects storage costs and retrieval times</p>
                                </div>

                                <div>
                                    <div class="flex items-start">
                                        <div class="flex items-center h-5">
                                            <input type="checkbox" id="config-serverSideEncryption" checked
                                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        </div>
                                        <div class="ml-3">
                                            <label for="config-serverSideEncryption" class="text-sm font-medium text-gray-700">Server-Side Encryption (SSE)</label>
                                            <p class="text-xs text-gray-500 mt-1">Encrypt objects at rest using AES-256 (S3-managed keys)</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (seconds)</label>
                                    <input type="number" id="config-timeoutSeconds" value="300" min="30" max="3600"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <p class="text-xs text-gray-500 mt-1">Upload timeout (increase for large files)</p>
                                </div>

                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <div class="flex items-start">
                                        <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-600 mt-0.5 mr-2 flex-shrink-0"></i>
                                        <div class="text-xs text-yellow-800">
                                            <strong>IAM Permissions Required:</strong>
                                            <ul class="list-disc ml-4 mt-1 space-y-0.5">
                                                <li><code class="bg-white px-1 rounded">s3:PutObject</code> - Upload files</li>
                                                <li><code class="bg-white px-1 rounded">s3:PutObjectAcl</code> - Set ACL (if not private)</li>
                                                <li><code class="bg-white px-1 rounded">s3:GetObject</code> - Verify uploads (optional)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'Email':
                    html = `
                        <!-- Email Provider Selector -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Provider *</label>
                            <select id="config-emailProvider" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    onchange="updateEmailProviderFields()">
                                <option value="">Select provider...</option>
                                <option value="Smtp">SMTP</option>
                                <option value="Resend">Resend</option>
                                <option value="SendGrid">SendGrid</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Choose your email service provider</p>
                        </div>

                        <!-- SMTP Provider Fields -->
                        <div id="emailSmtpFields" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Host *</label>
                                    <input type="text" id="config-smtpServer"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                           placeholder="smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">SMTP Port</label>
                                    <input type="number" id="config-smtpPort" value="587"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-lg">
                                <button type="button" onclick="toggleEmailSmtpAdvanced(event)"
                                        class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
                                        <span class="text-sm font-medium text-gray-700">SMTP Advanced Settings</span>
                                    </div>
                                    <i data-lucide="chevron-down" id="emailSmtpAdvancedChevron" class="w-4 h-4 text-gray-400 transition-transform"></i>
                                </button>
                                <div id="emailSmtpAdvanced" class="hidden px-4 pb-4 space-y-4 border-t border-gray-200">
                                    <div class="pt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Authentication Type</label>
                                        <select id="config-authType"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                onchange="toggleEmailAuthFields()">
                                            <option value="Basic">Basic (Username & Password)</option>
                                            <option value="OAuth2">OAuth 2.0 (Access Token)</option>
                                            <option value="None">No Authentication</option>
                                        </select>
                                    </div>

                                    <!-- Basic Auth Fields -->
                                    <div id="emailBasicAuth" class="space-y-4">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                                <input type="text" id="config-smtpUsername"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                       data-secret-field="true"
                                                       placeholder="your-email@gmail.com">
                                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Password / App Password</label>
                                                <input type="password" id="config-smtpPassword"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                       data-secret-field="true"
                                                       placeholder="Your password or app-specific password">
                                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- OAuth2 Auth Fields -->
                                    <div id="emailOAuth2Auth" class="hidden space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">OAuth2 Access Token</label>
                                            <input type="password" id="config-oauthToken"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                   data-secret-field="true"
                                                   placeholder="OAuth2 access token">
                                            <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Username (for OAuth2)</label>
                                            <input type="text" id="config-oauthUsername"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                                   placeholder="your-email@gmail.com">
                                            <p class="text-xs text-gray-500 mt-1">Usually your email address</p>
                                        </div>
                                    </div>

                                    <!-- Connection Settings -->
                                    <div class="border-t border-gray-200 pt-4 space-y-4">
                                        <div class="mb-4 relative">
                                            <label for="config-securityMode" class="block text-sm font-medium text-gray-700 mb-2">
                                                Security
                                                <span class="ml-1 text-gray-400 cursor-help"
                                                    data-tooltip="STARTTLS: Secure, standard for most SMTP servers\nNone: For mock servers or local testing (port 2525)\nAuto: Automatically negotiate TLS if available"
                                                    data-tooltip-position="top">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="info" class="lucide lucide-info w-4 h-4 inline">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <path d="M12 16v-4"></path>
                                                        <path d="M12 8h.01"></path>
                                                    </svg>
                                                </span>
                                            </label>

                                            <select id="config-securityMode" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                                <option value="StartTls" selected>
                                                    STARTTLS (Encrypted, recommended)
                                                </option>
                                                <option value="None">
                                                    None (Plain text, for local or test)
                                                </option>
                                                <option value="Auto">
                                                    Auto-detect (Try TLS if available)
                                                </option>
                                            </select>
                                        </div>

                                        <div>
                                            <div class="flex items-start">
                                                <div class="flex items-center h-5">
                                                    <input type="checkbox" id="config-validateCertificate" checked
                                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                </div>
                                                <div class="ml-3">
                                                    <label for="config-validateCertificate" class="text-sm font-medium text-gray-700">Validate Server Certificate</label>
                                                    <p class="text-xs text-gray-500 mt-1">Verify SSL/TLS certificate validity. Uncheck only for self-signed certificates</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Connection Timeout (seconds)</label>
                                            <input type="number" id="config-timeoutSeconds" value="30" min="5" max="300"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <p class="text-xs text-gray-500 mt-1">How long to wait for SMTP connection (5-300 seconds)</p>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Retry Count</label>
                                            <input type="number" id="config-retryCount" value="3" min="0" max="10"
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <p class="text-xs text-gray-500 mt-1">Number of retry attempts on failure</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resend Provider Fields -->
                        <div id="emailResendFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Resend API Key *</label>
                                <input type="password" id="config-resendApiKey"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="re_xxxxxxxxxxxxx"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://resend.com/api-keys" target="_blank" class="text-blue-600 hover:underline">resend.com/api-keys</a></p>
                            </div>
                        </div>

                        <!-- SendGrid Provider Fields -->
                        <div id="emailSendGridFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">SendGrid API Key *</label>
                                <input type="password" id="config-sendGridApiKey"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="SG.xxxxxxxxxxxxx"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" class="text-blue-600 hover:underline">SendGrid Dashboard</a></p>
                            </div>
                        </div>

                        <!-- Common Fields for All Providers -->
                        <div id="emailCommonFields" class="hidden space-y-4 border-t border-gray-200 pt-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">From Email Address *</label>
                                    <input type="email" id="config-fromAddress"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                           placeholder="noreply@example.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">From Name</label>
                                    <input type="text" id="config-fromName"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                           placeholder="Reef Export Service">
                                    <p class="text-xs text-gray-500 mt-1">Display name for sender (optional)</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'Http':
                    html = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">URL *</label>
                            <input type="url" id="config-url" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="https://api.example.com/upload">
                            <p class="text-xs text-gray-500 mt-1">Target endpoint for HTTP POST</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Format</label>
                            <select id="config-uploadFormat"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="raw">Raw/Binary</option>
                                <option value="multipart">Multipart Form Data</option>
                                <option value="json">JSON Payload</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">How the file is sent to the API</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Authentication Type</label>
                            <select id="config-authType" onchange="updateHttpAuthFields()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">None</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="basic">Basic Auth</option>
                                <option value="apikey">API Key</option>
                                <option value="token">Token</option>
                            </select>
                        </div>
                        <div id="http-auth-fields" class="space-y-4">
                            <!-- Dynamic auth fields will be inserted here -->
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Custom Headers (JSON)</label>
                            <textarea id="config-headers" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm"
                                      placeholder='{"X-Custom-Header": "value", "X-Client-ID": "reef"}'></textarea>
                            <p class="text-xs text-gray-500 mt-1">Optional: JSON object with custom headers</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">File Field Name</label>
                                <input type="text" id="config-fileFieldName"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="file">
                                <p class="text-xs text-gray-500 mt-1">For multipart uploads</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Timeout (seconds)</label>
                                <input type="number" id="config-timeoutSeconds" value="300"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                    `;
                    break;
                case 'NetworkShare':
                    html = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">UNC Path *</label>
                            <input type="text" id="config-BasePath" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="\\\\server\\share or \\\\192.168.1.100\\share">
                            <p class="text-xs text-gray-500 mt-1">Network share UNC path</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sub Folder</label>
                            <input type="text" id="config-SubFolder"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="exports/data">
                            <p class="text-xs text-gray-500 mt-1">Optional subfolder within the share (can be relative path)</p>
                        </div>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="config-UseRelativePath"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="config-UseRelativePath" class="ml-2 block text-sm text-gray-700">
                                Sub Folder is Relative Path
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="config-Username"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="config-Password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Domain</label>
                            <input type="text" id="config-Domain"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="WORKGROUP or DOMAIN">
                            <p class="text-xs text-gray-500 mt-1">Optional Windows domain (leave blank for local authentication)</p>
                        </div>
                    `;
                    break;
            }
            
            configFields.innerHTML = html;
            
            // If HTTP type, also update auth fields
            if (type === 'Http') {
                updateHttpAuthFields();
            }
        }

        function updateHttpAuthFields() {
            const authType = document.getElementById('config-authType')?.value;
            const authFields = document.getElementById('http-auth-fields');

            if (!authFields) return;

            let html = '';

            switch(authType) {
                case 'bearer':
                case 'token':
                    html = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Token</label>
                            <input type="password" id="config-authToken"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                   placeholder="your-token-here"
                                   data-secret-field="true">
                            <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
                        </div>
                    `;
                    break;
                case 'basic':
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="config-username"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="config-password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing</p>
                            </div>
                        </div>
                    `;
                    break;
                case 'apikey':
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key Header Name</label>
                                <input type="text" id="config-apiKeyHeader" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       placeholder="X-API-Key">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                                <input type="password" id="config-authToken"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                       data-secret-field="true">
                                <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing</p>
                            </div>
                        </div>
                    `;
                    break;
            }

            authFields.innerHTML = html;
        }

        function openAddDestinationModal() {
            // Clear secret field tracking for new destinations
            originalSecretValues.clear();

            document.getElementById('add-destination-modal').classList.remove('hidden');
            document.getElementById('destination-modal-title').textContent = 'Add New Destination';
            document.getElementById('destination-more-options').classList.add('hidden');
            document.getElementById('add-destination-form').reset();
            document.getElementById('add-destination-form').removeAttribute('data-edit-id');
            document.getElementById('add-destination-form').removeAttribute('data-is-active');
            document.getElementById('destination-options-menu').classList.add('hidden');
            updateConfigFields();
            queueLucideRender();
        }

        function closeAddDestinationModal() {
            document.getElementById('add-destination-modal').classList.add('hidden');
            document.getElementById('destination-options-menu').classList.add('hidden');
            // Clear the secret field tracking so next edit starts fresh
            originalSecretValues.clear();
        }

        function toggleDestinationOptionsMenu() {
            const menu = document.getElementById('destination-options-menu');
            menu.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('destination-options-menu');
            const button = event.target.closest('[onclick="toggleDestinationOptionsMenu()"]');
            if (!button && !menu?.contains(event.target)) {
                menu?.classList.add('hidden');
            }
        });

        async function toggleDestinationActiveStatus() {
            const form = document.getElementById('add-destination-form');
            const destinationId = form.getAttribute('data-edit-id');
            const isActive = form.getAttribute('data-is-active') === 'true';
            const destinationName = document.getElementById('destination-name').value;
            
            const action = isActive ? 'deactivate' : 'activate';
            const confirmMessage = isActive 
                ? `Are you sure you want to deactivate "${destinationName}"?\n\nNote: Any profiles, jobs, and webhooks using this destination will fail to execute until you reactivate it.`
                : `Are you sure you want to activate "${destinationName}"?`;
            
            if (!confirm(confirmMessage)) {
                document.getElementById('destination-options-menu').classList.add('hidden');
                return;
            }

            try {
                // Get current destination data
                const response = await fetch(`${API_BASE}/${destinationId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    showToast('Failed to load destination details', 'error');
                    console.error('Failed to fetch destination:', response.statusText);
                    return;
                }
                
                const destination = await response.json();
                
                // Update the isActive status
                destination.isActive = !isActive;
                
                // Send PUT request with updated destination
                const updateResponse = await fetch(`${API_BASE}/${destinationId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(destination)
                });
                
                if (updateResponse.ok) {
                    showToast(`Destination ${action}d successfully`, 'success');
                    closeAddDestinationModal();
                    await loadDestinations();
                } else {
                    showToast(`Failed to ${action} destination`, 'error');
                }
            } catch (error) {
                showToast(`Error ${action}ing destination: ${error.message}`, 'error');
            }
            
            document.getElementById('destination-options-menu').classList.add('hidden');
        }

        // Store original values for secret fields to detect changes
        const originalSecretValues = new Map();

        function trackSecretField(fieldId, value) {
            originalSecretValues.set(fieldId, value);
        }

        function isSecretFieldModified(fieldId, currentValue) {
            const original = originalSecretValues.get(fieldId);
            return original !== currentValue;
        }

        function getConfigurationJson() {
            const config = {};
            const configInputs = document.querySelectorAll('#config-fields input, #config-fields textarea, #config-fields select');
            const authInputs = document.querySelectorAll('#http-auth-fields input, #http-auth-fields select');

            // Helper function to check if an element is visible
            function isElementVisible(element) {
                // Check if element or any parent is hidden with the 'hidden' class
                let current = element;
                while (current) {
                    if (current.classList && current.classList.contains('hidden')) {
                        return false;
                    }
                    current = current.parentElement;
                }
                return true;
            }

            // Process main config fields
            configInputs.forEach(input => {
                // Skip hidden fields - they shouldn't override existing values
                if (!isElementVisible(input)) {
                    return;
                }

                let key = input.id.replace('config-', '');
                // Capitalize first letter for consistency with C# model
                key = key.charAt(0).toUpperCase() + key.slice(1);

                if (input.type === 'checkbox') {
                    config[key] = input.checked;
                } else if (input.type === 'number') {
                    config[key] = parseInt(input.value) || 0;
                } else {
                    // Check if this is a secret field
                    const isSecret = input.hasAttribute('data-secret-field');

                    if (input.value !== "") {
                        // Field has a value
                        if (isSecret && !isSecretFieldModified(input.id, input.value)) {
                            // Field hasn't changed, keep the masked value
                            config[key] = '[SECRET]';
                        }
                        // Special handling for Headers field (should be parsed as JSON)
                        else if (key === 'Headers' && input.value) {
                            try {
                                config[key] = JSON.parse(input.value);
                            } catch (e) {
                                console.warn('Failed to parse headers JSON, storing as string', e);
                                config[key] = input.value;
                            }
                        }
                        // Normalize path fields to remove trailing slashes or backslashes
                        else if (key.toLowerCase().includes('path')) {
                            config[key] = input.value.replace(/[\\/]+$/, '');
                        } else {
                            config[key] = input.value;
                        }
                    } else if (isSecret && !isSecretFieldModified(input.id, input.value)) {
                        // Empty secret field that hasn't been modified - preserve as [SECRET]
                        config[key] = '[SECRET]';
                    }
                }
            });

            // Process auth fields (for HTTP destination)
            authInputs.forEach(input => {
                // Skip hidden fields - they shouldn't override existing values
                if (!isElementVisible(input)) {
                    return;
                }

                let key = input.id.replace('config-', '');
                key = key.charAt(0).toUpperCase() + key.slice(1);

                // Check if this is a secret field
                const isSecret = input.hasAttribute('data-secret-field');

                if (input.value !== "") {
                    // Field has a value
                    if (isSecret && !isSecretFieldModified(input.id, input.value)) {
                        // Field hasn't changed, keep the masked value
                        config[key] = '[SECRET]';
                    } else {
                        config[key] = input.value;
                    }
                } else if (isSecret && !isSecretFieldModified(input.id, input.value)) {
                    // Empty secret field that hasn't been modified - preserve as [SECRET]
                    config[key] = '[SECRET]';
                }
            });

            return JSON.stringify(config);
        }

        async function testDestination() {
            const btn = document.getElementById('test-destination-btn');
            const spinner = document.getElementById('test-destination-spinner');
            const btnText = document.getElementById('test-destination-btn-text');
            const type = document.getElementById('destination-type').value;
            if (!type) {
                showToast('Please select a destination type', 'error');
                return;
            }

            const configJson = getConfigurationJson();

            if (btn && spinner && btnText) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                btnText.textContent = 'Testing...';
            }

            try {
                const response = await fetch(`${API_BASE}/test`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        type: type,
                        configurationJson: configJson
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Connection test successful!', 'success');
                } else {
                    showToast(`Connection test failed: ${result.message || 'Unknown error'}` , 'error');
                }
            } catch (error) {
                showToast(`Test error: ${error.message}`, 'error');
            } finally {
                if (btn && spinner && btnText) {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Test Connection';
                }
            }
        }
        
        // Initialize filter for destinations
        let destinationFilter = null;

        function checkAuth() {
            return requireAuth();
        }

        async function loadDestinations() {
            await checkAuth();
            setUserSidebarInfo();

            const destinationsList = document.getElementById('destinations-list');
            try {
                const response = await fetch(API_BASE, {
                    headers: getAuthHeaders()
                });

                let destinations = [];
                if (response.ok) {
                    destinations = await response.json();
                }

                // Initialize filter if not already done
                if (!destinationFilter) {
                    destinationFilter = new ReefFilter({ pageKey: 'reef_filter_destinations' });
                    window.reefFilter = destinationFilter;

                    // Listen for filter changes
                    window.addEventListener('filterChange', () => {
                        renderFilteredDestinations();
                    });
                }

                // Set items and render filter bar
                destinationFilter.setItems(destinations);
                renderFilterBar(destinationFilter, { containerId: 'filter-container' });
                renderFilteredDestinations();

            } catch (error) {
                destinationsList.innerHTML = `<p class="text-sm text-red-600">Failed to load destinations.</p>`;
                console.error('Failed to load destinations:', error);
            }
        }

        function renderFilteredDestinations() {
            const destinationsList = document.getElementById('destinations-list');
            const filtered = destinationFilter.filteredItems;

            if (!filtered || filtered.length === 0) {
                destinationsList.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i data-lucide="send" class="h-12 w-12 text-gray-300 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-700 mb-2">No destinations found</p>
                        <p class="text-gray-500 mb-4">${destinationFilter.allItems.length === 0 ? 'Create your first destination to get started.' : 'Try adjusting your filters.'}</p>
                    </div>
                `;
            } else {
                destinationsList.innerHTML = filtered.map(dest => {
                    // Choose icon based on destination type
                    let icon = 'cloud';
                    switch(dest.type) {
                        case 'Local': icon = 'hard-drive'; break;
                        case 'Ftp': icon = 'upload-cloud'; break;
                        case 'Sftp': icon = 'shield'; break;
                        case 'S3': icon = 'database'; break;
                        case 'AzureBlob': icon = 'cloud'; break;
                        case 'Email': icon = 'mail'; break;
                        case 'Http': icon = 'globe'; break;
                        case 'NetworkShare': icon = 'network'; break;
                    }

                    return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center space-x-4">
                            <i data-lucide="${icon}" class="h-8 w-8 text-blue-500"></i>
                            <div>
                                <p class="font-medium text-gray-900">${escapeHtml(dest.name)}</p>
                                <p class="text-sm text-gray-500 disable-select">${escapeHtml(dest.type)}${dest.description ? ` • ${escapeHtml(dest.description)}` : ''}</p>
                                ${dest.tags ? `<div class="mt-2 flex flex-wrap gap-1">
                                    ${dest.tags.split(',').map(tag => `
                                        <span class="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded cursor-pointer hover:bg-blue-200 transition" data-tag-filter="${escapeHtml(tag.trim())}">
                                            ${escapeHtml(tag.trim())}
                                        </span>
                                    `).join('')}
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs ${dest.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-500'} rounded">${dest.isActive ? 'Active' : 'Inactive'}</span>
                            <button class="p-2 text-gray-400 hover:text-gray-600" onclick="editDestination(${dest.id})" data-tooltip="Edit">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button class="p-2 text-gray-400 hover:text-red-600" onclick="deleteDestination(${dest.id}, '${escapeHtml(dest.name)}')" data-tooltip="Delete">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');

                // Setup tag click handlers
                destinationFilter.setupTagClickHandlers('[data-tag-filter]');
            }
            queueLucideRender();
        }

        async function editDestination(id) {
            try {
                // Clear previous tracking
                originalSecretValues.clear();

                const response = await fetch(`${API_BASE}/${id}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const dest = await response.json();

                    document.getElementById('destination-name').value = dest.name;
                    document.getElementById('destination-type').value = dest.type;
                    document.getElementById('destination-description').value = dest.description || '';
                    document.getElementById('destination-tags').value = dest.tags || '';

                    updateConfigFields();

                    // Populate config fields
                    if (dest.configurationJson) {
                        const config = JSON.parse(dest.configurationJson);

                        // For Email destinations, detect and select the provider
                        if (dest.type === 'Email') {
                            let provider = 'Smtp'; // Default
                            // First check if EmailProvider is explicitly set
                            if (config.EmailProvider) {
                                provider = config.EmailProvider;
                            }
                            // Fall back to detecting by API key presence (for backward compatibility)
                            else if (config.ResendApiKey) {
                                provider = 'Resend';
                            } else if (config.SendGridApiKey) {
                                provider = 'SendGrid';
                            }
                            const providerSelect = document.getElementById('config-emailProvider');
                            if (providerSelect) {
                                providerSelect.value = provider;
                                // Trigger the provider field update
                                updateEmailProviderFields();
                            }
                        }

                        Object.keys(config).forEach(key => {
                            // Convert key from PascalCase to camelCase for field ID lookup
                            const fieldKey = key.charAt(0).toLowerCase() + key.slice(1);
                            const field = document.getElementById(`config-${fieldKey}`);
                            if (field) {
                                const value = config[key];
                                const isEncrypted = value === '[SECRET]';

                                if (field.type === 'checkbox') {
                                    field.checked = config[key];
                                } else if (key === 'Headers' && typeof config[key] === 'object') {
                                    // Special handling for Headers - convert object back to JSON string
                                    field.value = JSON.stringify(config[key], null, 2);
                                } else {
                                    // For encrypted fields, show placeholder and track original value
                                    if (isEncrypted && field.hasAttribute('data-secret-field')) {
                                        field.value = '';
                                        field.placeholder = 'Leave blank to keep existing value';
                                        trackSecretField(field.id, '');  // Empty = unchanged
                                    } else {
                                        field.value = value;
                                        if (field.hasAttribute('data-secret-field')) {
                                            trackSecretField(field.id, value);
                                        }
                                    }
                                }
                            }
                        });

                        // If HTTP destination, also populate auth fields
                        if (dest.type === 'Http' && config.AuthType) {
                            updateHttpAuthFields();
                            // Re-populate auth fields after they're created
                            setTimeout(() => {
                                Object.keys(config).forEach(key => {
                                    const fieldKey = key.charAt(0).toLowerCase() + key.slice(1);
                                    const field = document.getElementById(`config-${fieldKey}`);
                                    if (field && !document.querySelector(`#config-fields #config-${fieldKey}`)) {
                                        // This is an auth field
                                        const value = config[key];
                                        const isEncrypted = value === '[SECRET]';

                                        if (field.type === 'checkbox') {
                                            field.checked = config[key];
                                        } else {
                                            if (isEncrypted && field.hasAttribute('data-secret-field')) {
                                                field.value = '';
                                                field.placeholder = 'Leave blank to keep existing value';
                                                trackSecretField(field.id, '');  // Empty = unchanged
                                            } else {
                                                field.value = value;
                                                if (field.hasAttribute('data-secret-field')) {
                                                    trackSecretField(field.id, value);
                                                }
                                            }
                                        }
                                    }
                                });
                            }, 50);
                        }
                    }

                    const form = document.getElementById('add-destination-form');
                    form.setAttribute('data-edit-id', id);
                    form.setAttribute('data-is-active', dest.isActive);

                    // Update modal title and show more options menu
                    document.getElementById('destination-modal-title').textContent = 'Edit Destination';
                    document.getElementById('destination-more-options').classList.remove('hidden');

                    // Update toggle button text
                    const toggleText = document.getElementById('destination-toggle-text');
                    toggleText.textContent = dest.isActive ? 'Disable' : 'Enable';

                    document.getElementById('add-destination-modal').classList.remove('hidden');
                    queueLucideRender();
                }
            } catch (error) {
                showToast('Failed to load destination', 'error');
                console.error('Failed to fetch destination:', error);
            }
        }

        async function deleteDestination(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showToast('Destination deleted successfully', 'success');
                    loadDestinations();
                } else {
                    const error = await response.json();
                    showToast(`Error: ${error.message || 'Failed to delete destination'}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        document.getElementById('add-destination-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await checkAuth();

            const form = document.getElementById('add-destination-form');
            const isEdit = form.hasAttribute('data-edit-id');
            const editId = isEdit ? form.getAttribute('data-edit-id') : null;
            const destinationName = document.getElementById('destination-name').value;
            const destinationType = document.getElementById('destination-type').value;

            // Validate required fields for S3 when creating new destination
            if (!isEdit && destinationType === 'S3') {
                const accessKey = document.getElementById('config-accessKey').value.trim();
                const secretKey = document.getElementById('config-secretKey').value.trim();

                if (!accessKey) {
                    showToast('Access Key is required for new S3 destinations', 'error');
                    return;
                }
                if (!secretKey) {
                    showToast('Secret Key is required for new S3 destinations', 'error');
                    return;
                }
            }

            // Preserve isActive status when editing, default to true when creating
            const isActive = isEdit ? (form.getAttribute('data-is-active') === 'true') : true;

            const destination = {
                name: destinationName,
                description: document.getElementById('destination-description').value,
                type: destinationType,
                configurationJson: getConfigurationJson(),
                tags: document.getElementById('destination-tags').value,
                isActive: isActive
            };

            try {
                // Check for duplicate name (except when editing the same destination)
                if (!isEdit) {
                    const existingDestinations = await fetch(API_BASE, {
                        headers: getAuthHeaders()
                    });

                    if (existingDestinations.ok) {
                        const destinations = await existingDestinations.json();
                        const duplicate = destinations.find(d => d.name.toLowerCase() === destinationName.toLowerCase());

                        if (duplicate) {
                            showToast(`Destination with name "${destinationName}" already exists. Please use a different name.`, 'warning');
                            return;
                        }
                    }
                }

                let url = API_BASE;
                let method = 'POST';
                if (isEdit && editId) {
                    url = `${API_BASE}/${editId}`;
                    method = 'PUT';
                    destination.id = parseInt(editId);
                }

                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(destination)
                });

                if (response.ok) {
                    closeAddDestinationModal();
                    await loadDestinations();
                    showToast(isEdit ? 'Destination updated successfully' : 'Destination created successfully', 'success');
                } else {
                    const error = await response.json();
                    showToast(`Error: ${error.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let userMenuExpanded = false;

        // Toggle user menu
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            const chevron = document.getElementById('chevron-icon');
            userMenuExpanded = !userMenuExpanded;
            
            if (userMenuExpanded) {
                menu.classList.remove('user-menu-collapsed');
                menu.classList.add('user-menu-expanded');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                menu.classList.remove('user-menu-expanded');
                menu.classList.add('user-menu-collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
            
            // Re-render icons after DOM update
            setTimeout(() => queueLucideRender(), 50);
        }

        function toggleFtpAdvanced(event) {
            event.preventDefault();
            const panel = document.getElementById('ftpAdvanced');
            const chevron = document.getElementById('ftpAdvancedChevron');

            if (panel && chevron) {
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    panel.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
                setTimeout(() => queueLucideRender(), 10);
            }
        }

        function toggleSftpAdvanced(event) {
            event.preventDefault();
            const panel = document.getElementById('sftpAdvanced');
            const chevron = document.getElementById('sftpAdvancedChevron');

            if (panel && chevron) {
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    panel.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
                setTimeout(() => queueLucideRender(), 10);
            }
        }

        function updateSftpAuthFields() {
            const authType = document.getElementById('sftp-auth-type')?.value;
            const passwordAuth = document.getElementById('sftp-password-auth');
            const privatekeyAuth = document.getElementById('sftp-privatekey-auth');

            if (authType === 'privatekey') {
                passwordAuth?.classList.add('hidden');
                privatekeyAuth?.classList.remove('hidden');
            } else {
                passwordAuth?.classList.remove('hidden');
                privatekeyAuth?.classList.add('hidden');
            }
        }

        function toggleS3Advanced(event) {
            event.preventDefault();
            const panel = document.getElementById('s3Advanced');
            const chevron = document.getElementById('s3AdvancedChevron');

            if (panel && chevron) {
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    panel.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
                setTimeout(() => queueLucideRender(), 10);
            }
        }

        function toggleEmailSmtpAdvanced(event) {
            event.preventDefault();
            const panel = document.getElementById('emailSmtpAdvanced');
            const chevron = document.getElementById('emailSmtpAdvancedChevron');

            if (panel && chevron) {
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    panel.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
                setTimeout(() => queueLucideRender(), 10);
            }
        }

        function updateEmailProviderFields() {
            const provider = document.getElementById('config-emailProvider')?.value;
            const smtpFields = document.getElementById('emailSmtpFields');
            const resendFields = document.getElementById('emailResendFields');
            const sendGridFields = document.getElementById('emailSendGridFields');
            const commonFields = document.getElementById('emailCommonFields');

            // Hide all provider fields initially
            if (smtpFields) smtpFields.classList.add('hidden');
            if (resendFields) resendFields.classList.add('hidden');
            if (sendGridFields) sendGridFields.classList.add('hidden');
            if (commonFields) commonFields.classList.add('hidden');

            // Show selected provider fields
            switch(provider) {
                case 'Smtp':
                    if (smtpFields) smtpFields.classList.remove('hidden');
                    if (commonFields) commonFields.classList.remove('hidden');
                    break;
                case 'Resend':
                    if (resendFields) resendFields.classList.remove('hidden');
                    if (commonFields) commonFields.classList.remove('hidden');
                    break;
                case 'SendGrid':
                    if (sendGridFields) sendGridFields.classList.remove('hidden');
                    if (commonFields) commonFields.classList.remove('hidden');
                    break;
            }

            // Re-render Lucide icons
            setTimeout(() => queueLucideRender(), 10);
        }

        function toggleEmailAuthFields() {
            const authType = document.getElementById('config-authType')?.value || 'Basic';
            const basicAuth = document.getElementById('emailBasicAuth');
            const oauth2Auth = document.getElementById('emailOAuth2Auth');

            if (basicAuth && oauth2Auth) {
                if (authType === 'OAuth2') {
                    basicAuth.classList.add('hidden');
                    oauth2Auth.classList.remove('hidden');
                } else if (authType === 'None') {
                    basicAuth.classList.add('hidden');
                    oauth2Auth.classList.add('hidden');
                } else {
                    // Basic or default
                    basicAuth.classList.remove('hidden');
                    oauth2Auth.classList.add('hidden');
                }
            }
        }

        function logout() {
            clearAuth();
            redirectToLogin();
        }

        function initializeDestinations() {
            if (typeof ReefFilter !== 'undefined') {
                loadDestinations();
            } else {
                setTimeout(initializeDestinations, 50);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await requireAuth();
            queueLucideRender();
            initializeDestinations();
        });
    </script>
</body>
</html>