<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profiles &middot; Reef</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/assets/js/_tailwind.3.4.17.js"></script>
    <script src="/assets/js/_lucide.0.552.0.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/filter.js"></script>
    <script src="/assets/js/main.js"></script>
</head>
<body class="bg-slate-50">
    <script>
        requireAuth();
    </script>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:flex md:flex-col md:w-60 bg-slate-800 text-slate-300">
            <div class="flex items-center justify-left px-6 h-16 border-b border-slate-700">
                <i data-lucide="waves" class="h-6 w-6 stroke-blue-400/80"></i> 
                
                <div class="flex items-center ml-3 select-none mt-0.5">
                    <span class="text-slate-100 text-lg font-semibold font-inter tracking-tight">
                    Reef
                    </span>
                    <span class="ml-3 px-3 py-1 rounded border border-slate-700 text-slate-400 text-[10px] uppercase tracking-wide leading-none">
                    beta
                    </span>
                </div>
            </div>
            
            <nav class="flex-1 px-4 py-4">
                <a href="/dashboard" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Management</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/connections" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="plug" class="h-5 w-5"></i>
                            <span class="ml-3">Connections</span>
                        </a>
                        <a href="/destinations" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="send" class="h-5 w-5"></i>
                            <span class="ml-3">Destinations</span>
                        </a>
                        <a href="/templates" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="file-text" class="h-5 w-5"></i>
                            <span class="ml-3">Templates</span>
                        </a>
                        <a href="/groups" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="folder" class="h-5 w-5"></i>
                            <span class="ml-3">Groups</span>
                        </a>
                        <a href="/profiles" class="flex items-center px-4 py-3 rounded-lg bg-slate-900 text-slate-100">
                            <i data-lucide="file-code" class="h-5 w-5"></i>
                            <span class="ml-3">Profiles</span>
                        </a>
                    </div>
                </div>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Automation</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/jobs" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="briefcase" class="h-5 w-5"></i>
                            <span class="ml-3">Jobs</span>
                        </a>
                        <a href="/executions" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="activity" class="h-5 w-5"></i>
                            <span class="ml-3">Executions</span>
                        </a>
                        <a href="/email-approvals" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="check-square" class="h-5 w-5"></i>
                            <span class="ml-3">Approvals</span>
                        </a>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Reference</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/documentation" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="book-open" class="h-5 w-5"></i>
                            <span class="ml-3">Documentation</span>
                        </a>
                    </div>
                </div>
            </nav>
            <!-- User Section with Expandable Menu -->
            <div class="border-t border-gray-700">
                <button onclick="toggleUserMenu()" class="w-full flex items-center justify-between p-4 hover:bg-gray-800 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <span id="user-initial" class="text-white font-bold text-lg">&nbsp;</span>
                        </div>
                        <div class="text-left">
                            <div id="username-display" class="text-white font-semibold">&nbsp;</div>
                            <div class="text-xs text-gray-400">View menu</div>
                        </div>
                    </div>
                    <i id="chevron-icon" data-lucide="chevron-up" class="h-4 w-4 text-gray-400 transition-transform"></i>
                </button>
                
                <!-- Expandable Menu -->
                <div id="user-menu" class="overflow-hidden user-menu-collapsed">
                    <div class="px-2 pb-2 space-y-1">
                        <a href="/admin" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="settings" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Settings</span>
                        </a>
                        <a href="https://github.com/melosso/reef" target="_blank" rel="noopener noreferrer" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="github" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">GitHub</span>
                            <i data-lucide="external-link" class="h-3 w-3 ml-auto"></i>
                        </a>
                        <button onclick="logout()" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="log-out" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm z-10">
                <div class="flex items-center justify-between px-6 py-3">
                    <h1 class="text-2xl font-semibold text-gray-900 disable-select">Profiles</h1>
                    <div class="flex space-x-3 items-center">
                        <div class="relative">
                            <button id="newProfileButton" onclick="toggleNewProfileMenu()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                                <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                                New Profile
                                <i data-lucide="chevron-down" class="h-4 w-4 ml-2"></i>
                            </button>
                            <div id="newProfileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-50 border border-gray-200">
                                <button onclick="openAddProfileModal('standard')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-900 flex items-center">
                                    <i data-lucide="file-code" class="h-4 w-4 mr-2"></i>
                                    Export Profile
                                </button>
                                <button onclick="openAddProfileModal('email')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-900 flex items-center">
                                    <i data-lucide="mail" class="h-4 w-4 mr-2"></i>
                                    Export Email
                                </button>
                                <button disabled class="w-full text-left px-4 py-2 text-gray-400 flex items-center cursor-not-allowed opacity-50">
                                    <i data-lucide="upload" class="h-4 w-4 mr-2"></i>
                                    Import Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div id="message-container"></div>

                <!-- Filters Bar -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 h-4 w-4 text-gray-400"></i>
                            <input type="text"
                                   id="search-input"
                                   placeholder="Search by name, connection, group, or format..."
                                   onkeyup="applyFilters()"
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-semibold text-gray-700">Filters</h2>
                        <button onclick="clearAllFilters()" class="text-sm text-blue-600 hover:text-blue-700 font-medium" id="clear-filters-btn" style="display:none;">
                            Clear All
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="filter-status" onchange="applyFilters()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Show All</option>
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="filter-connection" class="block text-sm font-medium text-gray-700 mb-1">Connection</label>
                            <select id="filter-connection" onchange="applyFilters()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Show All</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="filter-group" class="block text-sm font-medium text-gray-700 mb-1">Group</label>
                            <select id="filter-group" onchange="applyFilters()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Show All</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th onclick="sortProfiles('name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Name</span>
                                        <i id="sort-icon-name" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('connection')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Connection</span>
                                        <i id="sort-icon-connection" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('group')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Group</span>
                                        <i id="sort-icon-group" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('format')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Format</span>
                                        <i id="sort-icon-format" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('destination')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Destination</span>
                                        <i id="sort-icon-destination" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('status')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Status</span>
                                        <i id="sort-icon-status" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th onclick="sortProfiles('lastrun')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none">
                                    <div class="flex items-center">
                                        <span>Last Run</span>
                                        <i id="sort-icon-lastrun" data-lucide="chevrons-up-down" class="h-4 w-4 ml-1"></i>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="profiles-tbody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                    <i data-lucide="loader" class="h-5 w-5 inline animate-spin"></i>
                                    Loading profiles...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white mb-20">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Add Profile</h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-500">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="generalTabButton" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600"
                            onclick="showTab('general')">
                        <i data-lucide="settings" class="w-4 h-4 inline mr-1"></i>
                        General
                    </button>
                    <button id="webhooksTabButton" class="webhook-tab px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300"
                            onclick="showTab('webhooks')">
                        <i data-lucide="link" class="w-4 h-4 inline mr-1"></i>
                        Webhooks
                    </button>
                    <button id="deltaSyncTabButton" class="deltasync-tab px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300"
                            onclick="showTab('deltaSync')">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                        Smart Sync
                    </button>
                    <button id="splitOutputTabButton" class="split-tab px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300"
                            onclick="showTab('splitOutput')">
                        <i data-lucide="scissors" class="w-4 h-4 inline mr-1"></i>
                        Split Output
                    </button>
                    <button id="emailOptionsTabButton" class="email-options-tab px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300"
                            onclick="showTab('emailOptions')" style="display:none;">
                        <i data-lucide="mail" class="w-4 h-4 inline mr-1"></i>
                        Attachments
                    </button>
                </nav>
            </div>
            <div id="generalTab" class="tab-content">
                <form id="profile-form" class="space-y-4">
                    <input type="hidden" id="profile-id">
                    <input type="checkbox" id="isEmailExport" name="isEmailExport" style="display: none;">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Name *</label>
                            <input type="text" id="profile-name" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label for="profile-connection" class="block text-sm font-medium text-gray-700">Connection *</label>
                            <select id="profile-connection" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Connection...</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="profile-group" class="block text-sm font-medium text-gray-700">Group (Optional)</label>
                        <select id="profile-group"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">No Group</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="profile-query" class="block text-sm font-medium text-gray-700">SQL Query *</label>
                        <textarea id="profile-query" rows="4" required
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                  placeholder="SELECT * FROM Table WHERE ..."></textarea>
                    </div>
                    
                    <!-- Scheduling Notice -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4" id="scheduling-notice" style="display:none;">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="info" class="h-5 w-5 text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Need to schedule this profile?</h3>
                                <p class="mt-1 text-sm text-blue-700">
After saving this profile, head to the <a href="/jobs" class="font-semibold underline hover:text-blue-900">Jobs</a> page to set up a scheduled task with options such as retries, dependencies, and more. You can also enable Webhooks to trigger this profile directly, skipping the need for scheduling entirely.                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Format & Custom Template Section (File Export Only) -->
                    <div id="fileExportFields" class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="output-format" class="block text-sm font-medium text-gray-700">
                                Output Format *
                            </label>
                            <select id="output-format"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="JSON">JSON</option>
                                <option value="XML">XML</option>
                                <option value="CSV">CSV</option>
                                <option value="YAML">YAML</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Standard formatting (no customization)</p>
                        </div>

                        <div>
                            <label for="template-id" class="block text-sm font-medium text-gray-700">
                                Custom Template (Optional)
                                <span class="text-blue-600 text-xs">- Overrides format</span>
                            </label>
                            <select id="template-id" onchange="updateTemplateInfo()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">None - Use Output Format above</option>
                                <!-- Templates will be loaded dynamically -->
                            </select>
                            <p id="template-info" class="mt-1 text-xs text-gray-500">No template selected</p>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Output Destination *</h4>
                        
                        <div class="mb-4">
                            <label for="destination-id" class="block text-sm font-medium text-gray-700 mb-1">
                                Select Destination *
                            </label>
                            <select id="destination-id" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Select a destination --</option>
                                <!-- Will be populated dynamically -->
                            </select>
                            <p class="mt-1 text-xs text-gray-500">
                                <a href="/destinations" class="text-blue-600 hover:underline">→ Manage Destinations</a>
                            </p>
                        </div>

                        <div id="nonEmailFields">
                            <div id="nonSplitFields">
                                <!-- Filename Template -->
                                <div>
                                    <label for="filenameTemplate" class="block text-sm font-medium text-gray-700 mb-1">
                                        Filename Template (Optional)
                                    </label>
                                    <input type="text" id="filenameTemplate"
                                           value="{profile}_{timestamp}.{format}"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono text-sm">
                                    <p class="mt-1 text-xs text-gray-500">
                                        Available placeholders:
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{profile}</code>,
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{timestamp}</code>,
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{date}</code>,
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{time}</code>,
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{guid}</code>,
                                        <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{format}</code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Configuration Section (Email Export Only) -->
                    <div id="emailConfigSection" class="hidden border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="mail" class="w-4 h-4 mr-2 text-blue-600"></i>
                            Email Configuration
                        </h4>

                        <div class="mb-4">
                            <label for="emailTemplateId" class="block text-sm font-medium text-gray-700 mb-1">
                                Email Body Template (Scriban HTML) *
                            </label>
                            <select id="emailTemplateId"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Select HTML email template --</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">
                                Only Scriban templates with HTML output format are available. <a href="/templates" class="text-blue-600 hover:underline">→ Create a new email template</a>
                            </p>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700 flex items-center">
                                    Recipients *
                                    <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column with the recipient's email. You can use either the plain address (email@example.com) or a name followed by the address (Name;email@example.com). It supports aliases as well." data-tooltip-position="top">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="info" class="lucide lucide-info w-4 h-4"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                    </span>
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-gray-600">Column</span>
                                    <label class="relative inline-block w-12 h-6 bg-gray-300 rounded-full cursor-pointer transition" id="recipientsToggle" style="background-color: #d1d5db;">
                                        <input type="checkbox" class="hidden" id="useHardcodedRecipients">
                                        <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition"></span>
                                    </label>
                                    <span class="text-xs font-medium text-gray-600" id="recipientsMode">Hardcoded</span>
                                </div>
                            </div>
                            <input type="text" id="emailRecipientsColumn"
                                   placeholder="e.g., email"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <input type="email" id="emailRecipientsHardcoded"
                                   placeholder="e.g., recipient@example.com"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                   style="display: none;">
                            <p class="mt-1 text-xs text-gray-500" id="recipientsHelp">
                                Column name from query that contains recipient email address (supports "Name;email@address.com" format)
                            </p>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700 flex items-center">
                                    CC Column (Optional)
                                    <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column with the CC email. You can use either the plain address (email@example.com) or a name followed by the address (Name;email@example.com). It supports aliases as well." data-tooltip-position="top">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="info" class="lucide lucide-info w-4 h-4"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                    </span>
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-gray-600">Column</span>
                                    <label class="relative inline-block w-12 h-6 bg-gray-300 rounded-full cursor-pointer transition" id="ccToggle" style="background-color: #d1d5db;">
                                        <input type="checkbox" class="hidden" id="useHardcodedCc">
                                        <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition"></span>
                                    </label>
                                    <span class="text-xs font-medium text-gray-600" id="ccMode">Hardcoded</span>
                                </div>
                            </div>
                            <input type="text" id="emailCcColumn"
                                   placeholder="e.g., email_cc"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <input type="email" id="emailCcHardcoded"
                                   placeholder="e.g., cc@example.com"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                   style="display: none;">
                            <p class="mt-1 text-xs text-gray-500" id="ccHelp">
                                Column name from query that contains CC email address (supports "Name;email@address.com" format, optional)
                            </p>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700 flex items-center">
                                    Subject (Optional)
                                    <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column with the email subject. If not provided, will use profile name." data-tooltip-position="top">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="info" class="lucide lucide-info w-4 h-4"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                    </span>
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-gray-600">Column</span>
                                    <label class="relative inline-block w-12 h-6 bg-gray-300 rounded-full cursor-pointer transition" id="subjectToggle" style="background-color: #d1d5db;">
                                        <input type="checkbox" class="hidden" id="useHardcodedSubject">
                                        <span class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition"></span>
                                    </label>
                                    <span class="text-xs font-medium text-gray-600" id="subjectMode">Hardcoded</span>
                                </div>
                            </div>
                            <input type="text" id="emailSubjectColumn"
                                   placeholder="e.g., subject"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="emailSubjectHardcoded"
                                   placeholder="e.g., Daily Report"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                   style="display: none;">
                            <div class="mt-1">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-500" id="subjectHelp">
                                        Column name from query that contains email subject. If not provided, will use profile name.
                                    </p>
                                    <button type="button" id="subjectVariablesToggle" class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 transition-colors" style="display: none;">
                                        <span>Variables</span>
                                        <i data-lucide="chevron-down" class="h-3 w-3 transition-transform duration-200"></i>
                                    </button>
                                </div>
                                <div id="subjectVariablesPanel" class="mt-2 p-3 bg-blue-50 rounded-md border border-blue-200 hidden">
                                    <p class="text-xs font-medium text-blue-900 mb-2">Available variables:</p>
                                    <ul class="text-xs text-blue-800 space-y-1 ml-2">
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ columnName }}</code> - Any column from your query</li>
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ system.profileId }}</code> - Profile number</li>
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ system.profileName }}</code> - Profile name</li>
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ system.date }}</code> - Current date (yyyy-MM-dd)</li>
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ system.time }}</code> - Current time (HH:mm:ss)</li>
                                        <li><code class="bg-blue-100 px-2 py-1 rounded">{{ system.datetime }}</code> - Date and time (yyyy-MM-dd HH:mm:ss)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="emailSuccessThresholdPercent" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Success Threshold %
                                <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Mark as succeeded if this % or more of emails send successfully. Prevents retries when some emails fail. Default: 60%" data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </label>
                            <input type="number" id="emailSuccessThresholdPercent" min="0" max="100" value="60"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">
                                Set to less than 100 to prevent retries when some recipients fail (e.g., 90 for 90% success)
                            </p>
                        </div>
                    </div>

                    <!-- Email Approval Workflow Section (Email Export Only) -->
                    <div id="emailApprovalSection" class="hidden border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="check-square" class="w-4 h-4 mr-2 text-amber-600"></i>
                            Requires Approval (Optional)
                            <span class="ml-2 text-xs font-normal text-gray-500">Emails held for approval before sending</span>
                        </h4>

                        <!-- Enable/Disable Toggle -->
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg mb-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="shield-check" class="w-5 h-5 text-gray-400"></i>
                                <div>
                                    <label for="emailApprovalRequired" class="text-sm font-medium text-gray-900">Require Manual Approval</label>
                                    <p class="text-xs text-gray-500">Emails held in queue until approved by authorized user</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="emailApprovalRequired" class="sr-only peer" onchange="toggleEmailApprovalConfig()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div id="emailApprovalConfigSection" class="hidden space-y-3 opacity-50 pointer-events-none">
                            <div>
                                <label for="emailApprovalRoles" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                    Roles Allowed to Approve
                                    <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Select which user roles are allowed to approve emails for this profile. Leave empty to allow all roles." data-tooltip-position="top">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                    </span>
                                </label>
                                <div id="emailApprovalRolesCheckboxes" class="space-y-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Admin" data-role-checkbox class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700 disable-select">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="User" data-role-checkbox class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700 disable-select">User</span>
                                    </label>
                                </div>
                                <p class="mt-2 text-xs text-gray-500">
                                    Leave all unchecked to allow all users to approve
                                </p>
                            </div>

                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                                <p class="text-xs text-blue-700">
                                    <strong>Workflow:</strong> Emails will be held in "Pending" status until approved by an authorized user. A background service will send approved emails within 30 seconds.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Pre-Processing Section -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="play" class="w-4 h-4 mr-2 text-green-600"></i>
                            Pre-Processing (Optional)
                            <span class="ml-2 text-xs font-normal text-gray-500">Execute before main query</span>
                        </h4>
                        
                        <div class="mb-3">
                            <label for="preprocess-type" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Pre-Process Type
                                <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Query: Use for SQL statements (SELECT, UPDATE, INSERT, DELETE, etc.)\nStored Procedure: Use for calling existing database procedures by name" data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </label>
                            <select id="preprocess-type" onchange="togglePreProcessConfig()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">None</option>
                                <option value="Query">Query (SQL statements)</option>
                                <option value="StoredProcedure">Stored Procedure (procedure name only)</option>
                            </select>
                        </div>
                        
                        <div id="preprocess-config-section" class="hidden space-y-3">
                            <div>
                                <label for="preprocess-command" class="block text-sm font-medium text-gray-700">
                                    Command *
                                </label>
                                <textarea id="preprocess-command" rows="2"
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                          placeholder="For Query: UPDATE Items SET Status='Processing' WHERE Id={executionid}&#10;For Stored Procedure: sp_PrepareData"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="preprocess-timeout" class="block text-sm font-medium text-gray-700">
                                        Timeout (seconds)
                                    </label>
                                    <input type="number" id="preprocess-timeout" value="30" min="1"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="flex items-center pt-6">
                                    <input type="checkbox" id="preprocess-rollback-on-failure" checked
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="preprocess-rollback-on-failure" class="ml-2 block text-sm text-gray-900">
                                        Rollback on main query failure
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                                <p class="text-xs text-yellow-700">
                                    <strong>Tip:</strong> Use context variables like {executionid}, {profileid}, {triggeredby} in your command or parameters.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Post-Processing Section -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="check-circle" class="w-4 h-4 mr-2 text-blue-600"></i>
                            Post-Processing (Optional)
                            <span class="ml-2 text-xs font-normal text-gray-500">Execute after main query</span>
                        </h4>
                        
                        <div class="mb-3">
                            <label for="postprocess-type" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Post-Process Type
                                <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Query: Use for SQL statements (SELECT, UPDATE, INSERT, DELETE, etc.)&#10;Stored Procedure: Use for calling existing database procedures by name" data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </label>
                            <select id="postprocess-type" onchange="togglePostProcessConfig()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">None</option>
                                <option value="Query">Query (SQL statements)</option>
                                <option value="StoredProcedure">Stored Procedure (procedure name only)</option>
                            </select>
                        </div>
                        
                        <div id="postprocess-config-section" class="hidden space-y-3">
                            <div>
                                <label for="postprocess-command" class="block text-sm font-medium text-gray-700">
                                    Command *
                                </label>
                                <textarea id="postprocess-command" rows="2"
                                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                          placeholder="For Query: UPDATE log SET status='complete', rows={rowcount} WHERE execution_id={executionid}&#10;For Stored Procedure: sp_LogExport"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="postprocess-timeout" class="block text-sm font-medium text-gray-700">
                                        Timeout (seconds)
                                    </label>
                                    <input type="number" id="postprocess-timeout" value="30" min="1"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <div class="flex items-center pt-6">
                                    <input type="checkbox" id="postprocess-skip-on-failure" checked
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="postprocess-skip-on-failure" class="ml-2 block text-sm text-gray-900">
                                        Skip if main query fails
                                    </label>
                                </div>
                            </div>

                            <div class="flex items-center">
                                <input type="checkbox" id="postprocess-on-zero-rows"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="postprocess-on-zero-rows" class="ml-2 block text-sm text-gray-900">
                                    Run post-processing even when query returns 0 rows
                                </label>
                                <span class="ml-2 text-gray-400 cursor-help" data-tooltip="Enable this to run post-processing even when the main query returns no results or when delta sync detects no changes. Useful for logging or tracking executions." data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </div>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                                <p class="text-xs text-blue-700">
                                    <strong>Available variables:</strong> {executionid}, {profileid}, {rowcount}, {outputpath}, {filesizebytes}, {executiontimems}, {outputformat}, {triggeredby}, {startedat}, {completedat}, {status}, {deltasynccolumn}, {splitkey}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="is-enabled" checked
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="is-enabled" class="ml-2 block text-sm text-gray-900">
                                Profile Enabled
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 italic">
                            (Profile can be tested and triggered manually even when disabled)
                        </p>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-4">
                        <div class="relative inline-block text-left">
                            <button type="button" id="test-actions-btn" onclick="toggleTestActionsMenu()"
                                    class="px-4 py-2.5 border border-blue-300 bg-blue-50 rounded-md text-sm font-medium text-blue-700 hover:bg-blue-100 flex items-center"
                                    title="Test Profile">
                                <i data-lucide="play" class="h-4 w-4 mr-1"></i>
                                <i data-lucide="chevron-down" class="h-4 w-4"></i>
                            </button>
                            <div id="test-actions-menu" class="hidden absolute left-0 bottom-full mb-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                                <div class="py-1" role="menu">
                                    <button type="button" onclick="testQueryInModal(); closeTestActionsMenu();"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                            title="Show first 25 rows from database">
                                        <svg id="test-query-spinner" class="animate-spin h-4 w-4 mr-2 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                                        </svg>
                                        <i data-lucide="database" class="h-4 w-4 mr-2"></i>
                                        <span id="test-query-btn-text">Run Query</span>
                                    </button>
                                    <button type="button" onclick="testProfileInModal(); closeTestActionsMenu();"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                            title="Run full export with template and destination">
                                        <svg id="test-profile-spinner" class="animate-spin h-4 w-4 mr-2 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                                        </svg>
                                        <i data-lucide="play-circle" class="h-4 w-4 mr-2"></i>
                                        <span id="test-profile-btn-text">Run Profile (Test)</span>
                                    </button>
                                    <div id="preview-email-menu-item" class="hidden">
                                        <button type="button" onclick="previewEmailHtml(); closeTestActionsMenu();"
                                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                                title="Preview email HTML output">
                                            <svg id="preview-email-spinner" class="animate-spin h-4 w-4 mr-2 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                                            </svg>
                                            <i data-lucide="eye" class="h-4 w-4 mr-2"></i>
                                            <span id="preview-email-btn-text">Preview HTML</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="closeProfileModal()"
                                class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 flex items-center">
                            <i data-lucide="save" class="h-4 w-4 mr-2"></i>
                            Save Profile
                        </button>
                    </div>
                </form>
            </div>
            <div id="webhooksTab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    Webhooks allow you to trigger profile execution via HTTP POST requests from external systems.
                                    Each webhook has a unique token that must be included in the URL.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="webhooksList" class="space-y-3">
                        </div>

                    <button id="createWebhookBtn" class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:border-gray-400 hover:bg-gray-50">
                        <i data-lucide="plus-circle" class="w-4 h-4 inline mr-2"></i>
                        Create Webhook
                    </button>
                </div>
            </div>
            <div id="deltaSyncTab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    When this option is turned on, the profile only exports rows that have been added, updated, or removed since the last export. We call this Smart Sync.

                                    To make this work, your query needs to include a unique ID column (called <code class="px-1 py-0.5 bg-blue-100 text-blue-900 rounded text-xs">ReefId</code>) so Reef can tell which rows have changed.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Enable/Disable Toggle -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="toggle-left" id="deltaSyncToggleIcon" class="w-5 h-5 text-gray-400"></i>
                            <div>
                                <label for="deltaSyncEnabled" class="text-sm font-medium text-gray-900">Enable Smart Sync</label>
                                <p class="text-xs text-gray-500">Track and export only changes between executions</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="deltaSyncEnabled" class="sr-only peer" onchange="toggleDeltaSyncFields()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div id="deltaSyncFields" class="space-y-4 opacity-50 pointer-events-none">
                        <!-- Primary Key Configuration -->
                        <div>
                            <label for="deltaSyncReefIdColumn" class="block text-sm font-medium text-gray-700 mb-1">
                                Primary Key Column (ReefId) *
                            </label>
                            <input type="text" id="deltaSyncReefIdColumn" placeholder="e.g., UserId, OrderId, RecordId"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">Column name from your query that uniquely identifies each row</p>
                        </div>

                        <!-- Advanced Settings Accordion -->
                        <div class="border border-gray-200 rounded-lg">
                            <button type="button" onclick="toggleDeltaSyncAdvanced()" 
                                    class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
                                    <span class="text-sm font-medium text-gray-700">Advanced Settings</span>
                                </div>
                                <i data-lucide="chevron-down" id="deltaSyncAdvancedChevron" class="w-4 h-4 text-gray-400 transition-transform"></i>
                            </button>
                            <div id="deltaSyncAdvanced" class="hidden px-4 pb-4 space-y-4 border-t border-gray-200">
                                <!-- Hash Algorithm -->
                                <div class="grid grid-cols-2 gap-4 pt-4">
                                    <div>
                                        <label for="deltaSyncHashAlgorithm" class="block text-sm font-medium text-gray-700 mb-1">
                                            Hash Algorithm
                                        </label>
                                        <select id="deltaSyncHashAlgorithm"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                            <option value="SHA256" selected>SHA256 (Recommended)</option>
                                            <option value="SHA512">SHA512 (More secure)</option>
                                            <option value="MD5">MD5 (Fastest)</option>
                                        </select>
                                        <p class="mt-1 text-xs text-gray-500">Cryptographic hash function for change detection</p>
                                    </div>

                                    <div>
                                        <label for="deltaSyncNumericPrecision" class="block text-sm font-medium text-gray-700 mb-1">
                                            Numeric Precision
                                        </label>
                                        <input type="number" id="deltaSyncNumericPrecision" min="0" max="15" value="6"
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <p class="mt-1 text-xs text-gray-500">Decimal places for floating-point comparison (0-15)</p>
                                    </div>
                                </div>

                                <!-- Duplicate Handling Strategy -->
                                <div>
                                    <label for="deltaSyncDuplicateStrategy" class="block text-sm font-medium text-gray-700 mb-1">
                                        Duplicate ReefId Strategy
                                    </label>
                                    <select id="deltaSyncDuplicateStrategy"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="Strict" selected>Strict - Fail execution if duplicates found</option>
                                        <option value="CompositeHash">Composite Hash - Use combined hash for duplicates</option>
                                        <option value="Skip">Skip - Ignore duplicate rows</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500">How to handle duplicate ReefId values in query results</p>
                                </div>

                                <!-- NULL Handling Strategy -->
                                <div>
                                    <label for="deltaSyncNullStrategy" class="block text-sm font-medium text-gray-700 mb-1">
                                        NULL ReefId Strategy
                                    </label>
                                    <select id="deltaSyncNullStrategy"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        <option value="Strict" selected>Strict - Fail execution if NULL ReefIds found</option>
                                        <option value="GenerateHash">Generate Hash - Create synthetic hash for NULL rows</option>
                                        <option value="Skip">Skip - Ignore rows with NULL ReefIds</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500">How to handle NULL values in ReefId column</p>
                                </div>

                                <!-- Track Deletes Option -->
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-gray-600"></i>
                                        <div>
                                            <label for="deltaSyncTrackDeletes" class="text-sm font-medium text-gray-900">Track Deletions</label>
                                            <p class="text-xs text-gray-500">Export rows that disappeared from query results</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="deltaSyncTrackDeletes" checked class="sr-only peer">
                                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>

                                <!-- Advanced Output Options -->
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i data-lucide="eye-off" class="w-5 h-5 text-gray-400"></i>
                                        <div>
                                            <label for="excludeReefIdFromOutput" class="text-sm font-medium text-gray-900">Exclude ReefId from Exported Data</label>
                                            <p class="text-xs text-gray-500">ReefId column is used for tracking but not included in output files</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="excludeReefIdFromOutput" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                                
                                <p class="text-xs text-gray-500 italic flex items-start">
                                    <i data-lucide="info" class="w-3 h-3 mr-1 mt-0.5 text-blue-500 flex-shrink-0"></i>
                                    <span>
                                        When enabled (recommended), the ReefId column is used internally for change detection 
                                        but won't appear in your exported files. Uncheck if you want the ReefId column included in the output.
                                    </span>
                                </p>
                            </div>
                        </div>

                        <!-- Statistics Panel (Edit Mode Only) -->
                        <div id="deltaSyncStats" class="hidden border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i>
                                    Smart Sync Statistics
                                </h4>
                                <button type="button" onclick="refreshDeltaSyncStats()" 
                                        class="text-xs text-blue-600 hover:text-blue-800 flex items-center">
                                    <i data-lucide="refresh-cw" class="w-3 h-3 mr-1"></i>
                                    Refresh
                                </button>
                            </div>
                            <div class="grid grid-cols-4 gap-3">
                                <div class="text-center">
                                    <div id="statTotalRows" class="text-2xl font-bold text-gray-900">-</div>
                                    <div class="text-xs text-gray-500">Total Tracked</div>
                                </div>
                                <div class="text-center">
                                    <div id="statLastSync" class="text-2xl font-bold text-blue-600">-</div>
                                    <div class="text-xs text-gray-500">Last Sync</div>
                                </div>
                                <div class="text-center">
                                    <div id="statNewRows" class="text-2xl font-bold text-green-600">-</div>
                                    <div class="text-xs text-gray-500">New (Last Run)</div>
                                </div>
                                <div class="text-center">
                                    <div id="statChangedRows" class="text-2xl font-bold text-orange-600">-</div>
                                    <div class="text-xs text-gray-500">Changed (Last Run)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings (Edit Mode Only) -->
                        <div id="deltaSyncAdvancedPanel" class="hidden border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="">
                                <button type="button" onclick="toggleDeltaSyncAdvancedSettings()"
                                        class="flex items-center w-full text-sm font-semibold text-gray-900 hover:text-gray-700">
                                    <i data-lucide="database" class="w-4 h-4 mr-2"></i>
                                    Memory Store
                                    <i data-lucide="chevron-down" class="w-4 h-4 ml-auto transform transition-transform" id="advancedSettingsChevron"></i>
                                </button>
                            </div>

                            <div id="deltaSyncAdvancedContent" class="hidden space-y-4 pt-4 border-t border-gray-200">
                                <!-- Generate Hashes Section -->
                                <div class="flex items-start p-3 mt-4 bg-blue-50 border border-blue-200 rounded">
                                    <i data-lucide="hash" class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0"></i>
                                    <div class="flex-1">
                                        <h4 class="text-sm font-semibold text-blue-900 mb-1">Initialize Hash Baseline</h4>
                                        <p class="text-xs text-blue-700 mb-3">
                                            Executes your query and generates hashes for all rows without marking them as changes. This establishes the baseline so only new/updated data is synced next time.
                                        </p>
                                        <button type="button" onclick="generateDeltaSyncHashes()"
                                                class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-white border border-blue-300 rounded hover:bg-blue-100">
                                            <i data-lucide="hash" class="w-3 h-3 inline mr-1"></i>
                                            Generate Hashes from Query
                                        </button>
                                    </div>
                                </div>

                                <!-- Reset Options Section -->
                                <div class="flex items-start p-3 bg-red-50 border border-red-200 rounded">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 mt-0.5 mr-3 flex-shrink-0"></i>
                                    <div class="flex-1">
                                        <h4 class="text-sm font-semibold text-red-800 mb-1">Reset Smart Sync State</h4>
                                        <p class="text-xs text-red-700 mb-3">
                                            Resetting will clear tracking history. The next execution will treat all rows as new.
                                        </p>
                                        <div class="flex space-x-2">
                                            <button type="button" onclick="resetDeltaSyncFull()"
                                                    class="px-3 py-1.5 text-xs font-medium text-red-700 bg-white border border-red-300 rounded hover:bg-red-100">
                                                <i data-lucide="rotate-ccw" class="w-3 h-3 inline mr-1"></i>
                                                Reset All Rows
                                            </button>
                                            <button type="button" onclick="showResetRowsModal()"
                                                    class="px-3 py-1.5 text-xs font-medium text-red-700 bg-white border border-red-300 rounded hover:bg-red-100">
                                                <i data-lucide="list" class="w-3 h-3 inline mr-1"></i>
                                                Reset Specific Rows
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Split Output Tab -->
            <div id="splitOutputTab" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <strong>Multi-Output Splitting</strong> allows you to generate multiple output files from a single query execution.
                                    Each file contains rows grouped by a specific column value (e.g., one XML file per customer).
                                </p>
                                <p class="text-xs text-blue-600 mt-2">
                                    <strong>Example:</strong> Query returns 100 customers → Split by CustomerId → Creates 100 separate files
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Enable/Disable Toggle -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="scissors" class="w-5 h-5 text-gray-400"></i>
                            <div>
                                <label for="splitEnabled" class="text-sm font-medium text-gray-900">Enable Multi-Output Splitting</label>
                                <p class="text-xs text-gray-500">Generate separate files grouped by a column value</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="splitEnabled" class="sr-only peer" onchange="toggleSplitFields()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div id="splitFields" class="space-y-4 opacity-50 pointer-events-none">
                        <!-- Email Grouping (for Email Export profiles only) -->
                        <div id="emailGroupingOption" class="hidden">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="mail" class="w-5 h-5 text-gray-400"></i>
                                    <div>
                                        <label for="emailGroupBySplitKey" class="text-sm font-medium text-gray-900">Group rows by split key</label>
                                        <p class="text-xs text-gray-500">Send one email per split key value (e.g., one email per approver)</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="emailGroupBySplitKey" class="sr-only peer" onchange="updateWorkflowHint()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <!-- Workflow hint when enabled -->
                            <div id="emailGroupingHint" class="hidden mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-xs text-blue-800">
                                    <i data-lucide="lightbulb" class="w-3 h-3 inline mr-1"></i>
                                    <strong>Pro tip:</strong> For workflows requiring multiple documents per email (e.g., invoice approvals), enable <strong>"Generate one document per row"</strong> in <strong>Email Options → Attachments → DocumentTemplate</strong> below to create separate PDFs for each row.
                                </p>
                            </div>
                        </div>

                        <!-- Post-process per split -->
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="check-circle" class="w-5 h-5 text-gray-400"></i>
                                <div>
                                    <label for="postProcessPerSplit" class="text-sm font-medium text-gray-900">Post-process per split</label>
                                    <p class="text-xs text-gray-500">Run post-processing for each split</p>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="postProcessPerSplit" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Split Key Column -->
                        <div>
                            <label for="splitKeyColumn" class="block text-sm font-medium text-gray-700 mb-1">
                                Split Key Column *
                            </label>
                            <input type="text" id="splitKeyColumn" placeholder="e.g., CustomerId, DebtorCode, Region"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">Column name to group rows by (one file per unique value)</p>
                        </div>

                        <!-- Filename Template -->
                        <div>
                            <label for="splitFilenameTemplate" class="block text-sm font-medium text-gray-700 mb-1">
                                Filename Template
                            </label>
                            <input type="text" id="splitFilenameTemplate" 
                                   value="{profile}_{splitkey}_{timestamp}.{format}"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-mono text-sm">
                            <p class="mt-1 text-xs text-gray-500">
                                Available placeholders: 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{profile}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{splitkey}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{timestamp}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{date}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{time}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{guid}</code>, 
                                <code class="text-xs bg-gray-100 px-1 py-0.5 rounded">{format}</code>
                            </p>
                        </div>

                        <!-- Batch Size (File Export Only) -->
                        <div id="fileExportSplitFields">
                            <div>
                                <label for="splitBatchSize" class="block text-sm font-medium text-gray-700 mb-1">
                                    Batch Size (Advanced)
                                </label>
                                <input type="number" id="splitBatchSize" value="1" min="1" max="10000"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">
                                    Number of rows per file (default: 1 = one file per split key, 100 = batch 100 rows per file)
                                </p>
                            </div>

                            <!-- Advanced Output Options for Split Key -->
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="eye-off" class="w-5 h-5 text-blue-400"></i>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h4 class="text-sm font-medium text-blue-800 mb-2">Advanced Output Options</h4>
                                        <p class="text-xs text-blue-700 mb-3">
                                            Control whether the Split Key column appears in your exported files
                                        </p>
                                        <div class="flex items-center justify-between p-3 bg-white rounded border border-blue-200">
                                            <div class="flex items-center space-x-3">
                                                <div>
                                                    <label for="excludeSplitKeyFromOutput" class="text-sm font-medium text-gray-900">Exclude Split Key from Exported Data</label>
                                                    <p class="text-xs text-gray-500">Split Key column is used for grouping but not included in output files</p>
                                                </div>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="excludeSplitKeyFromOutput" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                        <p class="text-xs text-blue-600 mt-2">
                                            <strong>When enabled (recommended):</strong> The Split Key column is used internally for grouping/filename generation but won't appear in your exported files. Uncheck if you want the Split Key column included in the output.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="help-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white mb-20" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
                        <div id="help-modal-content-area">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="help-modal-title" class="text-xl font-bold text-gray-900 flex items-center">
                                    <i data-lucide="lightbulb" class="h-6 w-6 mr-2 text-yellow-500"></i>
                                    How to use Profiles
                                </h3>
                                <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-500 p-1" aria-label="Close help guide">
                                    <i data-lucide="x" class="h-6 w-6"></i>
                                </button>
                            </div>
                            <div class="space-y-4 text-gray-700">
                                <p>Profiles define what data to retrieve from your databases. Configure your query and output format here. To schedule automatic execution, save your profile first, then go to Jobs to create a scheduled task.</p>
                                
                                <h4 class="text-l font-semibold text-gray-800"><b>Profile Workflow:</b></h4>
                                <ol class="list-decimal list-inside space-y-2 ml-4">
                                    <li><b>Create Profile:</b> Click <b>"New Profile"</b> and configure your query, connection, output format, and destination.</li>
                                    <li><b>Test Profile:</b> Use the <i data-lucide="play-circle" class="h-4 w-4 inline text-green-600"></i> Test button to verify your query works correctly.</li>
                                    <li><b>Schedule Execution:</b> Go to the <a href="/jobs" class="text-blue-600 hover:underline font-semibold">Jobs</a> page to create a scheduled task that runs this profile automatically.</li>
                                </ol>
                                
                                <p>
                                    Choose your database connection, select output format (JSON, CSV, XML, YAML, or custom), pick a destination (local, cloud, FTP/SFTP, APIs), optionally set up webhooks for manual triggers, and organize profiles into folders.
                                </p>
                                
                                <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mt-4">
                                    <p class="text-sm text-blue-800">
                                        <strong>💡 Tip:</strong> Profiles are input configurations. For <em>scheduling</em> (WHEN to run), use the <a href="/jobs" class="text-blue-600 hover:underline font-semibold">Jobs</a> page.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Options Tab -->
            <div id="emailOptionsTab" class="tab-content hidden">
                <div class="space-y-4">
                    <!-- Attachment Configuration Section -->
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="paperclip" class="w-5 h-5 text-gray-400"></i>
                            <div>
                                <label for="attachmentsEnabled" class="text-sm font-medium text-gray-900">Enable Email Attachments</label>
                                <p class="text-xs text-gray-500">Query must return binary file content and filename columns</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="attachmentsEnabled" class="sr-only peer" onchange="toggleAttachmentConfig()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div id="attachmentConfig" class="hidden space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3">
                            <div>
                                <p class="text-xs text-blue-700 font-semibold mb-2">
                                    <strong>Required Query Columns:</strong>
                                </p>
                                <div class="bg-white rounded border border-blue-200 p-3 space-y-2">
                                    <div class="text-xs text-blue-800">
                                        <div class="flex items-start">
                                            <span class="inline-block bg-blue-100 text-blue-700 rounded px-2 py-1 mr-2 font-mono text-xs">1</span>
                                            <div>
                                                <strong>Binary Content Column</strong>
                                                <div class="text-gray-600 text-xs">BLOB/VARBINARY data type containing file content</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-blue-800">
                                        <div class="flex items-start">
                                            <span class="inline-block bg-blue-100 text-blue-700 rounded px-2 py-1 mr-2 font-mono text-xs">2</span>
                                            <div>
                                                <strong>Filename Column</strong>
                                                <div class="text-gray-600 text-xs">Field that returns the filename as text (e.g., "report.pdf", "invoice_2024.xlsx")</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-700 border-t border-blue-200 pt-2">
                                <strong>Example:</strong> SELECT email, pdf_content, filename FROM invoices
                            </p>
                        </div>

                        <div>
                            <label for="attachmentContentColumn" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                File Content Column *
                                <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column containing binary file data (BLOB/VARBINARY type)" data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </label>
                            <input type="text" id="attachmentContentColumn" placeholder="e.g., pdf_content, file_data"
                                   onchange="saveAttachmentConfig()"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">
                                Name of the column with binary file content from your query
                            </p>
                        </div>

                        <div>
                            <label for="attachmentFilenameColumn" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                Filename Column *
                                <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column containing the filename for the attachment" data-tooltip-position="top">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </span>
                            </label>
                            <input type="text" id="attachmentFilenameColumn" placeholder="e.g., filename, report_name"
                                   onchange="saveAttachmentConfig()"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">
                                Name of the column that returns the filename (e.g., "report.pdf", "invoice_2024.xlsx")
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="attachmentDeduplication" class="block text-sm font-medium text-gray-700 mb-1">
                                    Deduplication
                                </label>
                                <select id="attachmentDeduplication" onchange="saveAttachmentConfig()"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Auto">Auto (detect duplicates)</option>
                                    <option value="ByFilename">By Filename</option>
                                    <option value="ByHash">By Content Hash</option>
                                    <option value="None">None (include all)</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">
                                    Prevent duplicate attachments across rows
                                </p>
                            </div>

                            <div>
                                <label for="attachmentFailsafe" class="block text-sm font-medium text-gray-700 mb-1">
                                    Failsafe
                                </label>
                                <select id="attachmentFailsafe" onchange="saveAttachmentConfig()"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Disabled">Disabled</option>
                                    <option value="RequireAttachments">Fail if no attachments generated</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">
                                    Prevent emails from being sent if attachment generation fails
                                </p>
                            </div>

                            <div>
                                <label for="attachmentMaxCount" class="block text-sm font-medium text-gray-700 mb-1">
                                    Max Attachments per Email
                                </label>
                                <input type="number" id="attachmentMaxCount" value="50" min="1" max="100"
                                       onchange="saveAttachmentConfig()"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">
                                    Default: 50
                                </p>
                            </div>
                        </div>

                        <div id="attachmentGroupingInfo" class="bg-gray-50 border border-gray-200 rounded p-3">
                            <p class="text-xs text-gray-700">
                                <strong>Attachment Grouping:</strong> <span id="groupingExplanation">Each email will have its own attachment from the query result.</span>
                            </p>
                        </div>

                        <!-- Document Template Attachment Option -->
                        <div class="border-t border-gray-200 pt-4">
                            <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <i data-lucide="file-text" class="w-4 h-4 mr-2 text-purple-600"></i>
                                Generate Attachments from Document Template (Alternative)
                            </h5>
                            <p class="text-xs text-gray-500 mb-3">
                                Instead of using binary content columns, you can generate PDF/DOCX attachments dynamically from query data using a Document Template.
                            </p>

                            <div>
                                <label for="emailAttachmentDocumentTemplateId" class="block text-sm font-medium text-gray-700 mb-1">
                                    Document Template (Optional)
                                </label>
                                <select id="emailAttachmentDocumentTemplateId" onchange="updateEmailAttachmentTemplateInfo(); saveAttachmentConfig();"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">None - Use binary content columns above</option>
                                    <!-- Will be populated with DocumentTemplate types only -->
                                </select>
                                <p id="emailAttachmentTemplateInfo" class="mt-1 text-xs text-gray-500">No document template selected</p>
                            </div>

                            <!-- Filename Column for Document Template Attachments -->
                            <div id="emailAttachmentFilenameField" class="hidden mt-4">
                                <label for="emailAttachmentFilenameColumn" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                                    Filename Column *
                                    <span class="ml-1 text-gray-400 cursor-help" data-tooltip="Column containing the filename for the generated attachment (e.g., 'invoice.pdf')" data-tooltip-position="top">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                    </span>
                                </label>
                                <input type="text" id="emailAttachmentFilenameColumn" placeholder="e.g., filename, report_name"
                                       onchange="saveAttachmentConfig()"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">
                                    Query must return this column with the desired filename (include extension: .pdf or .docx)
                                </p>
                                
                                <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mt-3">
                                    <p class="text-xs text-blue-700">
                                        <strong>How it works:</strong> Your query data will be passed to the document template, which generates a PDF/DOCX file dynamically. This file is then attached to the email.
                                    </p>
                                </div>

                                <!-- Generate Per Row Checkbox -->
                                <div class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="emailAttachmentGeneratePerRow" onchange="saveAttachmentConfig()"
                                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm font-semibold text-gray-900">Generate one document per row</span>
                                        <span class="ml-1 text-gray-400 cursor-help" data-tooltip="When enabled, creates a separate PDF/DOCX for each row (e.g., one invoice PDF per row). When disabled, creates one document with all rows (e.g., one picklist with all items)." data-tooltip-position="top">
                                            <i data-lucide="info" class="w-4 h-4"></i>
                                        </span>
                                    </label>
                                    <p class="ml-6 mt-2 text-xs text-gray-600">
                                        <strong>When to use:</strong> Generate separate documents for each data row instead of one combined document.<br>
                                        <strong>Example:</strong> Send invoice approvals with multiple PDFs (one per invoice) rather than one PDF containing all invoices.<br>
                                        <strong>Tip:</strong> Combine with "Group rows by split key" to control email distribution (e.g., one email per approver with their specific documents).
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button type="button" onclick="validateAttachmentConfig()"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                            <i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>
                            Validate Configuration
                        </button>

                        <div id="validationResult" class="hidden space-y-2"></div>
                    </div>

                    <input type="hidden" id="emailAttachmentConfig" name="emailAttachmentConfig" value="">
                </div>
            </div>
        </div>
    </div>

    <!-- Email HTML Preview Modal -->
    <div id="email-preview-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-4xl mx-auto my-8">
            <div class="bg-white rounded-lg shadow-xl">
                <!-- Header -->
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                    <h2 class="text-lg font-semibold text-gray-900">Preview</h2>
                    <button onclick="closeEmailPreviewModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-6 py-4 max-h-100 overflow-y-auto bg-gray-50 border-b border-gray-200">
                    <div id="preview-html-content" class="bg-white border border-gray-300 rounded-md p-4">
                        <p class="text-gray-500 text-sm">Loading preview...</p>
                    </div>
                </div>

                <!-- Info -->
                <div class="px-6 py-3 bg-blue-50 border-b border-blue-200">
                    <p class="text-xs text-blue-700 pb-0 mb-0">
                        <strong>Note:</strong> This preview uses the first row from your query. Make sure your query returns at least one row.
                    </p>
                </div>

                <!-- Footer -->
                <div class="flex justify-end space-x-3 px-6 py-4">
                    <button type="button" onclick="closeEmailPreviewModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                    <button type="button" id="download-preview-btn" onclick="downloadEmailPreview()"
                            class="px-4 py-2 border border-blue-300 bg-blue-50 rounded-md text-blue-700 hover:bg-blue-100 flex items-center font-medium">
                        <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                        Download HTML
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Results Preview Modal -->
    <div id="query-results-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-6xl mx-auto my-8">
            <div class="bg-white rounded-lg shadow-xl">
                <!-- Header -->
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Query Results Preview</h2>
                        <p class="text-sm text-gray-500 mt-1">
                            Showing <span id="query-results-count">0</span> rows
                            <span id="query-results-time" class="text-gray-400"></span>
                            <span id="query-results-delta-summary" class="hidden ml-2 space-x-2"></span>
                        </p>
                    </div>
                    <button onclick="closeQueryResultsModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-6 py-4 max-h-96 overflow-auto bg-gray-50 border-b border-gray-200">
                    <div id="query-results-content">
                        <div class="flex items-center justify-center py-8">
                            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                            <span class="ml-3 text-gray-600">Executing query...</span>
                        </div>
                    </div>
                </div>

                <!-- Info -->
                <div class="px-6 py-3 bg-green-50 border-b border-green-200">
                    <p class="text-xs text-green-700 pb-0 mb-0">
                        <strong>Note:</strong> This preview shows the first 25 rows from your query.
                        The full profile execution will run the complete query.
                    </p>
                </div>

                <!-- Delta sync legend (shown only when delta mode is active) -->
                <div id="query-results-delta-legend" class="hidden px-6 py-2 bg-gray-50 border-b border-gray-200 flex items-center gap-4 text-xs text-gray-600">
                    <span class="font-medium text-gray-700">Smart Sync status:</span>
                    <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-green-500"></span> New record</span>
                    <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-amber-400"></span> Changed since last run</span>
                    <span class="flex items-center gap-1"><span class="inline-block w-2 h-2 rounded-full bg-gray-300"></span> Unchanged</span>
                </div>

                <!-- Footer -->
                <div class="flex justify-end space-x-3 px-6 py-4">
                    <button type="button" onclick="closeQueryResultsModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Execution Confirmation Modal -->
    <div id="email-execute-confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-md mx-auto my-20">
            <div class="bg-white rounded-lg shadow-xl">
                <!-- Header -->
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4 disable-select">
                    <h2 class="text-lg font-semibold text-gray-900">Are you sure?</h2>
                    <button onclick="closeEmailExecutionConfirmationModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-6 py-4">
                    <div class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-md">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-500 mr-3 mt-1"></i>
                            <div>
                                <p class="text-sm font-semibold text-yellow-900 mb-1">
                                    Warning
                                </p>
                                <p class="text-sm text-yellow-800">
                                    This action will send emails to the recipients defined in your profile. Proceed with caution.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Verify by answering the question:
                        </label>
                        <p id="math-question" class="text-base text-gray-900 font-semibold mb-3">
                            Loading question...
                        </p>
                        <input type="text" id="math-answer-input"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter your answer"
                               autocomplete="off">
                        <p id="math-error" class="text-xs text-red-600 mt-1 hidden"></p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                    <button type="button" onclick="closeEmailExecutionConfirmationModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" id="confirm-execute-btn" onclick="confirmEmailExecution()"
                            class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700">
                        Execute
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        queueLucideRender();
    </script>
    <script>
        const API_BASE = window.location.origin;
        let token = localStorage.getItem('reef_token');
        let profiles = [];
        let filteredProfiles = [];
        let connections = [];
        let groups = [];
        let destinations = [];
        let templates = [];

        // Sorting state
        let currentSortColumn = localStorage.getItem('profiles_sortColumn') || 'name';
        let currentSortDirection = localStorage.getItem('profiles_sortDirection') || 'asc';

        function sortProfiles(column) {
            // Add toggle parameter to control direction toggling
            let toggle = true;
            if (typeof arguments[1] === 'boolean') toggle = arguments[1];
            // Toggle direction if clicking the same column, otherwise default to asc
            if (currentSortColumn === column) {
                if (toggle) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                }
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Save sort preferences
            localStorage.setItem('profiles_sortColumn', currentSortColumn);
            localStorage.setItem('profiles_sortDirection', currentSortDirection);

            // Update sort icons
            ['name', 'connection', 'group', 'format', 'destination', 'status', 'lastrun'].forEach(col => {
                const icon = document.getElementById(`sort-icon-${col}`);
                if (icon) {
                    if (col === column) {
                        icon.setAttribute('data-lucide', currentSortDirection === 'asc' ? 'chevron-up' : 'chevron-down');
                    } else {
                        icon.setAttribute('data-lucide', 'chevrons-up-down');
                    }
                }
            });
            queueLucideRender();

            // Sort the filtered profiles
            filteredProfiles.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'name':
                        aVal = (a.name || '').toLowerCase();
                        bVal = (b.name || '').toLowerCase();
                        break;
                    case 'connection':
                        aVal = (a.connectionName || '').toLowerCase();
                        bVal = (b.connectionName || '').toLowerCase();
                        break;
                    case 'group':
                        aVal = (a.groupName || '').toLowerCase();
                        bVal = (b.groupName || '').toLowerCase();
                        break;
                    case 'format':
                        // Use template's format if available, otherwise use outputFormat
                        const aTemplate = a.templateId ? templates.find(t => t.id === a.templateId) : null;
                        const bTemplate = b.templateId ? templates.find(t => t.id === b.templateId) : null;
                        aVal = (aTemplate?.outputFormat || a.outputFormat || '').toLowerCase();
                        bVal = (bTemplate?.outputFormat || b.outputFormat || '').toLowerCase();
                        break;
                    case 'destination':
                        const aDest = destinations.find(d => d.id === a.outputDestinationId);
                        const bDest = destinations.find(d => d.id === b.outputDestinationId);
                        aVal = aDest ? `${aDest.name} (${aDest.type})`.toLowerCase() : '';
                        bVal = bDest ? `${bDest.name} (${bDest.type})`.toLowerCase() : '';
                        break;
                    case 'status':
                        aVal = a.isEnabled ? 1 : 0;
                        bVal = b.isEnabled ? 1 : 0;
                        break;
                    case 'lastrun':
                        // Sort by lastExecutedAt, treating null/undefined as oldest (epoch time 0)
                        aVal = a.lastExecutedAt ? new Date(a.lastExecutedAt).getTime() : 0;
                        bVal = b.lastExecutedAt ? new Date(b.lastExecutedAt).getTime() : 0;
                        break;
                    default:
                        return 0;
                }

                let comparison = 0;
                if (aVal < bVal) comparison = -1;
                if (aVal > bVal) comparison = 1;

                // Secondary sort by name if not already sorting by name
                if (comparison === 0 && column !== 'name') {
                    const aName = (a.name || '').toLowerCase();
                    const bName = (b.name || '').toLowerCase();
                    if (aName < bName) comparison = -1;
                    if (aName > bName) comparison = 1;
                }

                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            renderProfiles();
        }

        function togglePreProcessConfig() {
            const type = document.getElementById('preprocess-type').value;
            const section = document.getElementById('preprocess-config-section');
            if (type) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function togglePostProcessConfig() {
            const type = document.getElementById('postprocess-type').value;
            const section = document.getElementById('postprocess-config-section');
            if (type) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function toggleEmailApprovalConfig() {
            const checkbox = document.getElementById('emailApprovalRequired');
            const section = document.getElementById('emailApprovalConfigSection');
            if (checkbox.checked) {
                section.classList.remove('hidden', 'opacity-50', 'pointer-events-none');
            } else {
                section.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function updateEmailAttachmentTemplateInfo() {
            const templateSelect = document.getElementById('emailAttachmentDocumentTemplateId');
            const infoElement = document.getElementById('emailAttachmentTemplateInfo');
            const filenameField = document.getElementById('emailAttachmentFilenameField');
            const selectedOption = templateSelect.options[templateSelect.selectedIndex];

            if (templateSelect.value) {
                const format = selectedOption.dataset.outputFormat || 'Unknown';
                const templateName = selectedOption.textContent;
                infoElement.innerHTML = `<span class="text-purple-600 font-medium">✓ Will generate ${format} attachment</span> using "${templateName}"`;
                
                // Show filename column field
                if (filenameField) {
                    filenameField.classList.remove('hidden');
                }
            } else {
                infoElement.innerHTML = 'No document template selected';
                
                // Hide filename column field
                if (filenameField) {
                    filenameField.classList.add('hidden');
                }
            }
        }

        function loadProfileFilters() {
            const savedStatus = localStorage.getItem('profiles_filterStatus');
            const savedConnection = localStorage.getItem('profiles_filterConnection');
            const savedGroup = localStorage.getItem('profiles_filterGroup');
            const savedSearchTerm = localStorage.getItem('profiles_searchTerm');

            if (savedStatus) document.getElementById('filter-status').value = savedStatus;
            if (savedConnection) document.getElementById('filter-connection').value = savedConnection;
            if (savedGroup) document.getElementById('filter-group').value = savedGroup;
            if (savedSearchTerm) document.getElementById('search-input').value = savedSearchTerm;
        }

        async function init() {

            setUserSidebarInfo();
            token = localStorage.getItem('reef_token');
            queueLucideRender();
            // Load all data in parallel
            await Promise.all([loadProfiles(), loadConnections(), loadGroups(), loadTemplates(), loadDestinations()]);
            // Load saved filters after data is loaded and apply them
            loadProfileFilters();
            applyFilters();
            // Now that all data is loaded and filters are applied, sort the profiles
            sortProfiles(currentSortColumn, false);
            // Add event listener for create webhook button
            const createBtn = document.getElementById('createWebhookBtn');
            if (createBtn) {
                createBtn.addEventListener('click', createWebhook);
            }
        }

        async function applyFilters() {
            const statusFilter = document.getElementById('filter-status').value;
            const connectionFilter = document.getElementById('filter-connection').value;
            const groupFilter = document.getElementById('filter-group').value;
            const searchTerm = (document.getElementById('search-input').value || '').toLowerCase().trim();

            // Save filter preferences to localStorage
            localStorage.setItem('profiles_filterStatus', statusFilter);
            localStorage.setItem('profiles_filterConnection', connectionFilter);
            localStorage.setItem('profiles_filterGroup', groupFilter);
            localStorage.setItem('profiles_searchTerm', searchTerm);

            filteredProfiles = profiles.filter(profile => {
                // Apply dropdown filters
                if (statusFilter === 'enabled' && !profile.isEnabled) return false;
                if (statusFilter === 'disabled' && profile.isEnabled) return false;
                if (connectionFilter && profile.connectionId != connectionFilter) return false;
                if (groupFilter && profile.groupId != groupFilter) return false;

                // Apply search filter across multiple fields
                if (searchTerm) {
                    const name = (profile.name || '').toLowerCase();
                    const connection = (profile.connectionName || '').toLowerCase();
                    const group = (profile.groupName || '').toLowerCase();
                    const outputFormat = (profile.outputFormat || '').toLowerCase();

                    const destinationInfo = (() => {
                        if (!profile.outputDestinationId) return '';
                        const dest = destinations.find(d => d.id === profile.outputDestinationId);
                        return dest ? `${dest.name} ${dest.type}`.toLowerCase() : '';
                    })();

                    const matches = name.includes(searchTerm) ||
                                  connection.includes(searchTerm) ||
                                  group.includes(searchTerm) ||
                                  outputFormat.includes(searchTerm) ||
                                  destinationInfo.includes(searchTerm);

                    if (!matches) return false;
                }

                return true;
            });

            // Show/hide clear button based on active filters
            updateClearButtonVisibility();

            sortProfiles(currentSortColumn, false);
        }

        function updateClearButtonVisibility() {
            const statusFilter = document.getElementById('filter-status').value;
            const connectionFilter = document.getElementById('filter-connection').value;
            const groupFilter = document.getElementById('filter-group').value;
            const searchTerm = (document.getElementById('search-input').value || '').trim();

            const hasActiveFilters = statusFilter || connectionFilter || groupFilter || searchTerm;
            const clearBtn = document.getElementById('clear-filters-btn');
            if (clearBtn) {
                clearBtn.style.display = hasActiveFilters ? 'block' : 'none';
            }
        }

        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-connection').value = '';
            document.getElementById('filter-group').value = '';

            // Clear saved preferences
            localStorage.removeItem('profiles_filterStatus');
            localStorage.removeItem('profiles_filterConnection');
            localStorage.removeItem('profiles_filterGroup');
            localStorage.removeItem('profiles_searchTerm');

            applyFilters();
        }

        async function loadProfiles() {
            try {
                const response = await fetch(`${API_BASE}/api/profiles`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Failed to load profiles');
                profiles = await response.json();
                filteredProfiles = [...profiles];
                populateFilterDropdowns();
                // Don't render yet - wait for all data to load
            } catch (error) {
                console.error('Error loading profiles:', error);
                showMessage('Failed to load profiles', 'error');
            }
        }

        function populateFilterDropdowns() {
            // Populate connections filter
            const connectionSelect = document.getElementById('filter-connection');
            if (connectionSelect && connections.length > 0) {
                connectionSelect.innerHTML = '<option value="">Show All</option>' +
                    connections.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
            }

            // Populate groups filter
            const groupSelect = document.getElementById('filter-group');
            if (groupSelect && groups.length > 0) {
                groupSelect.innerHTML = '<option value="">Show All</option>' +
                    groups.map(g => `<option value="${g.id}">${escapeHtml(g.name)}</option>`).join('');
            }

            // Restore saved filter values from localStorage
            restoreFilterPreferences();
        }

        function restoreFilterPreferences() {
            const savedStatus = localStorage.getItem('profiles_filterStatus');
            const savedConnection = localStorage.getItem('profiles_filterConnection');
            const savedGroup = localStorage.getItem('profiles_filterGroup');
            const savedSearch = localStorage.getItem('profiles_searchTerm');

            let hasFilters = false;

            if (savedStatus) {
                const statusSelect = document.getElementById('filter-status');
                if (statusSelect) {
                    statusSelect.value = savedStatus;
                    hasFilters = true;
                }
            }

            if (savedConnection) {
                const connectionSelect = document.getElementById('filter-connection');
                if (connectionSelect) {
                    connectionSelect.value = savedConnection;
                    hasFilters = true;
                }
            }

            if (savedGroup) {
                const groupSelect = document.getElementById('filter-group');
                if (groupSelect) {
                    groupSelect.value = savedGroup;
                    hasFilters = true;
                }
            }

            if (savedSearch) {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = savedSearch;
                    hasFilters = true;
                }
            }

            // Apply filters if any were restored
            if (hasFilters) {
                applyFilters();
            }
        }

        async function loadConnections() {
            try {
                const response = await fetch(`${API_BASE}/api/connections`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    connections = await response.json();
                    populateFilterDropdowns();
                }
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        async function loadGroups() {
            try {
                const response = await fetch(`${API_BASE}/api/groups`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    groups = await response.json();
                    populateFilterDropdowns();
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadDestinations() {
            try {
                const response = await fetch(`${API_BASE}/api/destinations`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    destinations = await response.json();
                }
            } catch (error) {
                console.error('Error loading destinations:', error);
            }
        }

        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    templates = await response.json();
                    const templateSelect = document.getElementById('template-id');
                    const emailAttachmentDocTemplateSelect = document.getElementById('emailAttachmentDocumentTemplateId');
                    
                    // Clear existing options (except the first "None" option)
                    templateSelect.innerHTML = '<option value="">None</option>';
                    
                    // Group templates by output format
                    const grouped = templates.reduce((acc, template) => {
                        if (!acc[template.outputFormat]) {
                            acc[template.outputFormat] = [];
                        }
                        acc[template.outputFormat].push(template);
                        return acc;
                    }, {});
                    
                    // Add templates grouped by format
                    Object.keys(grouped).sort().forEach(format => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${format} Templates`;
                        
                        grouped[format].forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.id;
                            option.textContent = template.name;
                            option.title = template.description;
                            option.dataset.outputFormat = template.outputFormat;
                            option.dataset.templateType = template.type; // Store template type
                            optgroup.appendChild(option);
                        });
                        
                        templateSelect.appendChild(optgroup);
                    });

                    // Populate email attachment document template dropdown (DocumentTemplate types only)
                    if (emailAttachmentDocTemplateSelect) {
                        const documentTemplates = templates.filter(t => t.type === 'DocumentTemplate' || t.type === 11);
                        
                        emailAttachmentDocTemplateSelect.innerHTML = '<option value="">None - Use binary content columns above</option>';
                        
                        if (documentTemplates.length > 0) {
                            const docGrouped = documentTemplates.reduce((acc, template) => {
                                if (!acc[template.outputFormat]) {
                                    acc[template.outputFormat] = [];
                                }
                                acc[template.outputFormat].push(template);
                                return acc;
                            }, {});

                            Object.keys(docGrouped).sort().forEach(format => {
                                const optgroup = document.createElement('optgroup');
                                optgroup.label = `${format} Document Templates`;
                                
                                docGrouped[format].forEach(template => {
                                    const option = document.createElement('option');
                                    option.value = template.id;
                                    option.textContent = template.name;
                                    option.title = template.description;
                                    option.dataset.outputFormat = template.outputFormat;
                                    optgroup.appendChild(option);
                                });
                                
                                emailAttachmentDocTemplateSelect.appendChild(optgroup);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function updateTemplateInfo() {
            const templateSelect = document.getElementById('template-id');
            const infoElement = document.getElementById('template-info');
            const outputFormatSelect = document.getElementById('output-format');
            const selectedOption = templateSelect.options[templateSelect.selectedIndex];
            const documentOptionsPanel = document.getElementById('fileExportDocumentOptions');

            if (templateSelect.value) {
                const format = selectedOption.dataset.outputFormat || 'Unknown';
                const templateType = selectedOption.dataset.templateType;
                const templateName = selectedOption.textContent;
                
                // Check if this is a DocumentTemplate (type 11 or string 'DocumentTemplate')
                const isDocumentTemplate = templateType === 'DocumentTemplate' || templateType === '11' || parseInt(templateType) === 11;
                
                if (isDocumentTemplate) {
                    infoElement.innerHTML = `<span class="text-purple-600 font-medium">✓ Will generate: ${format}</span> document using "${templateName}"`;
                    // Show document options panel
                    if (documentOptionsPanel) {
                        documentOptionsPanel.classList.remove('hidden');
                    }
                } else {
                    infoElement.innerHTML = `<span class="text-blue-600 font-medium">✓ Will output: ${format}</span> using "${templateName}"`;
                    // Hide document options panel for non-document templates
                    if (documentOptionsPanel) {
                        documentOptionsPanel.classList.add('hidden');
                    }
                }
                
                // Disable output format when template is selected
                outputFormatSelect.disabled = true;
                outputFormatSelect.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                const outputFormat = document.getElementById('output-format').value;
                infoElement.innerHTML = `Will use standard <span class="font-medium">${outputFormat}</span> formatter`;
                // Enable output format when template is cleared
                outputFormatSelect.disabled = false;
                outputFormatSelect.classList.remove('opacity-50', 'cursor-not-allowed');
                // Hide document options panel
                if (documentOptionsPanel) {
                    documentOptionsPanel.classList.add('hidden');
                }
            }
        }

        function renderProfiles() {
            const tbody = document.getElementById('profiles-tbody');
            
            if (filteredProfiles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i data-lucide="file-code" class="h-12 w-12 mx-auto mb-2 text-gray-300"></i>
                            <p>No profiles found. Create your first profile to get started.</p>
                        </td>
                    </tr>
                `;
                queueLucideRender();
                return;
            }

            tbody.innerHTML = filteredProfiles.map(profile => {
                const statusBadge = profile.isEnabled
                    ? '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Enabled</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">Disabled</span>';

                // Connection status badge and button state
                const connectionBadge = profile.connectionIsActive
                    ? ''
                    : '<span class="ml-2 px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">Connection Disabled</span>';

                const canExecute = profile.connectionIsActive && profile.isEnabled;
                const executeButton = canExecute
                    ? `<button id="play-btn-${profile.id}" onclick="executeProfileNormal(${profile.id})" class="text-green-600 hover:text-green-900 mr-3" title="Execute Profile">
                          <i data-lucide="play-circle" class="h-4 w-4 inline"></i>
                       </button>`
                    : `<button disabled class="text-gray-400 cursor-not-allowed mr-3" title="${!profile.connectionIsActive ? 'Connection Disabled' : 'Profile Disabled'}">
                          <i data-lucide="play-circle" class="h-4 w-4 inline"></i>
                       </button>`;

                const testButton = canExecute && profile.isEmailExport && 1==2
                    ? `<button onclick="testProfile(${profile.id})" class="text-orange-600 hover:text-orange-900 mr-3" title="Test Profile (Local Files)">
                          <i data-lucide="play-circle" class="h-4 w-4 inline"></i>
                       </button>`
                    : '';

                return `
                    <tr class="group hover:bg-slate-50 cursor-pointer transition-colors duration-200 ease-in-out border-l-4 border-transparent hover:border-blue-500">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-lucide="${profile.isEmailExport ? 'mail' : 'file-code'}" class="h-4 w-4 text-gray-400 mr-2"></i>
                                <span class="text-sm font-medium text-gray-900 group-hover:text-blue-900 transition-colors">${escapeHtml(profile.name)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">
                            ${escapeHtml(profile.connectionName || 'N/A')}${connectionBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${escapeHtml(profile.groupName || 'None')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${(() => {
                            if (profile.templateId) {
                                const template = templates.find(t => t.id === profile.templateId);
                                return template ? escapeHtml(template.outputFormat) : escapeHtml(profile.outputFormat);
                            }
                            return escapeHtml(profile.outputFormat);
                        })()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${(() => {
                            if (!profile.outputDestinationId) return 'Not configured';
                            const dest = destinations.find(d => d.id === profile.outputDestinationId);
                            return dest ? escapeHtml(`${dest.name} (${dest.type})`) : 'Unknown';
                        })()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">
                            ${(() => {
                                const lastRun = formatDateTime(profile.lastExecutedAt);
                                const lastRunRelative = formatRelativeTime(profile.lastExecutedAt);
                                return lastRunRelative || lastRun;
                            })()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${executeButton}
                            ${testButton}
                            <button onclick="editProfile(${profile.id})" class="text-blue-600 hover:text-blue-900 mr-3" data-tooltip="Edit Profile">
                                <i data-lucide="edit" class="h-4 w-4 inline"></i>
                            </button>
                            <button onclick="exportProfileToml(${profile.id})" class="text-purple-600 hover:text-purple-900 mr-3" data-tooltip="Export as TOML">
                                <i data-lucide="download" class="h-4 w-4 inline"></i>
                            </button>
                            <button onclick="toggleProfile(${profile.id}, ${!profile.isEnabled})" class="text-gray-600 hover:text-gray-900 mr-3" data-tooltip="${profile.isEnabled ? 'Disable' : 'Enable'} Profile">
                                <i data-lucide="${profile.isEnabled ? 'pause' : 'play'}" class="h-4 w-4 inline"></i>
                            </button>
                            <button onclick="deleteProfile(${profile.id}, '${escapeHtml(profile.name)}')" class="text-red-600 hover:text-red-900" data-tooltip="Delete Profile">
                                <i data-lucide="trash-2" class="h-4 w-4 inline"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            queueLucideRender();
        }

        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Deactivate all tab buttons
            document.getElementById('generalTabButton').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('generalTabButton').classList.add('text-gray-700', 'border-transparent', 'hover:border-gray-300');
            document.getElementById('webhooksTabButton').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('webhooksTabButton').classList.add('text-gray-700', 'border-transparent', 'hover:border-gray-300');
            document.getElementById('deltaSyncTabButton').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('deltaSyncTabButton').classList.add('text-gray-700', 'border-transparent', 'hover:border-gray-300');
            document.getElementById('splitOutputTabButton').classList.remove('text-blue-600', 'border-blue-600');
            document.getElementById('splitOutputTabButton').classList.add('text-gray-700', 'border-transparent', 'hover:border-gray-300');
            const emailOptionsTabButton = document.getElementById('emailOptionsTabButton');
            if (emailOptionsTabButton) {
                emailOptionsTabButton.classList.remove('text-blue-600', 'border-blue-600');
                emailOptionsTabButton.classList.add('text-gray-700', 'border-transparent', 'hover:border-gray-300');
            }

            // Show the active tab content
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Activate the active tab button
            const activeButton = document.getElementById(tabName + 'TabButton');
            activeButton.classList.add('text-blue-600', 'border-blue-600');
            activeButton.classList.remove('text-gray-700', 'border-transparent', 'hover:border-gray-300');

            // Re-render icons after tab switch
            queueLucideRender();
        }

        function toggleNewProfileMenu() {
            const menu = document.getElementById('newProfileMenu');
            menu.classList.toggle('hidden');
            // Close menu when clicking elsewhere
            if (!menu.classList.contains('hidden')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenuOnClick(e) {
                        const button = document.getElementById('newProfileButton');
                        if (!menu.contains(e.target) && !button.contains(e.target)) {
                            menu.classList.add('hidden');
                            document.removeEventListener('click', closeMenuOnClick);
                        }
                    });
                }, 0);
            }
        }

        function openAddProfileModal(profileType = 'standard') {
            // Hide email config section for standard profiles
            const emailConfigSection = document.getElementById('emailConfigSection');
            const emailApprovalSection = document.getElementById('emailApprovalSection');
            const previewEmailMenuItem = document.getElementById('preview-email-menu-item');
            const nonEmailFields = document.getElementById('nonEmailFields');
            const fileExportFields = document.getElementById('fileExportFields');
            const fileExportSplitFields = document.getElementById('fileExportSplitFields');
            const splitOutputTabButton = document.getElementById('splitOutputTabButton');
            const emailOptionsTabButton = document.getElementById('emailOptionsTabButton');
            const isEmailExport = profileType === 'email';

            if (emailConfigSection) {
                if (isEmailExport) {
                    emailConfigSection.classList.remove('hidden');
                } else {
                    emailConfigSection.classList.add('hidden');
                }
            }

            if (emailApprovalSection) {
                if (isEmailExport) {
                    emailApprovalSection.classList.remove('hidden');
                } else {
                    emailApprovalSection.classList.add('hidden');
                }
            }
            if (previewEmailMenuItem) {
                if (isEmailExport) {
                    previewEmailMenuItem.classList.remove('hidden');
                } else {
                    previewEmailMenuItem.classList.add('hidden');
                }
            }
            if (nonEmailFields) {
                if (isEmailExport) {
                    nonEmailFields.classList.add('hidden');
                } else {
                    nonEmailFields.classList.remove('hidden');
                }
            }
            if (fileExportFields) {
                if (isEmailExport) {
                    fileExportFields.classList.add('hidden');
                } else {
                    fileExportFields.classList.remove('hidden');
                }
            }
            if (fileExportSplitFields) {
                if (isEmailExport) {
                    fileExportSplitFields.classList.add('hidden');
                } else {
                    fileExportSplitFields.classList.remove('hidden');
                }
            }

            // For email profiles, enable split by default (split key column is optional)
            if (isEmailExport) {
                document.getElementById('splitEnabled').checked = true;
                const splitFields = document.getElementById('splitFields');
                if (splitFields) {
                    splitFields.classList.remove('opacity-50', 'pointer-events-none');
                }
                // Show email grouping option for email profiles when split is enabled
                toggleSplitFields();
            }

            document.getElementById('modal-title').textContent = isEmailExport ? 'Add Email Export Profile' : 'Add Profile';
            document.getElementById('profile-form').reset();
            document.getElementById('profile-id').value = '';

            // Re-set the checkbox after form reset
            document.getElementById('isEmailExport').checked = isEmailExport;

            // Close the dropdown menu
            document.getElementById('newProfileMenu').classList.add('hidden');

            // Populate connection dropdown
            const connectionSelect = document.getElementById('profile-connection');
            connectionSelect.innerHTML = '<option value="">Select Connection...</option>' +
                connections.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');

            // Populate group dropdown
            const groupSelect = document.getElementById('profile-group');
            groupSelect.innerHTML = '<option value="">No Group</option>' +
                groups.map(g => `<option value="${g.id}">${escapeHtml(g.name)}</option>`).join('');

            // Populate destination dropdown (filter based on profile type)
            const destinationSelect = document.getElementById('destination-id');
            if (isEmailExport) {
                // Email profiles: only show Email/SMTP destinations
                const emailDestinations = destinations.filter(d => d.type === 'Email');
                if (emailDestinations.length === 0) {
                    destinationSelect.innerHTML = '<option value="">-- No email destinations available --</option>';
                } else {
                    destinationSelect.innerHTML = '<option value="">-- Select an email destination --</option>' +
                        emailDestinations.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');
                }
            } else {
                // Regular export profiles: exclude Email destinations
                const fileDestinations = destinations.filter(d => d.type !== 'Email');
                if (fileDestinations.length === 0) {
                    destinationSelect.innerHTML = '<option value="">-- No file destinations available --</option>';
                } else {
                    destinationSelect.innerHTML = '<option value="">-- Select a destination --</option>' +
                        fileDestinations.map(d => `<option value="${d.id}">${escapeHtml(d.name)} (${d.type})</option>`).join('');
                }
            }

            // Populate email template dropdown (for email profiles)
            if (isEmailExport) {
                const emailTemplateSelect = document.getElementById('emailTemplateId');
                // Filter for Scriban templates with HTML output format only (emails must be HTML)
                const htmlScribanTemplates = templates.filter(t =>
                    (t.type === 'ScribanTemplate' || t.type === 10) &&
                    (t.outputFormat === 'HTML' || t.outputFormat === 'html')
                );

                if (htmlScribanTemplates.length === 0) {
                    emailTemplateSelect.innerHTML = '<option value="">-- No HTML Scriban templates available --</option>';
                } else {
                    emailTemplateSelect.innerHTML = '<option value="">-- Select HTML email template --</option>' +
                        htmlScribanTemplates.map(t => `<option value="${t.id}">${escapeHtml(t.name)} (${t.outputFormat})</option>`).join('');
                }
            }

            // Explicitly initialize email export fields
            document.getElementById('emailTemplateId').value = '';
            document.getElementById('emailRecipientsColumn').value = '';
            document.getElementById('emailRecipientsHardcoded').value = '';
            document.getElementById('useHardcodedRecipients').checked = false;
            document.getElementById('emailCcColumn').value = '';
            document.getElementById('emailCcHardcoded').value = '';
            document.getElementById('useHardcodedCc').checked = false;
            document.getElementById('emailSubjectColumn').value = '';
            document.getElementById('emailSubjectHardcoded').value = '';
            document.getElementById('useHardcodedSubject').checked = false;
            document.getElementById('emailSuccessThresholdPercent').value = '60';
            if (window.updateRecipientsModeDisplay) window.updateRecipientsModeDisplay();
            if (window.updateCcModeDisplay) window.updateCcModeDisplay();
            if (window.updateSubjectModeDisplay) window.updateSubjectModeDisplay();

            // Reset pre/post-processing fields
            document.getElementById('preprocess-type').value = '';
            document.getElementById('preprocess-command').value = '';
            document.getElementById('preprocess-timeout').value = '30';
            document.getElementById('preprocess-rollback-on-failure').checked = true;
            togglePreProcessConfig();
            
            document.getElementById('postprocess-type').value = '';
            document.getElementById('postprocess-command').value = '';
            document.getElementById('postprocess-timeout').value = '30';
            document.getElementById('postprocess-skip-on-failure').checked = true;
            togglePostProcessConfig();
            
            // Reset to general tab
            showTab('general');

            // Show/hide email options tab based on profile type
            if (emailOptionsTabButton) {
                if (isEmailExport) {
                    emailOptionsTabButton.style.display = '';
                } else {
                    emailOptionsTabButton.style.display = 'none';
                }
            }

            // Disable webhook tab for new profiles
            const webhooksTabButton = document.getElementById('webhooksTabButton');
            webhooksTabButton.disabled = true;
            webhooksTabButton.classList.add('opacity-50', 'cursor-not-allowed');

            // Disable delta sync tab for new profiles
            const deltaSyncTabButton = document.getElementById('deltaSyncTabButton');
            deltaSyncTabButton.disabled = true;
            deltaSyncTabButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Reset Delta Sync fields
            document.getElementById('deltaSyncEnabled').checked = false;
            document.getElementById('deltaSyncReefIdColumn').value = '';
            document.getElementById('deltaSyncHashAlgorithm').value = 'SHA256';
            document.getElementById('deltaSyncDuplicateStrategy').value = 'Strict';
            document.getElementById('deltaSyncNullStrategy').value = 'Strict';
            document.getElementById('deltaSyncNumericPrecision').value = '6';
            document.getElementById('deltaSyncTrackDeletes').checked = true;
            document.getElementById('excludeReefIdFromOutput').checked = true;
            toggleDeltaSyncFields();

            // Reset Split Output fields
            document.getElementById('splitEnabled').checked = false;
            document.getElementById('splitKeyColumn').value = '';
            document.getElementById('splitFilenameTemplate').value = '{profile}_{splitkey}_{timestamp}.{format}';
            document.getElementById('filenameTemplate').value = '{profile}_{timestamp}.{format}';
            document.getElementById('splitBatchSize').value = '1';
            // API default is now False, so unchecked by default
            document.getElementById('excludeSplitKeyFromOutput').checked = false;
            document.getElementById('postProcessPerSplit').checked = false;
            toggleSplitFields();

            // Hide stats and reset panels for new profiles
            document.getElementById('deltaSyncStats').classList.add('hidden');
            document.getElementById('deltaSyncAdvancedPanel').classList.add('hidden');
            
            // Clear any old webhooks from list
            document.getElementById('webhooksList').innerHTML = '<p class="text-gray-500 text-center py-4">Save the profile to enable webhooks.</p>';

            // Update template info to enable/disable output format field
            if (!isEmailExport && document.getElementById('template-info')) {
                try {
                    updateTemplateInfo();
                } catch (e) {
                    console.warn('Error updating template info:', e);
                }
            }

            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('scheduling-notice').style.display = '';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
            closeTestActionsMenu();
        }

        function toggleTestActionsMenu() {
            const menu = document.getElementById('test-actions-menu');
            menu.classList.toggle('hidden');
        }

        function closeTestActionsMenu() {
            const menu = document.getElementById('test-actions-menu');
            if (menu) {
                menu.classList.add('hidden');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('test-actions-menu');
            const btn = document.getElementById('test-actions-btn');
            if (menu && btn && !menu.contains(event.target) && !btn.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        async function editProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            // Reset to general tab
            showTab('general');
            
            // Enable webhook tab
            const webhooksTabButton = document.getElementById('webhooksTabButton');
            webhooksTabButton.disabled = false;
            webhooksTabButton.classList.remove('opacity-50', 'cursor-not-allowed');

            // Enable delta sync tab
            const deltaSyncTabButton = document.getElementById('deltaSyncTabButton');
            deltaSyncTabButton.disabled = false;
            deltaSyncTabButton.classList.remove('opacity-50', 'cursor-not-allowed');

            document.getElementById('modal-title').textContent = 'Edit Profile';
            document.getElementById('profile-id').value = profile.id;
            document.getElementById('profile-name').value = profile.name;
            document.getElementById('profile-connection').value = profile.connectionId;
            document.getElementById('profile-group').value = profile.groupId || '';
            document.getElementById('profile-query').value = profile.query;
            // Note: Schedule fields are deprecated and no longer shown in UI
            document.getElementById('output-format').value = profile.outputFormat;
            document.getElementById('template-id').value = profile.templateId || '';
            // Update template info display after setting value (only if visible for file exports)
            if (!profile.isEmailExport && document.getElementById('template-info')) {
                try {
                    updateTemplateInfo();
                } catch (e) {
                    console.warn('Error updating template info:', e);
                }
            }
            document.getElementById('destination-id').value = profile.outputDestinationId || '';
            document.getElementById('is-enabled').checked = profile.isEnabled;

            // Pre-processing fields
            if (profile.preProcessType && profile.preProcessConfig) {
                try {
                    const preConfig = JSON.parse(profile.preProcessConfig);
                    document.getElementById('preprocess-type').value = profile.preProcessType;
                    document.getElementById('preprocess-command').value = preConfig.Command || '';
                    document.getElementById('preprocess-timeout').value = preConfig.Timeout || 30;
                    togglePreProcessConfig();
                } catch (e) {
                    console.error('Error parsing pre-process config:', e);
                }
            } else {
                document.getElementById('preprocess-type').value = '';
                togglePreProcessConfig();
            }
            
            document.getElementById('preprocess-rollback-on-failure').checked = profile.preProcessRollbackOnFailure !== false;

            // Post-processing fields
            if (profile.postProcessType && profile.postProcessConfig) {
                try {
                    const postConfig = JSON.parse(profile.postProcessConfig);
                    document.getElementById('postprocess-type').value = profile.postProcessType;
                    document.getElementById('postprocess-command').value = postConfig.Command || '';
                    document.getElementById('postprocess-timeout').value = postConfig.Timeout || 30;
                    togglePostProcessConfig();
                } catch (e) {
                    console.error('Error parsing post-process config:', e);
                }
            } else {
                document.getElementById('postprocess-type').value = '';
                togglePostProcessConfig();
            }
            
            document.getElementById('postprocess-skip-on-failure').checked = profile.postProcessSkipOnFailure !== false;
            document.getElementById('postprocess-on-zero-rows').checked = profile.postProcessOnZeroRows === true;

            // Populate dropdowns
            const connectionSelect = document.getElementById('profile-connection');
            connectionSelect.innerHTML = '<option value="">Select Connection...</option>' +
                connections.map(c => `<option value="${c.id}" ${c.id === profile.connectionId ? 'selected' : ''}>${escapeHtml(c.name)}</option>`).join('');
            
            const groupSelect = document.getElementById('profile-group');
            groupSelect.innerHTML = '<option value="">No Group</option>' +
                groups.map(g => `<option value="${g.id}" ${g.id === profile.groupId ? 'selected' : ''}>${escapeHtml(g.name)}</option>`).join('');

            const destinationSelect = document.getElementById('destination-id');
            // Filter destinations based on profile type
            if (profile.isEmailExport) {
                // Email profiles: only show Email/SMTP destinations
                const emailDestinations = destinations.filter(d => d.type === 'Email');
                if (emailDestinations.length === 0) {
                    destinationSelect.innerHTML = '<option value="">-- No email destinations available --</option>';
                } else {
                    destinationSelect.innerHTML = '<option value="">-- Select an email destination --</option>' +
                        emailDestinations.map(d => `<option value="${d.id}" ${d.id === profile.outputDestinationId ? 'selected' : ''}>${escapeHtml(d.name)}</option>`).join('');
                }
            } else {
                // Regular export profiles: exclude Email destinations
                const fileDestinations = destinations.filter(d => d.type !== 'Email');
                if (fileDestinations.length === 0) {
                    destinationSelect.innerHTML = '<option value="">-- No file destinations available --</option>';
                } else {
                    destinationSelect.innerHTML = '<option value="">-- Select a destination --</option>' +
                        fileDestinations.map(d => `<option value="${d.id}" ${d.id === profile.outputDestinationId ? 'selected' : ''}>${escapeHtml(d.name)} (${d.type})</option>`).join('');
                }
            }

            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('scheduling-notice').style.display = 'none';

            // Load Delta Sync settings
            document.getElementById('deltaSyncEnabled').checked = profile.deltaSyncEnabled || false;
            document.getElementById('deltaSyncReefIdColumn').value = profile.deltaSyncReefIdColumn || '';
            document.getElementById('deltaSyncHashAlgorithm').value = profile.deltaSyncHashAlgorithm || 'SHA256';
            document.getElementById('deltaSyncDuplicateStrategy').value = profile.deltaSyncDuplicateStrategy || 'Strict';
            document.getElementById('deltaSyncNullStrategy').value = profile.deltaSyncNullStrategy || 'Strict';
            document.getElementById('deltaSyncNumericPrecision').value = profile.deltaSyncNumericPrecision ?? 6;
            document.getElementById('deltaSyncTrackDeletes').checked = profile.deltaSyncTrackDeletes !== false;
            document.getElementById('excludeReefIdFromOutput').checked = profile.excludeReefIdFromOutput !== false;
            toggleDeltaSyncFields();

            // Set email export flag BEFORE loading split settings (needed for toggleSplitFields logic)
            document.getElementById('isEmailExport').checked = profile.isEmailExport || false;

            // Load Split Output settings
            document.getElementById('splitEnabled').checked = profile.splitEnabled || false;
            document.getElementById('splitKeyColumn').value = profile.splitKeyColumn || '';
            document.getElementById('splitFilenameTemplate').value = profile.splitFilenameTemplate || '{profile}_{splitkey}_{timestamp}.{format}';
            document.getElementById('filenameTemplate').value = profile.filenameTemplate || '{profile}_{timestamp}.{format}';
            document.getElementById('splitBatchSize').value = profile.splitBatchSize || 1;
            document.getElementById('excludeSplitKeyFromOutput').checked = profile.excludeSplitKeyFromOutput !== false;
            document.getElementById('postProcessPerSplit').checked = profile.postProcessPerSplit || false;
            document.getElementById('emailGroupBySplitKey').checked = profile.emailGroupBySplitKey || false;
            toggleSplitFields();

            // Load Email Export settings (isEmailExport already set above)

            // Populate email template dropdown with HTML templates only (for consistency with new profiles)
            if (profile.isEmailExport) {
                const emailTemplateSelect = document.getElementById('emailTemplateId');
                const htmlScribanTemplates = templates.filter(t =>
                    (t.type === 'ScribanTemplate' || t.type === 10) &&
                    (t.outputFormat === 'HTML' || t.outputFormat === 'html')
                );

                if (htmlScribanTemplates.length === 0) {
                    emailTemplateSelect.innerHTML = '<option value="">-- No HTML Scriban templates available --</option>';
                } else {
                    emailTemplateSelect.innerHTML = '<option value="">-- Select HTML email template --</option>' +
                        htmlScribanTemplates.map(t => `<option value="${t.id}">${escapeHtml(t.name)} (${t.outputFormat})</option>`).join('');
                }

                // Set the selected template
                emailTemplateSelect.value = profile.emailTemplateId || '';
            }

            document.getElementById('emailRecipientsColumn').value = profile.emailRecipientsColumn || '';
            document.getElementById('emailRecipientsHardcoded').value = profile.emailRecipientsHardcoded || '';
            document.getElementById('useHardcodedRecipients').checked = profile.useHardcodedRecipients || false;
            document.getElementById('emailCcColumn').value = profile.emailCcColumn || '';
            document.getElementById('emailCcHardcoded').value = profile.emailCcHardcoded || '';
            document.getElementById('useHardcodedCc').checked = profile.useHardcodedCc || false;
            document.getElementById('emailSubjectColumn').value = profile.emailSubjectColumn || '';
            document.getElementById('emailSubjectHardcoded').value = profile.emailSubjectHardcoded || '';
            document.getElementById('useHardcodedSubject').checked = profile.useHardcodedSubject || false;
            document.getElementById('emailSuccessThresholdPercent').value = profile.emailSuccessThresholdPercent !== undefined && profile.emailSuccessThresholdPercent !== null ? profile.emailSuccessThresholdPercent : 60;
            if (window.updateRecipientsModeDisplay) window.updateRecipientsModeDisplay();
            if (window.updateCcModeDisplay) window.updateCcModeDisplay();
            if (window.updateSubjectModeDisplay) window.updateSubjectModeDisplay();

            // Load Email Approval Workflow settings
            document.getElementById('emailApprovalRequired').checked = profile.emailApprovalRequired || false;

            // Load approval roles
            const roleCheckboxes = document.querySelectorAll('[data-role-checkbox]');
            const approvalRoles = profile.emailApprovalRoles ? JSON.parse(profile.emailApprovalRoles) : [];
            roleCheckboxes.forEach(checkbox => {
                checkbox.checked = approvalRoles.includes(checkbox.value);
            });

            // Show/hide email config section based on profile type
            const emailConfigSection = document.getElementById('emailConfigSection');
            const emailApprovalSection = document.getElementById('emailApprovalSection');
            const previewEmailMenuItem = document.getElementById('preview-email-menu-item');
            const nonEmailFields = document.getElementById('nonEmailFields');
            const fileExportFields = document.getElementById('fileExportFields');
            const fileExportSplitFields = document.getElementById('fileExportSplitFields');
            const emailOptionsTabButton = document.getElementById('emailOptionsTabButton');
            if (profile.isEmailExport) {
                emailConfigSection.classList.remove('hidden');
                emailApprovalSection.classList.remove('hidden');
                if (previewEmailMenuItem) {
                    previewEmailMenuItem.classList.remove('hidden');
                }
                if (nonEmailFields) {
                    nonEmailFields.classList.add('hidden');
                }
                if (fileExportFields) {
                    fileExportFields.classList.add('hidden');
                }
                if (fileExportSplitFields) {
                    fileExportSplitFields.classList.add('hidden');
                }
                if (emailOptionsTabButton) {
                    emailOptionsTabButton.style.display = '';
                }
            } else {
                emailConfigSection.classList.add('hidden');
                emailApprovalSection.classList.add('hidden');
                if (previewEmailMenuItem) {
                    previewEmailMenuItem.classList.add('hidden');
                }
                if (nonEmailFields) {
                    nonEmailFields.classList.remove('hidden');
                }
                if (fileExportFields) {
                    fileExportFields.classList.remove('hidden');
                }
                if (fileExportSplitFields) {
                    fileExportSplitFields.classList.remove('hidden');
                }
                if (emailOptionsTabButton) {
                    emailOptionsTabButton.style.display = 'none';
                }
            }

            // Restore approval config visibility
            if (document.getElementById('emailApprovalRequired').checked) {
                document.getElementById('emailApprovalConfigSection').classList.remove('hidden');
            }

            // Update modal title to reflect email export status
            if (profile.isEmailExport) {
                document.getElementById('modal-title').textContent = 'Edit Email Export Profile';
            }

            // Show stats and reset panels only in edit mode
            document.getElementById('deltaSyncStats').classList.remove('hidden');
            document.getElementById('deltaSyncAdvancedPanel').classList.remove('hidden');

            // Load Delta Sync statistics
            if (profile.deltaSyncEnabled) {
                await loadDeltaSyncStats(profile.id);
            }

            // Load webhooks for this profile
            await loadWebhooks(profile.id);

            // Load Document Options (for file export with DocumentTemplate)
            if (!profile.isEmailExport && profile.documentOptions) {
                try {
                    const docOptions = JSON.parse(profile.documentOptions);
                    document.getElementById('fileExportPageSize').value = docOptions.pageSize || 'A4';
                    document.getElementById('fileExportOrientation').value = docOptions.orientation || 'Portrait';
                    document.getElementById('fileExportWatermark').value = docOptions.watermark || '';
                } catch (e) {
                    console.error('Error parsing document options:', e);
                }
            }

            // Load Email Attachment Config
            if (profile.isEmailExport && profile.emailAttachmentConfig) {
                try {
                    const attachmentConfig = JSON.parse(profile.emailAttachmentConfig);
                    
                    // Support both PascalCase (new) and camelCase (legacy) for backwards compatibility
                    const enabled = attachmentConfig.Enabled ?? attachmentConfig.enabled;
                    const mode = attachmentConfig.Mode ?? attachmentConfig.mode;
                    const documentTemplate = attachmentConfig.DocumentTemplate ?? attachmentConfig.documentTemplate;
                    const binary = attachmentConfig.Binary ?? attachmentConfig.binary;
                    const deduplication = attachmentConfig.Deduplication ?? attachmentConfig.deduplication;
                    const failsafe = attachmentConfig.Failsafe ?? attachmentConfig.failsafe ?? 'Disabled';
                    const maxAttachments = attachmentConfig.MaxAttachmentsPerEmail ?? attachmentConfig.maxAttachmentsPerEmail;

                    if (enabled) {
                        const attachmentsEnabledCheckbox = document.getElementById('attachmentsEnabled');
                        if (attachmentsEnabledCheckbox) {
                            attachmentsEnabledCheckbox.checked = true;
                            // Show/hide the config section without calling saveAttachmentConfig()
                            const configDiv = document.getElementById('attachmentConfig');
                            if (configDiv) {
                                configDiv.classList.remove('hidden');
                            }
                        }

                        if (mode === 'DocumentTemplate' && documentTemplate) {
                            // Document template mode
                            const templateIdEl = document.getElementById('emailAttachmentDocumentTemplateId');
                            const filenameColEl = document.getElementById('emailAttachmentFilenameColumn');
                            const generatePerRowEl = document.getElementById('emailAttachmentGeneratePerRow');
                            const pageSizeEl = document.getElementById('emailAttachmentPageSize');
                            const orientationEl = document.getElementById('emailAttachmentOrientation');
                            const watermarkEl = document.getElementById('emailAttachmentWatermark');
                            
                            const templateId = documentTemplate.TemplateId ?? documentTemplate.templateId;
                            const filenameColumnName = documentTemplate.FilenameColumnName ?? documentTemplate.filenameColumnName;
                            const generatePerRow = documentTemplate.GeneratePerRow ?? documentTemplate.generatePerRow ?? false;
                            const pageSize = documentTemplate.PageSize ?? documentTemplate.pageSize;
                            const orientation = documentTemplate.Orientation ?? documentTemplate.orientation;
                            const watermark = documentTemplate.Watermark ?? documentTemplate.watermark;
                            
                            if (templateIdEl) templateIdEl.value = templateId || '';
                            if (filenameColEl) filenameColEl.value = filenameColumnName || '';
                            if (generatePerRowEl) generatePerRowEl.checked = generatePerRow;
                            if (pageSizeEl) pageSizeEl.value = pageSize || 'A4';
                            if (orientationEl) orientationEl.value = orientation || 'Portrait';
                            if (watermarkEl) watermarkEl.value = watermark || '';
                            
                            if (typeof updateEmailAttachmentTemplateInfo === 'function') {
                                updateEmailAttachmentTemplateInfo();
                            }
                        } else if (mode === 'Binary' && binary) {
                            // Binary mode
                            const contentColEl = document.getElementById('attachmentContentColumn');
                            const filenameColEl = document.getElementById('attachmentFilenameColumn');
                            
                            const contentColumnName = binary.ContentColumnName ?? binary.contentColumnName;
                            const filenameColumnName = binary.FilenameColumnName ?? binary.filenameColumnName;
                            
                            if (contentColEl) contentColEl.value = contentColumnName || '';
                            if (filenameColEl) filenameColEl.value = filenameColumnName || '';
                        }

                        // Common settings
                        const dedupEl = document.getElementById('attachmentDeduplication');
                        const failsafeEl = document.getElementById('attachmentFailsafe');
                        const maxCountEl = document.getElementById('attachmentMaxCount');

                        if (dedupEl) dedupEl.value = deduplication || 'Auto';
                        if (failsafeEl) failsafeEl.value = failsafe || 'Disabled';
                        if (maxCountEl) maxCountEl.value = maxAttachments || 50;
                    }
                    
                    // CRITICAL: Set the hidden field value from database AFTER all UI fields are populated
                    // This must be done LAST to prevent saveAttachmentConfig() from overwriting it
                    const configField = document.getElementById('emailAttachmentConfig');
                    if (configField) {
                        configField.value = profile.emailAttachmentConfig;
                    }
                } catch (e) {
                    console.error('Error parsing email attachment config:', e);
                }
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const profileId = document.getElementById('profile-id').value;
            const name = document.getElementById('profile-name').value;
            const connectionId = parseInt(document.getElementById('profile-connection').value);
            const groupId = document.getElementById('profile-group').value ? parseInt(document.getElementById('profile-group').value) : null;
            const query = document.getElementById('profile-query').value;
            // Note: Schedule fields are deprecated and will be ignored by the backend
            const scheduleType = null;
            const scheduleCron = null;
            const scheduleIntervalMinutes = null;

            // Email Export fields (must be read before checking if email profile)
            const isEmailExportProfile = document.getElementById('isEmailExport').checked;

            // For email profiles, use HTML (determined by email template)
            const outputFormat = isEmailExportProfile ? 'HTML' : document.getElementById('output-format').value;
            const templateId = document.getElementById('template-id').value ? parseInt(document.getElementById('template-id').value) : null;
            const outputDestinationId = document.getElementById('destination-id').value ? parseInt(document.getElementById('destination-id').value) : null;
            const isEnabled = document.getElementById('is-enabled').checked;

            // Validation
            if (!outputDestinationId) {
                showToast('Please select a destination', 'error');
                return;
            }

            // Validate destination type matches profile type
            const selectedDestination = destinations.find(d => d.id === outputDestinationId);
            if (selectedDestination) {
                if (isEmailExportProfile && selectedDestination.type !== 'Email') {
                    showToast('Email export profiles must use an Email (SMTP) destination', 'error');
                    return;
                }
                if (!isEmailExportProfile && selectedDestination.type === 'Email') {
                    showToast('Regular export profiles cannot use Email (SMTP) destinations. Please select a file destination.', 'error');
                    return;
                }
            }

            // Validate output format for file exports
            if (!isEmailExportProfile && !outputFormat) {
                showToast('Please select an output format', 'error');
                return;
            }

            // Validate pre-processing
            const preProcessType = document.getElementById('preprocess-type').value;
            let preProcessConfig = null;
            if (preProcessType) {
                const preCommand = document.getElementById('preprocess-command').value.trim();
                if (!preCommand) {
                    showToast('Pre-process command is required when type is selected', 'error');
                    return;
                }
                preProcessConfig = JSON.stringify({
                    Type: preProcessType,
                    Command: preCommand,
                    Timeout: parseInt(document.getElementById('preprocess-timeout').value) || 30
                });
            }
            const preProcessRollbackOnFailure = document.getElementById('preprocess-rollback-on-failure').checked;

            // Validate post-processing
            const postProcessType = document.getElementById('postprocess-type').value;
            let postProcessConfig = null;
            if (postProcessType) {
                const postCommand = document.getElementById('postprocess-command').value.trim();
                if (!postCommand) {
                    showToast('Post-process command is required when type is selected', 'error');
                    return;
                }
                postProcessConfig = JSON.stringify({
                    Type: postProcessType,
                    Command: postCommand,
                    Timeout: parseInt(document.getElementById('postprocess-timeout').value) || 30
                });
            }
            const postProcessSkipOnFailure = document.getElementById('postprocess-skip-on-failure').checked;
            const postProcessOnZeroRows = document.getElementById('postprocess-on-zero-rows').checked;

            // Delta Sync fields
            const deltaSyncEnabled = document.getElementById('deltaSyncEnabled').checked;
            const deltaSyncReefIdColumn = deltaSyncEnabled ? document.getElementById('deltaSyncReefIdColumn').value.trim() : null;
            const deltaSyncHashAlgorithm = deltaSyncEnabled ? document.getElementById('deltaSyncHashAlgorithm').value : null;
            const deltaSyncDuplicateStrategy = deltaSyncEnabled ? document.getElementById('deltaSyncDuplicateStrategy').value : null;
            const deltaSyncNullStrategy = deltaSyncEnabled ? document.getElementById('deltaSyncNullStrategy').value : null;
            const deltaSyncNumericPrecision = deltaSyncEnabled ? parseInt(document.getElementById('deltaSyncNumericPrecision').value) : 6;
            const deltaSyncTrackDeletes = deltaSyncEnabled ? document.getElementById('deltaSyncTrackDeletes').checked : false;
            const excludeReefIdFromOutput = document.getElementById('excludeReefIdFromOutput').checked;
            const excludeSplitKeyFromOutput = document.getElementById('excludeSplitKeyFromOutput').checked;

            // Split Output fields
            const splitEnabled = document.getElementById('splitEnabled').checked;
            // For email profiles, split key column is optional (empty string is treated as null)
            // For file exports, split key column is required if split is enabled
            const splitKeyColumn = splitEnabled ? (document.getElementById('splitKeyColumn').value.trim() || null) : null;
            const splitFilenameTemplate = splitEnabled ? document.getElementById('splitFilenameTemplate').value : null;
            const filenameTemplate = splitEnabled ? null : document.getElementById('filenameTemplate').value;
            const splitBatchSize = splitEnabled ? parseInt(document.getElementById('splitBatchSize').value) : 1;
            // Always retrieve postProcessPerSplit from checkbox, regardless of splitEnabled
            const postProcessPerSplit = document.getElementById('postProcessPerSplit').checked;
            const emailGroupBySplitKey = document.getElementById('emailGroupBySplitKey').checked;

            // Email Export fields (isEmailExportProfile already defined above)
            const emailTemplateId = isEmailExportProfile && document.getElementById('emailTemplateId').value ?
                parseInt(document.getElementById('emailTemplateId').value) : null;
            const useHardcodedRecipients = isEmailExportProfile ? document.getElementById('useHardcodedRecipients').checked : false;
            const emailRecipientsColumn = isEmailExportProfile && !useHardcodedRecipients ?
                document.getElementById('emailRecipientsColumn').value.trim() : null;
            const emailRecipientsHardcoded = isEmailExportProfile && useHardcodedRecipients ?
                document.getElementById('emailRecipientsHardcoded').value.trim() : null;
            const useHardcodedCc = isEmailExportProfile ? document.getElementById('useHardcodedCc').checked : false;
            const emailCcColumn = isEmailExportProfile && !useHardcodedCc ?
                (document.getElementById('emailCcColumn').value.trim() || null) : null;
            const emailCcHardcoded = isEmailExportProfile && useHardcodedCc ?
                (document.getElementById('emailCcHardcoded').value.trim() || null) : null;
            const useHardcodedSubject = isEmailExportProfile ? document.getElementById('useHardcodedSubject').checked : false;
            const emailSubjectColumn = isEmailExportProfile && !useHardcodedSubject ?
                (document.getElementById('emailSubjectColumn').value.trim() || null) : null;
            const emailSubjectHardcoded = isEmailExportProfile && useHardcodedSubject ?
                (document.getElementById('emailSubjectHardcoded').value.trim() || null) : null;
            const emailSuccessThresholdPercent = isEmailExportProfile ?
                parseInt(document.getElementById('emailSuccessThresholdPercent').value) || 60 : 60;

            // Email Approval Workflow fields
            const emailApprovalRequired = isEmailExportProfile ? document.getElementById('emailApprovalRequired').checked : false;
            const emailApprovalRolesCheckboxes = document.querySelectorAll('[data-role-checkbox]:checked');
            const emailApprovalRoles = Array.from(emailApprovalRolesCheckboxes).map(cb => cb.value);
            const emailApprovalRolesJson = emailApprovalRequired ? JSON.stringify(emailApprovalRoles) : null;

            // Email Attachment Configuration
            const emailAttachmentConfigValue = document.getElementById('emailAttachmentConfig')?.value;
            const emailAttachmentConfig = isEmailExportProfile && emailAttachmentConfigValue && emailAttachmentConfigValue.trim() !== '' ? 
                emailAttachmentConfigValue : null;

            // Document Options (for DocumentTemplate types in regular file export)
            let documentOptions = null;
            if (!isEmailExportProfile && templateId) {
                const template = templates.find(t => t.id === parseInt(templateId));
                const isDocumentTemplate = template && (template.type === 'DocumentTemplate' || template.type === 11 || parseInt(template.type) === 11);
                
                if (isDocumentTemplate) {
                    documentOptions = JSON.stringify({
                        pageSize: document.getElementById('fileExportPageSize').value || 'A4',
                        orientation: document.getElementById('fileExportOrientation').value || 'Portrait',
                        watermark: document.getElementById('fileExportWatermark').value || null
                    });
                }
            }

            // Validate email export configuration
            if (isEmailExportProfile) {
                if (!emailTemplateId) {
                    showToast('Email template is required for email export profiles', 'error');
                    showTab('general');
                    return;
                }

                // Validate that selected template is HTML format
                const selectedTemplate = templates.find(t => t.id === emailTemplateId);
                if (!selectedTemplate) {
                    showToast('Selected email template not found', 'error');
                    showTab('general');
                    return;
                }
                if (selectedTemplate.outputFormat !== 'HTML' && selectedTemplate.outputFormat !== 'html') {
                    showToast('Email templates must be HTML format. Selected template is ' + selectedTemplate.outputFormat, 'error');
                    showTab('general');
                    return;
                }

                if (!emailRecipientsColumn && !emailRecipientsHardcoded) {
                    showToast('Recipients column or hardcoded email is required for email export profiles', 'error');
                    showTab('general');
                    return;
                }
            }

            // Validate Delta Sync configuration
            if (deltaSyncEnabled && !deltaSyncReefIdColumn) {
                showToast('Delta Sync requires a ReefId column name', 'error');
                showTab('deltaSync');
                return;
            }

            // Validate Split configuration (only for non-email profiles)
            if (!isEmailExportProfile && splitEnabled && !splitKeyColumn) {
                showToast('Split Key Column is required when splitting is enabled', 'error');
                showTab('splitOutput');
                return;
            }

            // Check for duplicate name (only when creating new profile)
            if (!profileId) {
                try {
                    const existingProfiles = await fetch(`${API_BASE}/api/profiles`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (existingProfiles.ok) {
                        const profiles = await existingProfiles.json();
                        const duplicate = profiles.find(p => p.name.toLowerCase() === name.toLowerCase());

                        if (duplicate) {
                            showToast(`Profile with name "${name}" already exists. Please use a different name.`, 'error');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking for duplicate profiles:', error);
                    // Continue anyway, let the server handle it
                }
            }

            // Combine fields for hash (including pre/post-processing, delta sync, splitting, email config, email attachments, and document options)
            const hashInput = `${name}|${connectionId}|${groupId}|${query}|${outputFormat}|${templateId}|${outputDestinationId}|${isEnabled}|${preProcessType || ''}|${preProcessConfig || ''}|${preProcessRollbackOnFailure}|${postProcessType || ''}|${postProcessConfig || ''}|${postProcessSkipOnFailure}|${postProcessOnZeroRows}|${deltaSyncEnabled}|${deltaSyncReefIdColumn || ''}|${deltaSyncHashAlgorithm || ''}|${deltaSyncDuplicateStrategy || ''}|${deltaSyncNullStrategy || ''}|${deltaSyncNumericPrecision || ''}|${deltaSyncTrackDeletes}|${excludeReefIdFromOutput}|${excludeSplitKeyFromOutput}|${splitEnabled}|${splitKeyColumn || ''}|${splitFilenameTemplate || ''}|${splitBatchSize}|${postProcessPerSplit}|${emailGroupBySplitKey}|${filenameTemplate || ''}|${emailSuccessThresholdPercent}|${emailApprovalRequired}|${emailApprovalRolesJson || ''}|${emailAttachmentConfig || ''}|${documentOptions || ''}`;
            const hash = await window.sha256(hashInput);

            const profile = {
                name,
                connectionId,
                groupId,
                query,
                scheduleType,
                scheduleCron,
                scheduleIntervalMinutes,
                outputFormat,
                templateId,
                outputDestinationId,
                outputDestinationType: 'Local', // Backend still expects this, send default
                outputDestinationConfig: null, // Backend still expects this
                isEnabled,
                preProcessType: preProcessType || null,
                preProcessConfig: preProcessConfig,
                preProcessRollbackOnFailure: preProcessRollbackOnFailure,
                postProcessType: postProcessType || null,
                postProcessConfig: postProcessConfig,
                postProcessSkipOnFailure: postProcessSkipOnFailure,
                postProcessOnZeroRows: postProcessOnZeroRows,
                deltaSyncEnabled: deltaSyncEnabled,
                deltaSyncReefIdColumn: deltaSyncReefIdColumn,
                deltaSyncHashAlgorithm: deltaSyncHashAlgorithm,
                deltaSyncDuplicateStrategy: deltaSyncDuplicateStrategy,
                deltaSyncNullStrategy: deltaSyncNullStrategy,
                deltaSyncNumericPrecision: deltaSyncNumericPrecision,
                deltaSyncTrackDeletes: deltaSyncTrackDeletes,
                excludeReefIdFromOutput: excludeReefIdFromOutput,
                excludeSplitKeyFromOutput: excludeSplitKeyFromOutput,
                splitEnabled: splitEnabled,
                splitKeyColumn: splitKeyColumn,
                splitFilenameTemplate: splitFilenameTemplate,
                filenameTemplate: filenameTemplate,
                splitBatchSize: splitBatchSize,
                postProcessPerSplit: postProcessPerSplit,
                emailGroupBySplitKey: emailGroupBySplitKey,
                isEmailExport: isEmailExportProfile,
                emailTemplateId: emailTemplateId,
                emailRecipientsColumn: emailRecipientsColumn,
                emailRecipientsHardcoded: emailRecipientsHardcoded,
                useHardcodedRecipients: useHardcodedRecipients,
                emailCcColumn: emailCcColumn,
                emailCcHardcoded: emailCcHardcoded,
                useHardcodedCc: useHardcodedCc,
                emailSubjectColumn: emailSubjectColumn,
                emailSubjectHardcoded: emailSubjectHardcoded,
                useHardcodedSubject: useHardcodedSubject,
                emailSuccessThresholdPercent: emailSuccessThresholdPercent,
                emailAttachmentConfig: emailAttachmentConfig,
                emailApprovalRequired: emailApprovalRequired,
                emailApprovalRoles: emailApprovalRolesJson,
                documentOptions: documentOptions,
                hash
            };

            try {
                const url = profileId ? `${API_BASE}/api/profiles/${profileId}` : `${API_BASE}/api/profiles`;
                const method = profileId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profile)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save profile. Reason: ' + response.statusText);
                }

                showMessage(`Profile ${profileId ? 'updated' : 'created'} successfully`, 'success');
                closeProfileModal();
                await loadProfiles();
                // Apply filters (respecting current filter selections) and render
                await applyFilters();
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast(error.message, 'error');
            }
        });

        async function testProfile(id) {
            try {
                // For email export profiles, use local file destination for testing
                let executeUrl = `${API_BASE}/api/executions/execute/${id}`;
                const profile = profiles.find(p => p.id === id);

                if (profile && profile.isEmailExport) {
                    // Find local file destination for testing
                    const localDest = destinations.find(d => d.type === 'Local');
                    if (localDest) {
                        executeUrl += `?testMode=true&localDestinationId=${localDest.id}`;
                        showToast('Test mode: Using local file destination instead of email for preview', 'info');
                    }
                }

                const response = await fetch(executeUrl, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    let errorMsg = 'Failed to test profile';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMsg = error.error || errorMsg;
                        } else {
                            errorMsg = await response.text() || errorMsg;
                        }
                    } catch {}
                    throw new Error(errorMsg);
                }
                // Only parse JSON if present
                let result = null;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                }

                // Check if execution actually succeeded
                if (result && result.status === 'Failed') {
                    throw new Error(result.error || 'Profile execution failed');
                }

                showToast('Profile executed successfully! Check the Executions page for results.', 'success');
                // Optionally reload profiles to show updated stats
                await loadProfiles();
            } catch (error) {
                console.error('Error testing profile:', error);
                showToast(error.message, 'error');
            }
        }

        async function sendEmailProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) {
                showToast('Profile not found', 'error');
                return;
            }

            // Validate email configuration
            try {
                const response = await fetch(`${API_BASE}/api/profiles/${id}/validate-email-config`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Profile not found');
                }

                const validation = await response.json();
                if (!validation.isValid) {
                    const errorList = validation.errors.join('\n• ');
                    showToast(`Email configuration incomplete:\n• ${errorList}`, 'error');
                    return;
                }

                if (validation.warnings.length > 0) {
                    console.warn('Email configuration warnings:', validation.warnings);
                }
            } catch (error) {
                console.error('Error validating email config:', error);
                showToast('Failed to validate email configuration', 'error');
                return;
            }

            // Execute the email export
            try {
                const response = await fetch(`${API_BASE}/api/executions/execute/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    let errorMsg = 'Failed to send email';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMsg = error.error || errorMsg;
                        } else {
                            errorMsg = await response.text() || errorMsg;
                        }
                    } catch {}
                    throw new Error(errorMsg);
                }

                let result = null;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                }

                if (result && result.status === 'Failed') {
                    throw new Error(result.error || 'Email execution failed');
                }

                showToast('Email sent successfully! Check the Executions page for details.', 'success');
                await loadProfiles();
            } catch (error) {
                console.error('Error sending email:', error);
                showToast(error.message, 'error');
            }
        }

        async function testProfileInModal() {
            const btn = document.getElementById('test-profile-btn');
            const spinner = document.getElementById('test-profile-spinner');
            const btnText = document.getElementById('test-profile-btn-text');
            
            if (btn && spinner && btnText) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                btnText.textContent = 'Testing...';
            }

            try {
                const profileId = document.getElementById('profile-id').value;
                // If profile is not saved yet, save it first
                if (!profileId) {
                    showMessage('Saving profile before testing...', 'info');

                    // Gather fields as in the main form submission
                    const name = document.getElementById('profile-name').value;
                    const connectionId = parseInt(document.getElementById('profile-connection').value);
                    const groupId = document.getElementById('profile-group').value ? parseInt(document.getElementById('profile-group').value) : null;
                    const query = document.getElementById('profile-query').value;
                    const scheduleType = null;
                    const scheduleCron = null;
                    const scheduleIntervalMinutes = null;

                    // Email Export profile check
                    const isEmailExportProfile = document.getElementById('isEmailExport').checked;

                    // For email profiles, use HTML (determined by email template)
                    const outputFormat = isEmailExportProfile ? 'HTML' : document.getElementById('output-format').value;
                    const templateId = document.getElementById('template-id').value ? parseInt(document.getElementById('template-id').value) : null;

                    // For testing email profiles, use local file destination instead of email destination
                    let outputDestinationId = document.getElementById('destination-id').value ? parseInt(document.getElementById('destination-id').value) : null;
                    if (isEmailExportProfile && outputDestinationId) {
                        // Find local file destination for testing
                        const localDest = destinations.find(d => d.type === 'Local');
                        if (localDest) {
                            outputDestinationId = localDest.id;
                            showToast('Test mode: Using local file destination instead of email for preview', 'info');
                        }
                    }
                    const isEnabled = document.getElementById('is-enabled').checked;

                    // Validation (match form submission)
                    if (!outputDestinationId) {
                        showToast('Please select a destination', 'error');
                        throw new Error('Destination required');
                    }

                    // Validate destination type matches profile type (skip for email test mode which uses local file)
                    const selectedDestination = destinations.find(d => d.id === outputDestinationId);
                    if (selectedDestination && !isEmailExportProfile) {
                        if (selectedDestination.type === 'Email') {
                            showToast('Regular export profiles cannot use Email (SMTP) destinations. Please select a file destination.', 'error');
                            throw new Error('Invalid destination type for regular profile');
                        }
                    }

                    // Pre-processing fields
                    const preProcessType = document.getElementById('preprocess-type').value;
                    let preProcessConfig = null;
                    if (preProcessType) {
                        const preCommand = document.getElementById('preprocess-command').value.trim();
                        if (!preCommand) {
                            showToast('Pre-process command is required when type is selected', 'error');
                            throw new Error('Pre-process command required');
                        }
                        preProcessConfig = JSON.stringify({
                            Type: preProcessType,
                            Command: preCommand,
                            Timeout: parseInt(document.getElementById('preprocess-timeout').value) || 30
                        });
                    }
                    const preProcessRollbackOnFailure = document.getElementById('preprocess-rollback-on-failure').checked;

                    // Post-processing fields
                    const postProcessType = document.getElementById('postprocess-type').value;
                    let postProcessConfig = null;
                    if (postProcessType) {
                        const postCommand = document.getElementById('postprocess-command').value.trim();
                        if (!postCommand) {
                            showToast('Post-process command is required when type is selected', 'error');
                            throw new Error('Post-process command required');
                        }
                        postProcessConfig = JSON.stringify({
                            Type: postProcessType,
                            Command: postCommand,
                            Timeout: parseInt(document.getElementById('postprocess-timeout').value) || 30
                        });
                    }
                    const postProcessSkipOnFailure = document.getElementById('postprocess-skip-on-failure').checked;
                    const postProcessOnZeroRows = document.getElementById('postprocess-on-zero-rows').checked;

                    // Delta Sync fields
                    const deltaSyncEnabled = document.getElementById('deltaSyncEnabled').checked;
                    const deltaSyncReefIdColumn = deltaSyncEnabled ? document.getElementById('deltaSyncReefIdColumn').value.trim() : null;
                    const deltaSyncHashAlgorithm = deltaSyncEnabled ? document.getElementById('deltaSyncHashAlgorithm').value : null;
                    const deltaSyncDuplicateStrategy = deltaSyncEnabled ? document.getElementById('deltaSyncDuplicateStrategy').value : null;
                    const deltaSyncNullStrategy = deltaSyncEnabled ? document.getElementById('deltaSyncNullStrategy').value : null;
                    const deltaSyncNumericPrecision = deltaSyncEnabled ? parseInt(document.getElementById('deltaSyncNumericPrecision').value) : 6;
                    const deltaSyncTrackDeletes = deltaSyncEnabled ? document.getElementById('deltaSyncTrackDeletes').checked : false;
                    const excludeReefIdFromOutput = document.getElementById('excludeReefIdFromOutput').checked;
                    const excludeSplitKeyFromOutput = document.getElementById('excludeSplitKeyFromOutput').checked;

                    // Split Output fields
                    const splitEnabled = document.getElementById('splitEnabled').checked;
                    // For email profiles, split key column is optional (empty string is treated as null)
                    // For file exports, split key column is required if split is enabled
                    const splitKeyColumn = splitEnabled ? (document.getElementById('splitKeyColumn').value.trim() || null) : null;
                    const splitFilenameTemplate = splitEnabled ? document.getElementById('splitFilenameTemplate').value : null;
                    const filenameTemplate = splitEnabled ? null : document.getElementById('filenameTemplate').value;
                    const splitBatchSize = splitEnabled ? parseInt(document.getElementById('splitBatchSize').value) : 1;
                    const postProcessPerSplit = document.getElementById('postProcessPerSplit').checked;
                    const emailGroupBySplitKey = document.getElementById('emailGroupBySplitKey').checked;

                    // Email Export fields
                    const emailTemplateId = isEmailExportProfile && document.getElementById('emailTemplateId').value ?
                        parseInt(document.getElementById('emailTemplateId').value) : null;
                    const emailRecipientsColumn = isEmailExportProfile ?
                        document.getElementById('emailRecipientsColumn').value.trim() : null;
                    const emailCcColumn = isEmailExportProfile ?
                        (document.getElementById('emailCcColumn').value.trim() || null) : null;
                    const emailSubjectColumn = isEmailExportProfile ?
                        (document.getElementById('emailSubjectColumn').value.trim() || null) : null;

                    // Validate Delta Sync configuration
                                if (deltaSyncEnabled && !deltaSyncReefIdColumn) {
                                    showToast('Delta Sync requires a ReefId column name', 'error');
                                    showTab('deltaSync');
                                    throw new Error('Delta Sync ReefId column required');
                                }
                    
                                // Validate Split configuration (only for non-email profiles)
                                if (!isEmailExportProfile && splitEnabled && !splitKeyColumn) {
                                    showToast('Split Key Column is required when splitting is enabled', 'error');
                                    showTab('splitOutput');
                                    throw new Error('Split Key Column required');
                                }
                    
                                // Combine fields for hash (including pre/post-processing, delta sync, splitting, and email config)
                                const hashInput = `${name}|${connectionId}|${groupId}|${query}|${outputFormat}|${templateId}|${outputDestinationId}|${isEnabled}|${preProcessType || ''}|${preProcessConfig || ''}|${preProcessRollbackOnFailure}|${postProcessType || ''}|${postProcessConfig || ''}|${postProcessSkipOnFailure}|${postProcessOnZeroRows}|${deltaSyncEnabled}|${deltaSyncReefIdColumn || ''}|${deltaSyncHashAlgorithm || ''}|${deltaSyncDuplicateStrategy || ''}|${deltaSyncNullStrategy || ''}|${deltaSyncNumericPrecision || ''}|${deltaSyncTrackDeletes}|${excludeReefIdFromOutput}|${excludeSplitKeyFromOutput}|${splitEnabled}|${splitKeyColumn || ''}|${splitFilenameTemplate || ''}|${splitBatchSize}|${postProcessPerSplit}|${emailGroupBySplitKey}|${filenameTemplate || ''}|${emailSuccessThresholdPercent}`;
                                const hash = await window.sha256(hashInput);
                    
                                const profile = {
                                    name,
                                    connectionId,
                                    groupId,
                                    query,
                                    scheduleType,
                                    scheduleCron,
                                    scheduleIntervalMinutes,
                                    outputFormat,
                                    templateId,
                                    outputDestinationId,
                                    outputDestinationType: 'Local',
                                    outputDestinationConfig: null,
                                    isEnabled,
                                    preProcessType: preProcessType || null,
                                    preProcessConfig: preProcessConfig,
                                    preProcessRollbackOnFailure: preProcessRollbackOnFailure,
                                    postProcessType: postProcessType || null,
                                    postProcessConfig: postProcessConfig,
                                    postProcessSkipOnFailure: postProcessSkipOnFailure,
                                    postProcessOnZeroRows: postProcessOnZeroRows,
                                    deltaSyncEnabled: deltaSyncEnabled,
                                    deltaSyncReefIdColumn: deltaSyncReefIdColumn,
                                    deltaSyncHashAlgorithm: deltaSyncHashAlgorithm,
                                    deltaSyncDuplicateStrategy: deltaSyncDuplicateStrategy,
                                    deltaSyncNullStrategy: deltaSyncNullStrategy,
                                    deltaSyncNumericPrecision: deltaSyncNumericPrecision,
                                    deltaSyncTrackDeletes: deltaSyncTrackDeletes,
                                    excludeReefIdFromOutput: excludeReefIdFromOutput,
                                    excludeSplitKeyFromOutput: excludeSplitKeyFromOutput,
                                                    splitEnabled: splitEnabled,
                                                    splitKeyColumn: splitKeyColumn,
                                                    splitFilenameTemplate: splitFilenameTemplate,
                                                    filenameTemplate: filenameTemplate,
                                                    splitBatchSize: splitBatchSize,
                                                    postProcessPerSplit: postProcessPerSplit,
                                                    emailGroupBySplitKey: emailGroupBySplitKey,
                                                    hash
                                };
                    const saveResponse = await fetch(`${API_BASE}/api/profiles`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(profile)
                    });

                    if (!saveResponse.ok) {
                        let errorMsg = 'Failed to save profile';
                        try {
                            const contentType = saveResponse.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const error = await saveResponse.json();
                                errorMsg = error.error || errorMsg;
                            } else {
                                errorMsg = await saveResponse.text() || errorMsg;
                            }
                        } catch {}
                        throw new Error(errorMsg);
                    }

                    const savedProfile = await saveResponse.json();
                    document.getElementById('profile-id').value = savedProfile.id;
                    await loadProfiles();
                    showMessage('Profile saved successfully, now testing...', 'success');
                    // Test the newly saved profile
                    await testProfile(savedProfile.id);
                } else {
                    // Profile already exists, just test it
                    await testProfile(parseInt(profileId));
                }
            } catch (error) {
                console.error('Error in testProfileInModal:', error);
                (error.message || 'Failed to test profile', 'error');
            } finally {
                if (btn && spinner && btnText) {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Test Profile';
                }
            }
        }

        // Variables to track pending email execution
        let pendingEmailProfileId = null;
        let currentMathQuestion = null;

        // Helper functions for play button loading state
        function setPlayButtonLoading(profileId, isLoading) {
            const button = document.getElementById(`play-btn-${profileId}`);
            if (!button) return;

            if (isLoading) {
                button.disabled = true;
                button.classList.add('cursor-not-allowed', 'opacity-50');
                button.innerHTML = '<i data-lucide="loader-circle" class="h-4 w-4 inline animate-spin"></i>';
            } else {
                button.disabled = false;
                button.classList.remove('cursor-not-allowed', 'opacity-50');
                button.innerHTML = '<i data-lucide="play-circle" class="h-4 w-4 inline"></i>';
            }

            // Reinitialize lucide icons for the updated button
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        async function executeProfileNormal(id) {
            // Set loading state immediately
            setPlayButtonLoading(id, true);

            try {
                const profile = profiles.find(p => p.id === id);
                if (!profile) {
                    showToast('Profile not found', 'error');
                    return;
                }

                // For email profiles, show confirmation modal with math verification
                if (profile.isEmailExport) {
                    // Clear loading state since modal will handle the execution
                    setPlayButtonLoading(id, false);
                    pendingEmailProfileId = id;
                    showEmailExecutionConfirmationModal();
                    return;
                }

                // For file export profiles, execute directly
                await performProfileExecution(id);
            } catch (error) {
                console.error('Error in executeProfileNormal:', error);
                showToast(error.message || 'Failed to execute profile', 'error');
            } finally {
                // Always clear loading state when done (for non-email profiles)
                const profile = profiles.find(p => p.id === id);
                if (profile && !profile.isEmailExport) {
                    setPlayButtonLoading(id, false);
                }
            }
        }

        function showEmailExecutionConfirmationModal() {
            const modal = document.getElementById('email-execute-confirmation-modal');
            if (!modal) return;

            // Generate new math question
            currentMathQuestion = generateMathQuestion();
            document.getElementById('math-question').textContent = currentMathQuestion.question;
            document.getElementById('math-answer-input').value = '';
            document.getElementById('math-error').classList.add('hidden');

            // Show modal
            modal.classList.remove('hidden');

            // Focus on input field
            setTimeout(() => {
                const input = document.getElementById('math-answer-input');
                if (input) input.focus();
            }, 100);

            // Allow Enter key to submit
            const input = document.getElementById('math-answer-input');
            if (input) {
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        confirmEmailExecution();
                    }
                };
            }
        }

        function closeEmailExecutionConfirmationModal() {
            const modal = document.getElementById('email-execute-confirmation-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            pendingEmailProfileId = null;
            currentMathQuestion = null;
        }

        async function confirmEmailExecution() {
            if (!pendingEmailProfileId || !currentMathQuestion) {
                showToast('Invalid execution state', 'error');
                return;
            }

            const input = document.getElementById('math-answer-input');
            const errorMsg = document.getElementById('math-error');
            const answer = input.value.trim();

            // Validate answer
            if (!answer) {
                errorMsg.textContent = 'Please enter an answer';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (parseInt(answer) !== currentMathQuestion.answer) {
                errorMsg.textContent = 'Incorrect answer. Try again.';
                errorMsg.classList.remove('hidden');
                input.value = '';
                input.focus();
                return;
            }

            // Answer is correct, proceed with execution
            const profileId = pendingEmailProfileId;
            closeEmailExecutionConfirmationModal();

            // Set loading state for email profile button
            setPlayButtonLoading(profileId, true);
            try {
                await performProfileExecution(profileId);
            } finally {
                setPlayButtonLoading(profileId, false);
            }
        }

        async function performProfileExecution(id) {
            try {
                const response = await fetch(`${API_BASE}/api/executions/execute/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    let errorMsg = 'Failed to execute profile';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMsg = error.error || errorMsg;
                        } else {
                            errorMsg = await response.text() || errorMsg;
                        }
                    } catch {}
                    throw new Error(errorMsg);
                }

                let result = null;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                }

                if (result && result.status === 'Failed') {
                    throw new Error(result.error || 'Profile execution failed');
                }

                const profile = profiles.find(p => p.id === id);
                const profileType = profile && profile.isEmailExport ? 'Email' : 'Profile';
                showToast(`${profileType} executed successfully! Check the Executions page for results.`, 'success');
                await loadProfiles();

                // Update approval badge after email profile execution (if approvals were created)
                if (profile && profile.isEmailExport && typeof updateApprovalBadge === 'function') {
                    // Small delay to ensure backend has processed and stored approvals
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await updateApprovalBadge();
                }
            } catch (error) {
                console.error('Error executing profile:', error);
                showToast(error.message || 'Failed to execute profile', 'error');
            }
        }

        function generateMathQuestion() {
            const operators = ['+', '-', '*'];
            const operator = operators[Math.floor(Math.random() * operators.length)];
            const num1 = Math.floor(Math.random() * 10) + 1;  // 1-10
            const num2 = Math.floor(Math.random() * 10) + 1;  // 1-10

            let answer;
            switch (operator) {
                case '+':
                    answer = num1 + num2;
                    break;
                case '-':
                    answer = num1 - num2;
                    break;
                case '*':
                    answer = num1 * num2;
                    break;
                default:
                    answer = num1 + num2;
            }

            return {
                question: `What is ${num1} ${operator} ${num2}?`,
                answer: answer
            };
        }

        async function toggleProfile(id, enable) {
            try {
                const action = enable ? 'enable' : 'disable';
                const response = await fetch(`${API_BASE}/api/profiles/${id}/${action}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    let errorMsg = `Failed to ${action} profile`;
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMsg = error.error || errorMsg;
                        } else {
                            errorMsg = await response.text() || errorMsg;
                        }
                    } catch {}
                    throw new Error(errorMsg);
                }

                showMessage(`Profile ${enable ? 'enabled' : 'disabled'} successfully`, 'success');
                await loadProfiles();
                // Apply filters (respecting current filter selections) and render
                await applyFilters();
            } catch (error) {
                console.error('Error toggling profile:', error);
                showMessage(error.message, 'error');
            }
        }

        async function deleteProfile(id, name) {
            if (!confirm(`Are you sure you want to delete profile "${name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/profiles/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    let errorMsg = 'Failed to delete profile';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMsg = error.error || errorMsg;
                        } else {
                            errorMsg = await response.text() || errorMsg;
                        }
                    } catch {}
                    throw new Error(errorMsg);
                }

                showMessage('Profile deleted successfully', 'success');
                await loadProfiles();
                // Apply filters (respecting current filter selections) and render
                await applyFilters();
            } catch (error) {
                console.error('Error deleting profile:', error);
                showMessage(error.message, 'error');
            }
        }

        async function exportProfileToml(id) {
            try {
                const response = await fetch(`${API_BASE}/api/profiles/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    showMessage('Failed to load profile', 'error');
                    return;
                }

                const profile = await response.json();

                // Fetch jobs associated with this profile
                let profileJobs = [];
                try {
                    const jobsResponse = await fetch(`${API_BASE}/api/jobs`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (jobsResponse.ok) {
                        const allJobs = await jobsResponse.json();
                        profileJobs = allJobs.filter(j => j.profileId === id);
                    }
                } catch (e) {
                    // Continue without jobs if fetch fails
                }

                // Generate TOML content
                const toml = generateProfileToml(profile, profileJobs);

                // Create and download file
                const blob = new Blob([toml], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sanitizeFilename(profile.name)}.toml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showMessage('Profile exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting profile:', error);
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        function generateProfileToml(profile, profileJobs = []) {
            // Escape TOML string values
            const escapeToml = (str) => {
                if (!str) return '""';
                // Use triple-quoted strings for multiline content
                if (str.includes('\n')) {
                    return `"""\n${str}\n"""`;
                }
                // Escape quotes in single-line strings
                return `"${str.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"`;
            };

            const lines = [];
            lines.push('# Reef Profile Export');
            lines.push(`# Exported: ${new Date().toISOString()}`);
            lines.push('');

            // Profile identity
            lines.push('[profile]');
            lines.push(`name = ${escapeToml(profile.name)}`);
            lines.push(`connection_id = ${profile.connectionId}`);
            if (profile.connectionName) {
                lines.push(`connection_name = ${escapeToml(profile.connectionName)}`);
            }
            if (profile.groupId) {
                lines.push(`group_id = ${profile.groupId}`);
                if (profile.groupName) {
                    lines.push(`group_name = ${escapeToml(profile.groupName)}`);
                }
            }
            lines.push(`output_format = "${profile.outputFormat}"`);
            if (profile.templateId) {
                lines.push(`template_id = ${profile.templateId}`);
                if (profile.templateName) {
                    lines.push(`template_name = ${escapeToml(profile.templateName)}`);
                }
            }
            if (profile.outputDestinationId) {
                lines.push(`output_destination_id = ${profile.outputDestinationId}`);
                if (profile.outputDestinationName) {
                    lines.push(`output_destination_name = ${escapeToml(profile.outputDestinationName)}`);
                }
            }
            lines.push(`is_enabled = ${profile.isEnabled}`);

            // Query
            lines.push('');
            lines.push('[query]');
            lines.push(`sql = ${escapeToml(profile.query)}`);

            // Pre-processing
            if (profile.preProcessType) {
                lines.push('');
                lines.push('[pre_processing]');
                lines.push(`type = "${profile.preProcessType}"`);
                if (profile.preProcessConfig) {
                    lines.push(`config = ${escapeToml(profile.preProcessConfig)}`);
                }
                lines.push(`rollback_on_failure = ${profile.preProcessRollbackOnFailure !== false}`);
            }

            // Post-processing
            if (profile.postProcessType) {
                lines.push('');
                lines.push('[post_processing]');
                lines.push(`type = "${profile.postProcessType}"`);
                if (profile.postProcessConfig) {
                    lines.push(`config = ${escapeToml(profile.postProcessConfig)}`);
                }
                lines.push(`skip_on_failure = ${profile.postProcessSkipOnFailure !== false}`);
                lines.push(`run_on_zero_rows = ${profile.postProcessOnZeroRows === true}`);
            }

            // Delta Sync
            if (profile.deltaSyncEnabled) {
                lines.push('');
                lines.push('[delta_sync]');
                lines.push(`enabled = ${profile.deltaSyncEnabled}`);
                if (profile.deltaSyncReefIdColumn) {
                    lines.push(`reef_id_column = ${escapeToml(profile.deltaSyncReefIdColumn)}`);
                }
                if (profile.deltaSyncHashAlgorithm) {
                    lines.push(`hash_algorithm = "${profile.deltaSyncHashAlgorithm}"`);
                }
                if (profile.deltaSyncDuplicateStrategy) {
                    lines.push(`duplicate_strategy = "${profile.deltaSyncDuplicateStrategy}"`);
                }
                if (profile.deltaSyncNullStrategy) {
                    lines.push(`null_strategy = "${profile.deltaSyncNullStrategy}"`);
                }
                if (profile.deltaSyncNumericPrecision !== undefined) {
                    lines.push(`numeric_precision = ${profile.deltaSyncNumericPrecision}`);
                }
                if (profile.deltaSyncTrackDeletes !== undefined) {
                    lines.push(`track_deletes = ${profile.deltaSyncTrackDeletes}`);
                }
                if (profile.excludeReefIdFromOutput !== undefined) {
                    lines.push(`exclude_reef_id_from_output = ${profile.excludeReefIdFromOutput}`);
                }
            }

            // Split Output
            if (profile.splitEnabled) {
                lines.push('');
                lines.push('[split_output]');
                lines.push(`enabled = ${profile.splitEnabled}`);
                if (profile.splitKeyColumn) {
                    lines.push(`key_column = ${escapeToml(profile.splitKeyColumn)}`);
                }
                if (profile.splitFilenameTemplate) {
                    lines.push(`filename_template = ${escapeToml(profile.splitFilenameTemplate)}`);
                }
                if (profile.splitBatchSize !== undefined) {
                    lines.push(`batch_size = ${profile.splitBatchSize}`);
                }
                if (profile.excludeSplitKeyFromOutput !== undefined) {
                    lines.push(`exclude_split_key_from_output = ${profile.excludeSplitKeyFromOutput}`);
                }
            }

            // Email Export
            if (profile.isEmailExport) {
                lines.push('');
                lines.push('[email_export]');
                lines.push(`enabled = ${profile.isEmailExport}`);
                if (profile.emailTemplateId) {
                    lines.push(`template_id = ${profile.emailTemplateId}`);
                    if (profile.emailTemplateName) {
                        lines.push(`template_name = ${escapeToml(profile.emailTemplateName)}`);
                    }
                }
                if (profile.useHardcodedRecipients && profile.emailRecipientsHardcoded) {
                    lines.push(`recipients_hardcoded = ${escapeToml(profile.emailRecipientsHardcoded)}`);
                } else if (profile.emailRecipientsColumn) {
                    lines.push(`recipients_column = ${escapeToml(profile.emailRecipientsColumn)}`);
                }
                if (profile.useHardcodedCc && profile.emailCcHardcoded) {
                    lines.push(`cc_hardcoded = ${escapeToml(profile.emailCcHardcoded)}`);
                } else if (profile.emailCcColumn) {
                    lines.push(`cc_column = ${escapeToml(profile.emailCcColumn)}`);
                }
                if (profile.useHardcodedSubject && profile.emailSubjectHardcoded) {
                    lines.push(`subject_hardcoded = ${escapeToml(profile.emailSubjectHardcoded)}`);
                } else if (profile.emailSubjectColumn) {
                    lines.push(`subject_column = ${escapeToml(profile.emailSubjectColumn)}`);
                }
                lines.push(`success_threshold_percent = ${profile.emailSuccessThresholdPercent}`);
            }

            // Jobs
            if (profileJobs && profileJobs.length > 0) {
                lines.push('');
                profileJobs.forEach((job) => {
                    lines.push('[[job]]');
                    lines.push(`name = ${escapeToml(job.name)}`);
                    lines.push(`is_enabled = ${job.isEnabled}`);
                    if (job.cronExpression) {
                        lines.push(`cron = ${escapeToml(job.cronExpression)}`);
                    }
                    if (job.priority !== undefined) {
                        const priorityNames = ['Low', 'Normal', 'High', 'Critical'];
                        lines.push(`priority = "${priorityNames[job.priority] || 'Normal'}"`);
                    }
                    if (job.tags && job.tags.length > 0) {
                        lines.push(`tags = [${job.tags.map(t => `"${t}"`).join(', ')}]`);
                    }
                });
            }

            return lines.join('\n');
        }

        function sanitizeFilename(name) {
            return name.replace(/[^a-z0-9_-]/gi, '_').toLowerCase();
        }

        // ========================================================
        // START: Webhook Management Functions
        // ========================================================

        let currentProfileWebhooks = [];

        // Load webhooks for current profile
        async function loadWebhooks(profileId) {
            try {
                const response = await fetch(`${API_BASE}/api/webhooks?profileId=${profileId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    currentProfileWebhooks = await response.json();
                    renderWebhooks();
                } else {
                    currentProfileWebhooks = [];
                    renderWebhooks();
                }
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showMessage('Error loading webhooks', 'error');
            }
        }

        // Render webhooks list
        function renderWebhooks() {
            const container = document.getElementById('webhooksList');
            
            if (currentProfileWebhooks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-500">
                        <i data-lucide="link-2-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                        <p>No webhooks configured for this profile</p>
                        <p class="text-sm mt-1">Click "Create Webhook" to add one</p>
                    </div>
                `;
                queueLucideRender();
                return;
            }
            
            container.innerHTML = '';
            
            currentProfileWebhooks.forEach(webhook => {
                const webhookCard = document.createElement('div');
                webhookCard.className = 'border rounded-lg p-4 ' + (webhook.isActive ? 'bg-white' : 'bg-gray-50');
                
                const statusColor = webhook.isActive ? 'text-green-600' : 'text-gray-400';
                const statusText = webhook.isActive ? 'Active' : 'Inactive';
                
                const lastTriggered = webhook.lastTriggeredAt 
                    ? `Last triggered: ${new Date(webhook.lastTriggeredAt).toLocaleString()}` 
                    : 'Never triggered';
                
                webhookCard.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${webhook.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${statusText}
                                </span>
                                <span class="text-sm text-gray-500">Triggered ${webhook.triggerCount} times</span>
                            </div>
                            <div class="flex items-center space-x-2 mb-2">
                                <code class="flex-1 px-3 py-2 bg-gray-100 rounded text-xs font-mono text-gray-700 overflow-x-auto">
                                    ${window.location.origin}/webhooks/${webhook.token}
                                </code>
                                <button onclick="copyWebhookUrl('${webhook.token}')" class="p-2 text-gray-400 hover:text-gray-600">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">${lastTriggered}</p>
                        </div>
                        <div class="ml-4 flex flex-col space-y-1">
                            <button onclick="toggleWebhook(${webhook.id}, ${webhook.isActive})" 
                                    class="p-2 text-gray-400 hover:text-gray-600" 
                                    data-tooltip="${webhook.isActive ? 'Disable' : 'Enable'}">
                                <i data-lucide="${webhook.isActive ? 'pause-circle' : 'play-circle'}" class="w-4 h-4"></i>
                            </button>
                            <button onclick="regenerateWebhookToken(${webhook.id})" 
                                    class="p-2 text-yellow-400 hover:text-yellow-600" 
                                    data-tooltip="Regenerate Token">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                            <button onclick="testWebhook('${webhook.token}')" 
                                    class="p-2 text-blue-400 hover:text-blue-600" 
                                    data-tooltip="Test Webhook">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteWebhook(${webhook.id})" 
                                    class="p-2 text-red-400 hover:text-red-600" 
                                    data-tooltip="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(webhookCard);
            });
            
            queueLucideRender();
        }

        // Create webhook
        async function createWebhook() {
            const profileId = document.getElementById('profile-id').value;
            if (!profileId) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/webhooks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ profileId: parseInt(profileId) })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage('Webhook created successfully!', 'success');
                    
                    // Show token in a modal (this is the only time they'll see it)
                    showWebhookTokenModal(data.token, data.url);
                    
                    await loadWebhooks(profileId);
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Error creating webhook', 'error');
                }
            } catch (error) {
                showMessage('Error creating webhook', 'error');
            }
        }

        // Copy webhook URL to clipboard
        async function copyWebhookUrl(token) {
            const url = `${window.location.origin}/webhooks/${token}`;
            const success = await window.copyToClipboard(url);
            if (success) {
                showMessage('Webhook URL copied to clipboard', 'success');
            } else {
                showMessage('Failed to copy URL', 'error');
            }
        }

        // Toggle webhook active status
        async function toggleWebhook(webhookId, isActive) {
            const action = isActive ? 'disable' : 'enable';
            
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/${webhookId}/${action}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage(`Webhook ${action}d successfully`, 'success');
                    const profileId = document.getElementById('profile-id').value;
                    await loadWebhooks(profileId);
                } else {
                    showMessage(`Error ${action}ing webhook`, 'error');
                }
            } catch (error) {
                showMessage(`Error ${action}ing webhook`, 'error');
            }
        }

        // Regenerate webhook token
        async function regenerateWebhookToken(webhookId) {
            if (!confirm('Are you sure you want to regenerate the token? The old token will stop working immediately.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/${webhookId}/regenerate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage('Token regenerated successfully', 'success');
                    showWebhookTokenModal(data.token, data.url);
                    
                    const profileId = document.getElementById('profile-id').value;
                    await loadWebhooks(profileId);
                } else {
                    showMessage('Error regenerating token', 'error');
                }
            } catch (error) {
                showMessage('Error regenerating token', 'error');
            }
        }

        // Delete webhook
        async function deleteWebhook(webhookId) {
            if (!confirm('Are you sure you want to delete this webhook?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/${webhookId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage('Webhook deleted successfully', 'success');
                    const profileId = document.getElementById('profile-id').value;
                    await loadWebhooks(profileId);
                } else {
                    showMessage('Error deleting webhook', 'error');
                }
            } catch (error) {
                showMessage('Error deleting webhook', 'error');
            }
        }

        // Test webhook
        function testWebhook(token) {
            const url = `${window.location.origin}/webhooks/${token}`;
            const curlCommand = `curl -X POST "${url}" \\
  -H "Content-Type: application/json" \\
  -d '{"parameters": {"key": "value"}}'`;
            
            const modal = `
                <div id="testWebhookModal" class="fixed z-[60] inset-0 overflow-y-auto">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeTestWebhookModal()"></div>
                        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full relative">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">Test Webhook</h3>
                                    <button onclick="closeTestWebhookModal()" class="text-gray-400 hover:text-gray-500">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">Use this curl command to test the webhook:</p>
                                <div class="relative">
                                    <pre class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto"><code>${curlCommand}</code></pre>
                                    <button onclick="window.copyToClipboard(\`${curlCommand.replace(/`/g, '\\`')}\`).then(ok => showMessage(ok ? 'Command copied!' : 'Failed to copy', ok ? 'success' : 'error'));"
                                            class="absolute top-2 right-2 p-2 bg-gray-800 hover:bg-gray-700 rounded text-white">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-4">
                                    <strong>Tip:</strong> You can send parameters in the JSON body to use in your query.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            queueLucideRender();
        }

        function closeTestWebhookModal() {
            const modal = document.getElementById('testWebhookModal');
            if (modal) modal.remove();
        }

        // Use global copyToClipboard from main.js (HTTP/HTTPS compatible)

        // Show webhook token modal (only shown once after creation/regeneration)
        function showWebhookTokenModal(token, url) {
            const modal = `
                <div id="webhookTokenModal" class="fixed z-[60] inset-0 overflow-y-auto">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeWebhookTokenModal()"></div>
                        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full relative">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                                <div class="sm:flex sm:items-start">
                                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                        <i data-lucide="key" class="w-6 h-6 text-blue-600"></i>
                                    </div>
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">
                                            Your webhook is online now!
                                        </h3>
                                        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4">
                                            <div class="flex">
                                                <div class="flex-shrink-0">
                                                    <i data-lucide="alert-triangle" class="h-5 w-5 text-blue-400"></i>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm text-blue-700 font-medium pr-4">
                                                        Go ahead and save this URL, you won’t be able to view the full token later!
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label class="block text-xs font-medium text-gray-700 mb-2">Webhook URL:</label>
                                            <div class="flex items-center space-x-2 bg-gray-50 border border-gray-200 rounded p-2">
                                                <code class="flex-1 text-xs font-mono text-gray-800 break-all">
                                                    ${url}
                                                </code>
                                                <button onclick="window.copyToClipboard('${url}').then(ok => showMessage(ok ? 'URL copied!' : 'Failed to copy', ok ? 'success' : 'error'));" class="flex-shrink-0 p-2 text-blue-600 hover:bg-blue-100 rounded transition-colors" data-tooltip="Copy URL">
                                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button onclick="closeWebhookTokenModal()" 
                                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                    <i data-lucide="check" class="w-4 h-4 mr-2"></i>
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            queueLucideRender();
        }

        function closeWebhookTokenModal() {
            const modal = document.getElementById('webhookTokenModal');
            if (modal) modal.remove();
        }

        // ========================================================
        // END: Webhook Management Functions
        // ========================================================

        // ========================================================
        // START: Delta Sync Management Functions
        // ========================================================

        function toggleDeltaSyncFields() {
            const enabled = document.getElementById('deltaSyncEnabled').checked;
            const fields = document.getElementById('deltaSyncFields');
            const icon = document.getElementById('deltaSyncToggleIcon');
            
            if (enabled) {
                fields.classList.remove('opacity-50', 'pointer-events-none');
                icon.setAttribute('data-lucide', 'toggle-right');
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-blue-600');
            } else {
                fields.classList.add('opacity-50', 'pointer-events-none');
                icon.setAttribute('data-lucide', 'toggle-left');
                icon.classList.remove('text-blue-600');
                icon.classList.add('text-gray-400');
            }
            
            queueLucideRender();
        }

        function toggleSplitFields() {
            const splitEnabled = document.getElementById('splitEnabled').checked;
            const splitFields = document.getElementById('splitFields');
            const nonSplitFields = document.getElementById('nonSplitFields');
            const emailGroupingOption = document.getElementById('emailGroupingOption');
            const isEmailExport = document.getElementById('isEmailExport').checked;

            if (splitEnabled) {
                splitFields.classList.remove('opacity-50', 'pointer-events-none');
                nonSplitFields.style.display = 'none';
                
                // Show email grouping option only for email export profiles
                if (isEmailExport && emailGroupingOption) {
                    emailGroupingOption.classList.remove('hidden');
                }
            } else {
                splitFields.classList.add('opacity-50', 'pointer-events-none');
                nonSplitFields.style.display = 'block';
                
                // Hide email grouping option when split is disabled
                if (emailGroupingOption) {
                    emailGroupingOption.classList.add('hidden');
                }
            }
        }

        function toggleDeltaSyncAdvanced() {
            const panel = document.getElementById('deltaSyncAdvanced');
            const chevron = document.getElementById('deltaSyncAdvancedChevron');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                panel.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function loadDeltaSyncStats(profileId) {
            if (!profileId) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/delta-sync/stats`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    displayDeltaSyncStats(stats);
                } else {
                    console.warn('Failed to load delta sync stats');
                }
            } catch (error) {
                console.error('Error loading delta sync stats:', error);
            }
        }

        function displayDeltaSyncStats(stats) {
            document.getElementById('statTotalRows').textContent = stats.totalTrackedRows?.toLocaleString() || '0';
            
            if (stats.lastSyncDate) {
                const date = new Date(stats.lastSyncDate);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let timeAgo;
                if (diffMins < 1) timeAgo = 'Just now';
                else if (diffMins < 60) timeAgo = `${diffMins}m ago`;
                else if (diffHours < 24) timeAgo = `${diffHours}h ago`;
                else timeAgo = `${diffDays}d ago`;
                
                document.getElementById('statLastSync').textContent = timeAgo;
            } else {
                document.getElementById('statLastSync').textContent = 'Never';
            }
            
            document.getElementById('statNewRows').textContent = stats.newRowsLastRun?.toLocaleString() || '0';
            document.getElementById('statChangedRows').textContent = stats.changedRowsLastRun?.toLocaleString() || '0';
        }

        async function refreshDeltaSyncStats() {
            const profileId = document.getElementById('profile-id').value;
            if (profileId) {
                await loadDeltaSyncStats(profileId);
            }
        }

        function toggleDeltaSyncAdvancedSettings() {
            const content = document.getElementById('deltaSyncAdvancedContent');
            const chevron = document.getElementById('advancedSettingsChevron');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function generateDeltaSyncHashes() {
            const profileId = document.getElementById('profile-id').value;
            if (!profileId) {
                showToast('Profile must be saved first', 'error');
                return;
            }

            const profileName = document.getElementById('profile-name').value;

            if (!confirm(`Generate hash baseline for "${profileName}"?\n\nThis will:\n• Execute your query\n• Create hashes for all current rows\n• Establish baseline for future syncs\n• Only new/updated rows will sync next time\n\nNo changes will be sent during this operation.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/delta-sync/generate-hashes`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(`Hash baseline generated for ${result.rowsProcessed || 0} rows`, 'success');
                    await loadDeltaSyncStats(profileId);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate hashes');
                }
            } catch (error) {
                console.error('Error generating delta sync hashes:', error);
                showToast(error.message, 'error');
            }
        }

        async function resetDeltaSyncFull() {
            const profileId = document.getElementById('profile-id').value;
            if (!profileId) return;
            
            const profileName = document.getElementById('profile-name').value;
            
            if (!confirm(`Reset all delta sync state for "${profileName}"?\n\nThis will:\n• Delete all tracked row hashes\n• Clear sync history\n• Treat all rows as NEW on next execution\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/delta-sync/reset`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    showToast('Delta sync state reset successfully', 'success');
                    await loadDeltaSyncStats(profileId);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset delta sync state');
                }
            } catch (error) {
                console.error('Error resetting delta sync:', error);
                showToast(error.message, 'error');
            }
        }

        function showResetRowsModal() {
            const profileId = document.getElementById('profile-id').value;
            const profileName = document.getElementById('profile-name').value;
            
            const modal = `
                <div id="resetRowsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Reset Specific Rows</h3>
                            <button onclick="closeResetRowsModal()" class="text-gray-400 hover:text-gray-500">
                                <i data-lucide="x" class="h-6 w-6"></i>
                            </button>
                        </div>

                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-3">
                                Reset delta sync state for specific rows by providing ReefId values or date criteria.
                            </p>
                        </div>

                        <div class="space-y-4">
                            <!-- Reset by ReefIds -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i>
                                    Reset by ReefIds
                                </label>
                                <textarea id="resetReefIds" rows="4" placeholder="Enter ReefId values (one per line or comma-separated)&#10;Example:&#10;12345&#10;67890&#10;or: 12345, 67890, 99999"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-mono"></textarea>
                                <p class="mt-1 text-xs text-gray-500">Paste ReefId values to reset</p>
                            </div>

                            <div class="relative">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">OR</span>
                                </div>
                            </div>

                            <!-- Reset by Date Criteria -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                    Reset by Date Range
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">After Date</label>
                                        <input type="datetime-local" id="resetAfterDate"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Before Date</label>
                                        <input type="datetime-local" id="resetBeforeDate"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    </div>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">Reset rows last synced within this date range</p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button onclick="closeResetRowsModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="executeResetRows()"
                                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 flex items-center">
                                <i data-lucide="rotate-ccw" class="h-4 w-4 mr-2"></i>
                                Reset Rows
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            queueLucideRender();
        }

        function closeResetRowsModal() {
            const modal = document.getElementById('resetRowsModal');
            if (modal) modal.remove();
        }

        async function executeResetRows() {
            const profileId = document.getElementById('profile-id').value;
            const reefIdsText = document.getElementById('resetReefIds').value.trim();
            const afterDate = document.getElementById('resetAfterDate').value;
            const beforeDate = document.getElementById('resetBeforeDate').value;
            
            // Parse ReefIds
            let reefIds = null;
            if (reefIdsText) {
                // Split by newlines or commas, trim whitespace, filter empty
                reefIds = reefIdsText.split(/[\n,]+/)
                    .map(id => id.trim())
                    .filter(id => id.length > 0);
                
                if (reefIds.length === 0) reefIds = null;
            }
            
            // Build criteria object
            const criteria = {};
            if (afterDate) criteria.afterDate = new Date(afterDate).toISOString();
            if (beforeDate) criteria.beforeDate = new Date(beforeDate).toISOString();
            
            // Validate that at least one method is provided
            if (!reefIds && Object.keys(criteria).length === 0) {
                showMessage('Please provide ReefIds or date criteria', 'error');
                return;
            }
            
            const payload = {
                reefIds: reefIds,
                criteria: Object.keys(criteria).length > 0 ? criteria : null
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/delta-sync/reset-rows`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message, 'success');
                    closeResetRowsModal();
                    await loadDeltaSyncStats(profileId);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset rows');
                }
            } catch (error) {
                console.error('Error resetting rows:', error);
                showToast(error.message, 'error');
            }
        }

        // ========================================================
        // END: Delta Sync Management Functions
        // ========================================================

        function showToast(message, type = 'info', persistent = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `flex items-center px-4 py-3 mb-2 rounded shadow text-white ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
            toast.innerHTML = `<span class="flex-1">${message}</span><button class="ml-4 text-white opacity-70 hover:opacity-100" onclick="this.parentElement.remove()">&times;</button>`;
            toastContainer.appendChild(toast);
            if (!persistent) setTimeout(() => toast.remove(), 6000);
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const bgColor = type === 'success' ? 'bg-green-50 border-green-400 text-green-800' : 'bg-red-50 border-red-400 text-red-800';
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';

            container.innerHTML = `
                <div class="${bgColor} border-l-4 p-4 mb-4 rounded" role="alert">
                    <div class="flex items-center">
                        <i data-lucide="${icon}" class="h-5 w-5 mr-2"></i>
                        <p class="font-medium">${message}</p>
                    </div>
                </div>
            `;
            queueLucideRender();

            setTimeout(() => container.innerHTML = '', 5000);
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Never';
            let date;
            try {
                // If already ends with Z or has timezone, don't add Z
                if (/Z$|[+-]\d{2}:?\d{2}$/.test(dateString)) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString + 'Z');
                }
                if (isNaN(date.getTime())) return 'Never';
                return date.toLocaleString();
            } catch {
                return 'Never';
            }
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return null;
            let date;
            try {
                // If already ends with Z or has timezone, don't add Z
                if (/Z$|[+-]\d{2}:?\d{2}$/.test(dateString)) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString + 'Z');
                }
                if (isNaN(date.getTime())) return null;
            } catch {
                return null;
            }

            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;

            return null; // Fall back to full date for older dates
        }

        let userMenuExpanded = false;

        // Toggle user menu
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            const chevron = document.getElementById('chevron-icon');
            userMenuExpanded = !userMenuExpanded;
            
            if (userMenuExpanded) {
                menu.classList.remove('user-menu-collapsed');
                menu.classList.add('user-menu-expanded');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                menu.classList.remove('user-menu-expanded');
                menu.classList.add('user-menu-collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
            
            // Re-render icons after DOM update
            setTimeout(() => queueLucideRender(), 50);
        }

        function logout() {
            clearAuth();
            redirectToLogin();
        }

        // Email HTML Preview Functions
        function closeEmailPreviewModal() {
            document.getElementById('email-preview-modal').classList.add('hidden');
        }

        function downloadEmailPreview() {
            const content = document.getElementById('preview-html-content').innerHTML;
            const blob = new Blob([content], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `email-preview-${new Date().toISOString().split('T')[0]}.html`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Query Results Preview Functions
        function closeQueryResultsModal() {
            document.getElementById('query-results-modal').classList.add('hidden');
        }

        async function testQueryInModal() {
            const btn = document.getElementById('test-query-btn');
            const spinner = document.getElementById('test-query-spinner');
            const btnText = document.getElementById('test-query-btn-text');

            if (btn && spinner && btnText) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                btnText.textContent = 'Testing...';
            }

            // Hide delta UI elements until we know if this run uses delta mode
            document.getElementById('query-results-delta-summary').classList.add('hidden');
            document.getElementById('query-results-delta-legend').classList.add('hidden');

            try {
                const connectionId = parseInt(document.getElementById('profile-connection').value);
                const query = document.getElementById('profile-query').value;
                const profileId = document.getElementById('profile-id')?.value;
                const deltaEnabled = document.getElementById('deltaSyncEnabled')?.checked;

                if (!connectionId || isNaN(connectionId)) {
                    showToast('Please select a connection', 'error');
                    return;
                }

                if (!query || query.trim() === '') {
                    showToast('Please enter a query', 'error');
                    return;
                }

                // Open results modal
                document.getElementById('query-results-modal').classList.remove('hidden');

                // Reset content to loading state
                document.getElementById('query-results-content').innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                        <span class="ml-3 text-gray-600">Executing query...</span>
                    </div>
                `;

                // Use delta endpoint when the saved profile has Smart Sync enabled
                const useDelta = profileId && parseInt(profileId) > 0 && deltaEnabled;
                let response;

                if (useDelta) {
                    response = await fetch(`${API_BASE}/api/profiles/${profileId}/test-query-delta`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
                } else {
                    response = await fetch(`${API_BASE}/api/profiles/test-query-preview`, {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ connectionId, query })
                    });
                }

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    document.getElementById('query-results-content').innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex">
                                <i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Query Error</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <pre class="whitespace-pre-wrap">${escapeHtml(result.error || 'Unknown error')}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    queueLucideRender();
                    showToast('Query test failed: ' + result.error, 'error');
                    return;
                }

                // Update header info
                document.getElementById('query-results-count').textContent = result.rowCount || 0;
                document.getElementById('query-results-time').textContent = `(${result.totalExecutionTimeMs}ms)`;

                // Show delta summary badges when applicable
                if (result.deltaEnabled && result.summary) {
                    const s = result.summary;
                    const summaryEl = document.getElementById('query-results-delta-summary');
                    summaryEl.innerHTML = [
                        s.newRows > 0
                            ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>${s.newRows} new</span>`
                            : '',
                        s.changedRows > 0
                            ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800"><span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>${s.changedRows} changed</span>`
                            : '',
                        s.unchangedRows > 0
                            ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600"><span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>${s.unchangedRows} unchanged</span>`
                            : '',
                        s.deletedRows > 0
                            ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>${s.deletedRows} deleted</span>`
                            : ''
                    ].filter(Boolean).join('');
                    summaryEl.classList.remove('hidden');
                    document.getElementById('query-results-delta-legend').classList.remove('hidden');
                }

                // Display results in table
                if (result.rowCount === 0) {
                    document.getElementById('query-results-content').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                            <div class="flex">
                                <i data-lucide="info" class="h-5 w-5 text-yellow-400"></i>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">Query executed successfully but returned no rows.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    queueLucideRender();
                } else {
                    const columns = result.columns || [];
                    const rows = result.rows || [];
                    const isDelta = !!result.deltaEnabled;

                    // Row background + status badge helpers
                    const rowBg = (status) => {
                        if (!isDelta) return '';
                        if (status === 'new') return 'bg-green-50';
                        if (status === 'changed') return 'bg-amber-50';
                        return '';
                    };
                    const statusBadge = (status) => {
                        if (status === 'new')
                            return '<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>New</span>';
                        if (status === 'changed')
                            return '<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800"><span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>Changed</span>';
                        return '<span class="text-gray-300 text-xs">—</span>';
                    };

                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        ${isDelta ? '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 whitespace-nowrap">Status</th>' : ''}
                                        ${columns.map(col => `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">${escapeHtml(col)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                    `;

                    rows.forEach((row, idx) => {
                        const status = row['_reefStatus'];
                        const bg = rowBg(status) || (idx % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                        tableHtml += `<tr class="${bg}">`;
                        if (isDelta) {
                            tableHtml += `<td class="px-3 py-2 border-r border-gray-200 whitespace-nowrap">${statusBadge(status)}</td>`;
                        }
                        columns.forEach(col => {
                            const value = row[col];
                            const displayValue = value === null || value === undefined
                                ? '<span class="text-gray-400 italic">null</span>'
                                : escapeHtml(String(value));
                            tableHtml += `<td class="px-4 py-2 text-sm text-gray-900 border-r border-gray-200">${displayValue}</td>`;
                        });
                        tableHtml += '</tr>';
                    });

                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    document.getElementById('query-results-content').innerHTML = tableHtml;
                }

                showToast(`Query test successful: ${result.rowCount} rows in ${result.totalExecutionTimeMs}ms`, 'success');

            } catch (error) {
                console.error('Error testing query:', error);
                showToast('Error testing query: ' + error.message, 'error');

                document.getElementById('query-results-content').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-md p-4">
                        <div class="flex">
                            <i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Error</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <pre class="whitespace-pre-wrap">${escapeHtml(error.message)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                queueLucideRender();
            } finally {
                if (btn && spinner && btnText) {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Test Query (25 rows)';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function previewEmailHtml() {
            const btn = document.getElementById('preview-email-btn');
            const spinner = document.getElementById('preview-email-spinner');
            const btnText = document.getElementById('preview-email-btn-text');
            const profileIdInput = document.getElementById('profile-id');

            if (!profileIdInput || !profileIdInput.value) {
                showToast('Please save the profile first before previewing', 'error');
                return;
            }

            const profileId = profileIdInput.value;

            if (btn && spinner && btnText) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                btnText.textContent = 'Generating Preview...';
            }

            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/preview-email-html`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Preview failed: ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to generate preview');
                }

                // Display the preview in the modal
                const previewContent = document.getElementById('preview-html-content');
                previewContent.innerHTML = data.html || '<p class="text-gray-500">No HTML content generated</p>';

                // Show the modal
                document.getElementById('email-preview-modal').classList.remove('hidden');

                // Update download button state
                document.getElementById('download-preview-btn').disabled = !data.html;

                if (data.message) {
                    showToast(data.message, 'success');
                }
            } catch (error) {
                console.error('Error previewing email:', error);
                showToast(`Preview error: ${error.message}`, 'error');
            } finally {
                if (btn && spinner && btnText) {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    btnText.textContent = 'Preview HTML';
                }
            }
        }

        // Attachment Functions
        function toggleAttachmentConfig() {
            const checkbox = document.getElementById('attachmentsEnabled');
            const configDiv = document.getElementById('attachmentConfig');
            if (checkbox && configDiv) {
                if (checkbox.checked) {
                    configDiv.classList.remove('hidden');
                } else {
                    configDiv.classList.add('hidden');
                }
            }
            // Update the hidden field with current attachment configuration
            saveAttachmentConfig();
        }

        function updateEmailAttachmentTemplateInfo() {
            const templateSelect = document.getElementById('emailAttachmentDocumentTemplateId');
            const infoElement = document.getElementById('emailAttachmentTemplateInfo');
            const filenameField = document.getElementById('emailAttachmentFilenameField');
            const selectedOption = templateSelect.options[templateSelect.selectedIndex];

            if (templateSelect.value) {
                const format = selectedOption.dataset.outputFormat || 'Unknown';
                const templateName = selectedOption.textContent;
                infoElement.innerHTML = `<span class="text-purple-600 font-medium">✓ Will generate ${format} attachment</span> using "${templateName}"`;
                
                // Show filename field and Generate Per Row option
                if (filenameField) {
                    filenameField.classList.remove('hidden');
                }
            } else {
                infoElement.innerHTML = 'No document template selected';
                
                // Hide filename field and Generate Per Row option
                if (filenameField) {
                    filenameField.classList.add('hidden');
                }
            }
        }

        function updateAttachmentColumnDropdowns() {
            const query = document.getElementById('query-text').value.trim();
            if (!query) {
                return; // No query to analyze
            }

            // Extract column names from the query (simple pattern for SELECT statements)
            const selectMatch = query.match(/SELECT\s+(.*?)\s+FROM/i);
            if (!selectMatch) {
                return;
            }

            const columnText = selectMatch[1];
            let columns = [];

            // Simple parsing: split by comma, handle "AS alias" and table.column syntax
            const parts = columnText.split(',').map(p => p.trim());
            for (const part of parts) {
                // Handle "alias" or "table.column AS alias"
                const asMatch = part.match(/(?:^|\s)(\w+)\s*$/);
                const tableColMatch = part.match(/(\w+)\.(\w+)(?:\s+AS\s+(\w+))?/i);

                if (asMatch) {
                    columns.push(asMatch[1]);
                } else if (tableColMatch) {
                    const alias = tableColMatch[3] || tableColMatch[2];
                    columns.push(alias);
                }
            }

            // Remove '*' if present
            columns = columns.filter(c => c !== '*');

            // Update dropdowns
            const contentSelect = document.getElementById('attachmentContentColumn');
            const filenameSelect = document.getElementById('attachmentFilenameColumn');

            if (contentSelect && filenameSelect) {
                const currentContent = contentSelect.value;
                const currentFilename = filenameSelect.value;

                contentSelect.innerHTML = '<option value="">-- Select binary content column --</option>';
                filenameSelect.innerHTML = '<option value="">-- Select filename column --</option>';

                for (const col of columns) {
                    const option1 = document.createElement('option');
                    option1.value = col;
                    option1.text = col;
                    if (col === currentContent) option1.selected = true;
                    contentSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = col;
                    option2.text = col;
                    if (col === currentFilename) option2.selected = true;
                    filenameSelect.appendChild(option2);
                }
            }
        }

        async function validateAttachmentConfig() {
            const profileIdInput = document.getElementById('profile-id');
            if (!profileIdInput || !profileIdInput.value) {
                showToast('Please save the profile first', 'error');
                return;
            }

            const profileId = profileIdInput.value;
            const enabled = document.getElementById('attachmentsEnabled').checked;
            
            if (!enabled) {
                showToast('Attachments are not enabled', 'error');
                return;
            }

            // Check if using document template mode
            const docTemplateId = document.getElementById('emailAttachmentDocumentTemplateId').value;
            const dedup = document.getElementById('attachmentDeduplication').value;
            const failsafe = document.getElementById('attachmentFailsafe').value;
            const maxCount = parseInt(document.getElementById('attachmentMaxCount').value) || 50;

            let config;

            if (docTemplateId) {
                // Document template mode
                config = {
                    Enabled: true,
                    Mode: 'DocumentTemplate',
                    DocumentTemplate: {
                        TemplateId: parseInt(docTemplateId),
                        FilenameColumnName: document.getElementById('emailAttachmentFilenameColumn').value || null
                    },
                    Deduplication: dedup,
                    Failsafe: failsafe,
                    MaxAttachmentsPerEmail: maxCount,
                    MissingFileStrategy: 'Skip'
                };
            } else {
                // Binary mode
                const contentColumn = document.getElementById('attachmentContentColumn').value;
                const filenameColumn = document.getElementById('attachmentFilenameColumn').value;

                if (!contentColumn || !filenameColumn) {
                    showToast('Both content and filename columns are required for Binary mode', 'error');
                    return;
                }

                config = {
                    Enabled: true,
                    Mode: 'Binary',
                    Binary: {
                        ContentColumnName: contentColumn,
                        FilenameColumnName: filenameColumn
                    },
                    Deduplication: dedup,
                    Failsafe: failsafe,
                    MaxAttachmentsPerEmail: maxCount,
                    MissingFileStrategy: 'Skip'
                };
            }

            try {
                const response = await fetch(`${API_BASE}/api/profiles/${profileId}/validate-attachment-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                displayValidationResult(result);
            } catch (error) {
                showToast(`Validation failed: ${error.message}`, 'error');
            }
        }

        function displayValidationResult(result) {
            const resultDiv = document.getElementById('validationResult');
            resultDiv.innerHTML = '';
            resultDiv.classList.remove('hidden');

            if (result.errors && result.errors.length > 0) {
                const errSection = document.createElement('div');
                errSection.className = 'bg-red-50 border border-red-200 rounded p-3';
                const title = document.createElement('p');
                title.className = 'text-sm font-semibold text-red-800 mb-2';
                title.textContent = 'Errors:';
                errSection.appendChild(title);

                for (const err of result.errors) {
                    const item = document.createElement('p');
                    item.className = 'text-xs text-red-700 ml-2';
                    item.textContent = '• ' + err;
                    errSection.appendChild(item);
                }
                resultDiv.appendChild(errSection);
            }

            if (result.warnings && result.warnings.length > 0) {
                const warnSection = document.createElement('div');
                warnSection.className = 'bg-yellow-50 border border-yellow-200 rounded p-3';
                const title = document.createElement('p');
                title.className = 'text-sm font-semibold text-yellow-800 mb-2';
                title.textContent = 'Warnings:';
                warnSection.appendChild(title);

                for (const warn of result.warnings) {
                    const item = document.createElement('p');
                    item.className = 'text-xs text-yellow-700 ml-2';
                    item.textContent = '• ' + warn;
                    warnSection.appendChild(item);
                }
                resultDiv.appendChild(warnSection);
            }

            if (result.info && result.info.length > 0) {
                const infoSection = document.createElement('div');
                infoSection.className = 'bg-blue-50 border border-blue-200 rounded p-3';
                const title = document.createElement('p');
                title.className = 'text-sm font-semibold text-blue-800 mb-2';
                title.textContent = 'Information:';
                infoSection.appendChild(title);

                for (const info of result.info) {
                    const item = document.createElement('p');
                    item.className = 'text-xs text-blue-700 ml-2';
                    item.textContent = '✓ ' + info;
                    infoSection.appendChild(item);
                }
                resultDiv.appendChild(infoSection);
            }

            if (result.isValid) {
                showToast('Attachment configuration is valid!', 'success');
            }
        }

        function saveAttachmentConfig() {
            const enabledCheckbox = document.getElementById('attachmentsEnabled');
            const configField = document.getElementById('emailAttachmentConfig');
            
            // Safety check - these elements must exist
            if (!enabledCheckbox || !configField) {
                console.warn('Attachment config elements not found - skipping save');
                return;
            }
            
            const enabled = enabledCheckbox.checked;

            if (!enabled) {
                configField.value = '';
                return;
            }

            // Check if using document template mode
            const docTemplateIdElement = document.getElementById('emailAttachmentDocumentTemplateId');
            const docTemplateId = docTemplateIdElement ? docTemplateIdElement.value : null;
            
            if (docTemplateId) {
                // Document template mode - save config
                const filenameColumnElement = document.getElementById('emailAttachmentFilenameColumn');
                const generatePerRowElement = document.getElementById('emailAttachmentGeneratePerRow');
                const pageSizeElement = document.getElementById('emailAttachmentPageSize');
                const orientationElement = document.getElementById('emailAttachmentOrientation');
                const watermarkElement = document.getElementById('emailAttachmentWatermark');
                const dedupElement = document.getElementById('attachmentDeduplication');
                const failsafeElement = document.getElementById('attachmentFailsafe');
                const maxCountElement = document.getElementById('attachmentMaxCount');

                const config = {
                    Enabled: true,
                    Mode: 'DocumentTemplate',
                    DocumentTemplate: {
                        TemplateId: parseInt(docTemplateId),
                        FilenameColumnName: filenameColumnElement ? filenameColumnElement.value : null,
                        GeneratePerRow: generatePerRowElement ? generatePerRowElement.checked : false,
                        PageSize: pageSizeElement ? (pageSizeElement.value || 'A4') : 'A4',
                        Orientation: orientationElement ? (orientationElement.value || 'Portrait') : 'Portrait',
                        Watermark: watermarkElement ? (watermarkElement.value || null) : null
                    },
                    Deduplication: dedupElement ? (dedupElement.value || 'Auto') : 'Auto',
                    Failsafe: failsafeElement ? (failsafeElement.value || 'Disabled') : 'Disabled',
                    MaxAttachmentsPerEmail: maxCountElement ? (parseInt(maxCountElement.value) || 50) : 50,
                    MissingFileStrategy: 'Skip'
                };
                configField.value = JSON.stringify(config);
            } else {
                // Binary mode - only save if content and filename columns are provided
                const contentColumnElement = document.getElementById('attachmentContentColumn');
                const filenameColumnElement = document.getElementById('attachmentFilenameColumn');
                const dedupElement = document.getElementById('attachmentDeduplication');
                const failsafeElement = document.getElementById('attachmentFailsafe');
                const maxCountElement = document.getElementById('attachmentMaxCount');

                const contentColumn = contentColumnElement ? contentColumnElement.value : '';
                const filenameColumn = filenameColumnElement ? filenameColumnElement.value : '';

                // Only save Binary config if both columns are provided
                if (contentColumn && filenameColumn) {
                    const config = {
                        Enabled: true,
                        Mode: 'Binary',
                        Binary: {
                            ContentColumnName: contentColumn,
                            FilenameColumnName: filenameColumn
                        },
                        Deduplication: dedupElement ? (dedupElement.value || 'Auto') : 'Auto',
                        Failsafe: failsafeElement ? (failsafeElement.value || 'Disabled') : 'Disabled',
                        MaxAttachmentsPerEmail: maxCountElement ? (parseInt(maxCountElement.value) || 50) : 50,
                        MissingFileStrategy: 'Skip'
                    };
                    configField.value = JSON.stringify(config);
                } else {
                    // No valid configuration - clear the field
                    configField.value = '';
                }
            }
            
            // Update workflow hint after saving
            updateWorkflowHint();
        }
        
        // Show/hide workflow hint when both settings are enabled
        function updateWorkflowHint() {
            const emailGroupingCheckbox = document.getElementById('emailGroupBySplitKey');
            const generatePerRowCheckbox = document.getElementById('emailAttachmentGeneratePerRow');
            const hintElement = document.getElementById('emailGroupingHint');
            
            if (hintElement && emailGroupingCheckbox) {
                // Show hint only when emailGroupBySplitKey is enabled
                if (emailGroupingCheckbox.checked) {
                    hintElement.classList.remove('hidden');
                    
                    // Re-initialize lucide icons for the hint
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                } else {
                    hintElement.classList.add('hidden');
                }
            }
        }

        // Toggle handlers for hardcoded email addresses
        function setupEmailToggleHandlers() {
            const recipientsToggle = document.getElementById('recipientsToggle');
            const recipientsCheckbox = document.getElementById('useHardcodedRecipients');
            const recipientsColumnInput = document.getElementById('emailRecipientsColumn');
            const recipientsHardcodedInput = document.getElementById('emailRecipientsHardcoded');
            const recipientsMode = document.getElementById('recipientsMode');
            const recipientsHelp = document.getElementById('recipientsHelp');

            const ccToggle = document.getElementById('ccToggle');
            const ccCheckbox = document.getElementById('useHardcodedCc');
            const ccColumnInput = document.getElementById('emailCcColumn');
            const ccHardcodedInput = document.getElementById('emailCcHardcoded');
            const ccMode = document.getElementById('ccMode');
            const ccHelp = document.getElementById('ccHelp');

            const subjectToggle = document.getElementById('subjectToggle');
            const subjectCheckbox = document.getElementById('useHardcodedSubject');
            const subjectColumnInput = document.getElementById('emailSubjectColumn');
            const subjectHardcodedInput = document.getElementById('emailSubjectHardcoded');
            const subjectMode = document.getElementById('subjectMode');
            const subjectHelp = document.getElementById('subjectHelp');

            // Recipients toggle handler
            if (recipientsToggle) {
                recipientsToggle.addEventListener('click', function() {
                    const isChecked = !recipientsCheckbox.checked;
                    recipientsCheckbox.checked = isChecked;
                    updateRecipientsModeDisplay();
                });
            }

            // CC toggle handler
            if (ccToggle) {
                ccToggle.addEventListener('click', function() {
                    const isChecked = !ccCheckbox.checked;
                    ccCheckbox.checked = isChecked;
                    updateCcModeDisplay();
                });
            }

            // Subject toggle handler
            if (subjectToggle) {
                subjectToggle.addEventListener('click', function() {
                    const isChecked = !subjectCheckbox.checked;
                    subjectCheckbox.checked = isChecked;
                    updateSubjectModeDisplay();
                });
            }

            // Subject variables toggle handler
            const subjectVariablesToggle = document.getElementById('subjectVariablesToggle');
            const subjectVariablesPanel = document.getElementById('subjectVariablesPanel');
            if (subjectVariablesToggle) {
                subjectVariablesToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    subjectVariablesPanel.classList.toggle('hidden');
                    const icon = subjectVariablesToggle.querySelector('[data-lucide="chevron-down"]');
                    if (icon) {
                        icon.style.transform = subjectVariablesPanel.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                    }
                    queueLucideRender();
                });
            }

            function updateRecipientsModeDisplay() {
                const isHardcoded = recipientsCheckbox.checked;
                if (isHardcoded) {
                    recipientsColumnInput.style.display = 'none';
                    recipientsHardcodedInput.style.display = 'block';
                    recipientsHelp.textContent = 'Enter a hardcoded email address (e.g., recipient@example.com or Name;email@example.com)';
                    recipientsToggle.style.backgroundColor = '#3b82f6';
                    recipientsToggle.querySelector('span').style.transform = 'translateX(24px)';
                } else {
                    recipientsColumnInput.style.display = 'block';
                    recipientsHardcodedInput.style.display = 'none';
                    recipientsHelp.textContent = 'Column name from query that contains recipient email address (supports "Name;email@address.com" format)';
                    recipientsToggle.style.backgroundColor = '#d1d5db';
                    recipientsToggle.querySelector('span').style.transform = 'translateX(0)';
                }
            }

            function updateCcModeDisplay() {
                const isHardcoded = ccCheckbox.checked;
                if (isHardcoded) {
                    ccColumnInput.style.display = 'none';
                    ccHardcodedInput.style.display = 'block';
                    ccHelp.textContent = 'Enter a hardcoded email address (e.g., cc@example.com or Name;email@example.com)';
                    ccToggle.style.backgroundColor = '#3b82f6';
                    ccToggle.querySelector('span').style.transform = 'translateX(24px)';
                } else {
                    ccColumnInput.style.display = 'block';
                    ccHardcodedInput.style.display = 'none';
                    ccHelp.textContent = 'Column name from query that contains CC email address (supports "Name;email@address.com" format, optional)';
                    ccToggle.style.backgroundColor = '#d1d5db';
                    ccToggle.querySelector('span').style.transform = 'translateX(0)';
                }
            }

            function updateSubjectModeDisplay() {
                const isHardcoded = subjectCheckbox.checked;
                const variablesToggle = document.getElementById('subjectVariablesToggle');
                const variablesPanel = document.getElementById('subjectVariablesPanel');

                if (isHardcoded) {
                    subjectColumnInput.style.display = 'none';
                    subjectHardcodedInput.style.display = 'block';
                    subjectHelp.textContent = 'Enter hardcoded text with variable support (click "Variables" to see options)';
                    variablesToggle.style.display = 'flex';
                    subjectToggle.style.backgroundColor = '#3b82f6';
                    subjectToggle.querySelector('span').style.transform = 'translateX(24px)';
                } else {
                    subjectColumnInput.style.display = 'block';
                    subjectHardcodedInput.style.display = 'none';
                    subjectHelp.textContent = 'Column name from query that contains email subject. If not provided, will use profile name.';
                    variablesToggle.style.display = 'none';
                    variablesPanel.classList.add('hidden');
                    subjectToggle.style.backgroundColor = '#d1d5db';
                    subjectToggle.querySelector('span').style.transform = 'translateX(0)';
                }
            }

            // Store update functions globally for use in form operations
            window.updateRecipientsModeDisplay = updateRecipientsModeDisplay;
            window.updateCcModeDisplay = updateCcModeDisplay;
            window.updateSubjectModeDisplay = updateSubjectModeDisplay;
            // Store saveAttachmentConfig globally so form submit handler can call it
            window.saveAttachmentConfig = saveAttachmentConfig;
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Check if there's pending SQL from template import
            const pendingProfileSqlEncoded = sessionStorage.getItem('pendingProfileSql');
            const pendingTemplateName = sessionStorage.getItem('pendingTemplateName');
            let pendingProfileSql = null;

            if (pendingProfileSqlEncoded) {
                try {
                    // Decode base64 SQL
                    pendingProfileSql = decodeURIComponent(escape(atob(pendingProfileSqlEncoded)));
                } catch (error) {
                    console.error('Failed to decode pending SQL:', error);
                    showToast('Failed to decode SQL from template import', 'error');
                }
                // Clear the session storage immediately so it's not reused on refresh
                sessionStorage.removeItem('pendingProfileSql');
                sessionStorage.removeItem('pendingTemplateName');
            }

            setupEmailToggleHandlers();

            // Run init() and wait for it to complete before opening modal
            init().then(() => {
                if (pendingProfileSql) {
                    // Ensure dropdowns are populated before opening modal
                    const connectionSelect = document.getElementById('profile-connection');
                    const templateSelect = document.getElementById('template-id');
                    const destinationSelect = document.getElementById('destination-id');

                    // Check if dropdowns have been populated
                    if (connectionSelect && connectionSelect.children.length <= 1) {
                        console.warn('Connections not loaded yet, waiting...');
                        // Wait a bit longer for async data loading
                        setTimeout(() => openProfileWithSql(pendingProfileSql, pendingTemplateName), 500);
                    } else {
                        // Dropdowns are ready
                        openProfileWithSql(pendingProfileSql, pendingTemplateName);
                    }
                }
            }).catch((error) => {
                console.error('Error during init:', error);
            });
        });

        function openProfileWithSql(sqlText, templateName) {
            try {
                // Determine if this is an email profile based on template name
                const isEmailProfile = /\b(email|mail)\b/i.test(templateName || '');
                const profileType = isEmailProfile ? 'email' : 'standard';

                // Open the appropriate profile modal
                openAddProfileModal(profileType);

                // Pre-populate the SQL field
                const profileQueryTextarea = document.getElementById('profile-query');
                if (profileQueryTextarea) {
                    profileQueryTextarea.value = sqlText;

                    // Show a friendly, context-aware toast message
                    const profileTypeLabel = isEmailProfile ? 'email profile' : 'profile';
                    showToast(`All set! Your SQL query is ready. Just fill in the details to finish creating your ${profileTypeLabel}.`, 'success');

                    // Scroll to SQL field so user sees it's populated
                    setTimeout(() => {
                        profileQueryTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            } catch (error) {
                console.error('Error opening profile with SQL:', error);
                showToast('Error opening profile form', 'error');
            }
        }
    </script>
    <div id="toast-container" class="fixed top-4 right-4 z-[9999]"></div>
</body>
</html>