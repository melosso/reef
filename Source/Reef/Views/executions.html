<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executions &middot; Reef</title>
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="/assets/js/_tailwind.3.4.17.js"></script>
    <script src="/assets/js/_lucide.0.552.0.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/filter.js"></script>
    <script src="/assets/js/main.js"></script>
</head>
<body class="bg-slate-50">
    <script>
        requireAuth();
    </script>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:flex md:flex-col md:w-60 bg-slate-800 text-slate-300">
            <div class="flex items-center justify-left px-6 h-16 border-b border-slate-700">
                <i data-lucide="waves" class="h-6 w-6 stroke-blue-400/80"></i> 
                
                <div class="flex items-center ml-3 select-none mt-0.5">
                    <span class="text-slate-100 text-lg font-semibold font-inter tracking-tight">
                    Reef
                    </span>
                    <span class="ml-3 px-3 py-1 rounded border border-slate-700 text-slate-400 text-[10px] uppercase tracking-wide leading-none">
                    beta
                    </span>
                </div>
            </div>

            <nav class="flex-1 px-4 py-4">
                <a href="/dashboard" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                    <i data-lucide="layout-dashboard" class="h-5 w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Management</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/connections" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="plug" class="h-5 w-5"></i>
                            <span class="ml-3">Connections</span>
                        </a>
                        <a href="/destinations" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="send" class="h-5 w-5"></i>
                            <span class="ml-3">Destinations</span>
                        </a>
                        <a href="/templates" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="file-text" class="h-5 w-5"></i>
                            <span class="ml-3">Templates</span>
                        </a>
                        <a href="/groups" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="folder" class="h-5 w-5"></i>
                            <span class="ml-3">Groups</span>
                        </a>
                        <a href="/profiles" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="file-code" class="h-5 w-5"></i>
                            <span class="ml-3">Profiles</span>
                        </a>
                    </div>
                </div>
            
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Automation</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/jobs" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="briefcase" class="h-5 w-5"></i>
                            <span class="ml-3">Jobs</span>
                        </a>
                        <a href="/executions" class="flex items-center px-4 py-3 rounded-lg bg-slate-900 text-slate-100">
                            <i data-lucide="activity" class="h-5 w-5"></i>
                            <span class="ml-3">Executions</span>
                        </a>
                        <a href="/email-approvals" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="check-square" class="h-5 w-5"></i>
                            <span class="ml-3">Approvals</span>
                        </a>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Reference</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/documentation" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="book-open" class="h-5 w-5"></i>
                            <span class="ml-3">Documentation</span>
                        </a>
                    </div>
                </div>
            </nav>
            <!-- User Section with Expandable Menu -->
            <div class="border-t border-gray-700">
                <button onclick="toggleUserMenu()" class="w-full flex items-center justify-between p-4 hover:bg-gray-800 transition-colors">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                            <span id="user-initial" class="text-white font-bold text-lg">&nbsp;</span>
                        </div>
                        <div class="text-left">
                            <div id="username-display" class="text-white font-semibold">&nbsp;</div>
                            <div class="text-xs text-gray-400">View menu</div>
                        </div>
                    </div>
                    <i id="chevron-icon" data-lucide="chevron-up" class="h-4 w-4 text-gray-400 transition-transform"></i>
                </button>
                
                <!-- Expandable Menu -->
                <div id="user-menu" class="overflow-hidden user-menu-collapsed">
                    <div class="px-2 pb-2 space-y-1">
                        <a href="/admin" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="settings" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Settings</span>
                        </a>
                        <a href="https://github.com/melosso/reef" target="_blank" rel="noopener noreferrer" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="github" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">GitHub</span>
                            <i data-lucide="external-link" class="h-3 w-3 ml-auto"></i>
                        </a>
                        <button onclick="logout()" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-gray-800 text-gray-300 hover:text-white transition-colors">
                            <i data-lucide="log-out" class="h-4 w-4"></i>
                            <span class="ml-3 text-sm">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm z-10">
                <div class="flex items-center justify-between px-6 py-3">
                    <h1 class="text-2xl font-semibold text-gray-900 disable-select">Execution History</h1>
                    <div class="flex space-x-3">
                        <button onclick="refreshExecutions()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>
                            Refresh
                        </button>
                        <button onclick="openRunJobModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-lucide="play" class="h-4 w-4 mr-2"></i>
                            Run Job
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div id="message-container"></div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 h-4 w-4 text-gray-400"></i>
                            <input type="text"
                                   id="search-input"
                                   placeholder="Search by profile name, job name, or status..."
                                   onkeyup="applyFilters()"
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-semibold text-gray-700">Filters</h2>
                        <button onclick="clearAllFilters()" class="text-sm text-blue-600 hover:text-blue-700 font-medium" id="clear-filters-btn" style="display:none;">
                            Clear All
                        </button>
                    </div>
                    <div class="grid grid-cols-5 gap-4">
                        <div>
                            <label for="filter-profile" class="block text-sm font-medium text-gray-700 mb-1">Profile</label>
                            <select id="filter-profile" onchange="applyFilters()" class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">Show All</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-job" class="block text-sm font-medium text-gray-700 mb-1">Job</label>
                            <select id="filter-job" onchange="applyFilters()" class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">All Jobs</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">
                                Status
                            </label>
                            <select id="filter-status" onchange="applyFilters()" 
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 hover:border-gray-400">
                                <option value="" disabled selected hidden>Select status</option>
                                <option value="Success">Success</option>
                                <option value="Failed">Failed</option>
                                <option value="Running">Running</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-date-from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                            <input type="date" id="filter-date-from" onchange="applyFilters()" class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="filter-date-to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                            <input type="date" id="filter-date-to" onchange="applyFilters()" class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>

                <!-- Executions Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Profile</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Started</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pre</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Post</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rows</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Triggered By</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="executions-tbody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                    <i data-lucide="loader" class="h-5 w-5 inline animate-spin"></i>
                                    Loading executions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button onclick="previousPage()" id="mobile-prev" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Previous
                            </button>
                            <button onclick="nextPage()" id="mobile-next" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Next
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div class="flex items-center space-x-4">
                                <p class="text-sm text-gray-700">
                                    Showing <span id="showing-from" class="font-medium">1</span> to <span id="showing-to" class="font-medium">50</span> of <span id="total-count" class="font-medium">0</span> results
                                </p>
                                <div class="flex items-center space-x-2">
                                    <label for="page-size-select" class="text-sm text-gray-700">Per page:</label>
                                    <select id="page-size-select" onchange="changePageSize()" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination" id="pagination-controls">
                                    <!-- Pagination buttons will be rendered here -->
                <div class="mt-6">
                    <h3 class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider disable-select">Reference</h3>
                    <div class="mt-2 space-y-2">
                        <a href="/documentation" class="flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 hover:text-slate-100">
                            <i data-lucide="book-open" class="h-5 w-5"></i>
                            <span class="ml-3">Documentation</span>
                        </a>
                    </div>
                </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Execution Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Execution Details</h3>
                <div class="flex items-center space-x-2">
                    <button id="download-log-btn" title="Download Log" class="text-gray-400 hover:text-blue-600 focus:outline-none" style="display:none">
                        <i data-lucide="download" class="h-6 w-6"></i>
                    </button>
                    <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            
            <div id="execution-details" class="space-y-4">
                <!-- Details will be populated here -->
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeDetailsModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Test Profile Modal -->
    <div id="execute-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Test Profile</h3>
                <button onclick="closeExecuteModal()" class="text-gray-400 hover:text-gray-500">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <form id="execute-form">
                <div class="mb-4">
                    <label for="execute-profile" class="block text-sm font-medium text-gray-700 mb-2">Select Profile</label>
                    <select id="execute-profile" required class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Choose a profile...</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeExecuteModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Execute Now
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Run Job Modal -->
    <div id="run-job-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Run Job</h3>
                <button onclick="closeRunJobModal()" class="text-gray-400 hover:text-gray-500">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <form id="run-job-form">
                <div class="mb-4">
                    <label for="run-job-select" class="block text-sm font-medium text-gray-700 mb-2">Select Job</label>
                    <select id="run-job-select" required class="block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Choose a job...</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeRunJobModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Run Now
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        queueLucideRender();
    </script>
    <script>
        const API_BASE = window.location.origin;
        let executions = [];
        let profiles = [];
        let jobs = [];
        let autoRefreshInterval = null;
        let currentPage = 1;
        let pageSize = 25;
        let totalCount = 0;
        let totalPages = 0;

        // Helper function to safely parse dates with or without timezone info
        function parseDate(dateString) {
            if (!dateString) return null;

            // If the date already has timezone info (ends with Z or has +/- offset), use it as is
            if (dateString.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateString)) {
                return new Date(dateString);
            }

            // Otherwise, treat it as UTC by appending 'Z'
            return new Date(dateString + 'Z');
        }

        function saveExecutionFilters() {
            const filters = {
                profileId: document.getElementById('filter-profile').value,
                jobId: document.getElementById('filter-job').value,
                status: document.getElementById('filter-status').value,
                fromDate: document.getElementById('filter-date-from').value,
                toDate: document.getElementById('filter-date-to').value,
                searchTerm: document.getElementById('search-input').value
            };
            localStorage.setItem('executions_filters', JSON.stringify(filters));
        }

        function loadExecutionFilters() {
            const saved = localStorage.getItem('executions_filters');
            if (saved) {
                try {
                    const filters = JSON.parse(saved);
                    document.getElementById('filter-profile').value = filters.profileId || '';
                    document.getElementById('filter-job').value = filters.jobId || '';
                    document.getElementById('filter-status').value = filters.status || '';
                    document.getElementById('filter-date-from').value = filters.fromDate || '';
                    document.getElementById('filter-date-to').value = filters.toDate || '';
                    document.getElementById('search-input').value = filters.searchTerm || '';
                } catch (e) {
                    console.warn('Failed to load saved filters:', e);
                }
            }
        }

        async function init() {

            setUserSidebarInfo();
            queueLucideRender();
            await Promise.all([loadProfiles(), loadJobs()]);

            // Check for URL parameters and set filters
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('jobId');
            const profileId = urlParams.get('profileId');
            const executionId = urlParams.get('id');

            // Load saved filters first
            loadExecutionFilters();

            // URL parameters override saved filters
            if (jobId) {
                document.getElementById('filter-job').value = jobId;
            }
            if (profileId) {
                document.getElementById('filter-profile').value = profileId;
            }

            await loadExecutions();
            updateClearButtonVisibility();

            // If an execution ID was provided in the URL, open its details modal
            if (executionId) {
                await viewDetails(parseInt(executionId));
            }

            // Auto-refresh every 10 seconds for running executions
            autoRefreshInterval = setInterval(checkRunningExecutions, 10000);
        }

        async function loadExecutions() {
            try {
                const profileId = document.getElementById('filter-profile').value;
                const jobId = document.getElementById('filter-job').value;
                const status = document.getElementById('filter-status').value;
                const fromDate = document.getElementById('filter-date-from').value;
                const toDate = document.getElementById('filter-date-to').value;
                const searchTerm = document.getElementById('search-input').value;

                let url = `${API_BASE}/api/executions?page=${currentPage}&pageSize=${pageSize}`;
                if (profileId) url += `&profileId=${profileId}`;
                if (jobId) url += `&jobId=${jobId}`;
                if (status) url += `&status=${status}`;
                if (fromDate) url += `&fromDate=${fromDate}`;
                if (toDate) url += `&toDate=${toDate}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;

                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Failed to load executions');

                const result = await response.json();
                executions = result.data;
                totalCount = result.totalCount;
                currentPage = result.page;
                pageSize = result.pageSize;
                totalPages = result.totalPages;

                renderExecutions();
                renderPagination();
            } catch (error) {
                console.error('Error loading executions:', error);
                showMessage('Failed to load executions', 'error');
            }
        }

        async function loadProfiles() {
            try {
                const response = await fetch(`${API_BASE}/api/profiles`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    profiles = await response.json();
                    populateProfileFilters();
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        async function loadJobs() {
            try {
                const response = await fetch(`${API_BASE}/api/jobs`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    jobs = await response.json();
                    populateJobFilters();
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        function populateProfileFilters() {
            const filterSelect = document.getElementById('filter-profile');
            const executeSelect = document.getElementById('execute-profile');
            
            const profileOptions = profiles.map(p => 
                `<option value="${p.id}">${escapeHtml(p.name)}</option>`
            ).join('');

            filterSelect.innerHTML = '<option value="">Show All</option>' + profileOptions;
            executeSelect.innerHTML = '<option value="">Choose a profile...</option>' + profileOptions;
        }

        function populateJobFilters() {
            const filterSelect = document.getElementById('filter-job');
            const runJobSelect = document.getElementById('run-job-select');
            
            const jobOptions = jobs.map(j => 
                `<option value="${j.id}">${escapeHtml(j.name)}</option>`
            ).join('');

            filterSelect.innerHTML = '<option value="">All Jobs</option>' + jobOptions;
            runJobSelect.innerHTML = '<option value="">Choose a job...</option>' + jobOptions;
        }

        function renderExecutions() {
            const tbody = document.getElementById('executions-tbody');
            
            if (executions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                            <i data-lucide="activity" class="h-12 w-12 mx-auto mb-2 text-gray-300"></i>
                            <p>No executions found.</p>
                        </td>
                    </tr>
                `;
                queueLucideRender();
                return;
            }

            tbody.innerHTML = executions.map(exec => {
                const statusBadge = getStatusBadge(exec.status);
                const profile = profiles.find(p => p.id === exec.profileId);
                const profileName = profile ? profile.name : `Profile #${exec.profileId}`;
                
                const startedAt = parseDate(exec.startedAt)?.toLocaleString() || '-';
                const duration = exec.executionTimeMs ? `${(exec.executionTimeMs / 1000).toFixed(2)}s` : '-';
                
                const preProcessBadge = getProcessingBadge(exec.preProcessStatus, exec.preProcessTimeMs);
                const postProcessBadge = getProcessingBadge(exec.postProcessStatus, exec.postProcessTimeMs);

                return `
                    <tr class="group hover:bg-slate-50 cursor-pointer transition-colors duration-200 ease-in-out border-l-4 border-transparent hover:border-blue-500">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i data-lucide="file-code" class="h-4 w-4 text-gray-400 mr-2"></i>
                                <span class="text-sm font-medium text-gray-900 group-hover:text-blue-900 transition-colors">${escapeHtml(profileName)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${startedAt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${duration}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${preProcessBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${postProcessBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${exec.rowCount || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-blue-900 transition-colors">${escapeHtml(exec.triggeredBy || 'System')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails(${exec.id})" class="text-blue-600 hover:text-blue-900">
                                <i data-lucide="eye" class="h-4 w-4 inline"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            queueLucideRender();
        }

        function getStatusBadge(status) {
            const badges = {
                'Success': '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Success</span>',
                'Failed': '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">Failed</span>',
                'Running': '<span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">Running</span>',
                'Partial': '<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">Partial</span>'
            };
            return badges[status] || '<span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full">Unknown</span>';
        }

        function getProcessingBadge(status, timeMs) {
            if (!status) {
                return '<span class="text-gray-400" data-tooltip="Not configured">-</span>';
            }
            
            const time = timeMs ? `${(timeMs / 1000).toFixed(2)}s` : '';
            const badges = {
                'Success': `<span class="inline-flex items-center text-green-600" data-tooltip="Success ${time}"><i data-lucide="check-circle" class="h-4 w-4"></i></span>`,
                'Failed': `<span class="inline-flex items-center text-red-600" data-tooltip="Failed ${time}"><i data-lucide="x-circle" class="h-4 w-4"></i></span>`,
                'Running': `<span class="inline-flex items-center text-blue-600" data-tooltip="Running"><i data-lucide="loader" class="h-4 w-4 animate-spin"></i></span>`,
                'Skipped': `<span class="inline-flex items-center text-yellow-600" data-tooltip="Skipped"><i data-lucide="minus-circle" class="h-4 w-4"></i></span>`
            };
            return badges[status] || '<span class="text-gray-400">-</span>';
        }

        function applyFilters() {
            currentPage = 1; // Reset to first page when filters change
            updateClearButtonVisibility();
            saveExecutionFilters();
            loadExecutions();
        }

        function updateClearButtonVisibility() {
            const profileFilter = document.getElementById('filter-profile').value;
            const jobFilter = document.getElementById('filter-job').value;
            const statusFilter = document.getElementById('filter-status').value;
            const dateFromFilter = document.getElementById('filter-date-from').value;
            const dateToFilter = document.getElementById('filter-date-to').value;
            const searchTerm = document.getElementById('search-input').value;

            const hasActiveFilters = profileFilter || jobFilter || statusFilter || dateFromFilter || dateToFilter || searchTerm;
            const clearBtn = document.getElementById('clear-filters-btn');
            if (clearBtn) {
                clearBtn.style.display = hasActiveFilters ? 'block' : 'none';
            }
        }

        function clearAllFilters() {
            document.getElementById('filter-profile').value = '';
            document.getElementById('filter-job').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('search-input').value = '';

            localStorage.removeItem('executions_filters');
            updateClearButtonVisibility();
            applyFilters();
        }

        function renderPagination() {
            const showingFrom = totalCount > 0 ? (currentPage - 1) * pageSize + 1 : 0;
            const showingTo = Math.min(currentPage * pageSize, totalCount);
            
            document.getElementById('showing-from').textContent = showingFrom;
            document.getElementById('showing-to').textContent = showingTo;
            document.getElementById('total-count').textContent = totalCount;

            const paginationControls = document.getElementById('pagination-controls');
            let html = '';

            // Previous button
            html += `
                <button onclick="previousPage()" ${currentPage === 1 ? 'disabled' : ''} 
                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i data-lucide="chevron-left" class="h-5 w-5"></i>
                </button>
            `;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage;
                html += `
                    <button onclick="goToPage(${i})" 
                        class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                            active 
                                ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                                : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                        }">
                        ${i}
                    </button>
                `;
            }

            // Next button
            html += `
                <button onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''} 
                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}">
                    <i data-lucide="chevron-right" class="h-5 w-5"></i>
                </button>
            `;

            paginationControls.innerHTML = html;
            queueLucideRender();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadExecutions();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadExecutions();
            }
        }

        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadExecutions();
            }
        }

        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('page-size-select').value);
            if (newPageSize !== pageSize) {
                pageSize = newPageSize;
                currentPage = 1; // Reset to first page when changing page size
                loadExecutions();
            }
        }

        async function viewDetails(id) {
            // Show loading state
            document.getElementById('execution-details').innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="loader" class="h-8 w-8 inline animate-spin text-gray-400"></i>
                    <p class="mt-2 text-sm text-gray-500">Loading details...</p>
                </div>
            `;
            document.getElementById('details-modal').classList.remove('hidden');
            queueLucideRender();

            try {
                // Fetch full execution details from API
                const response = await fetch(`${API_BASE}/api/executions/${id}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to load execution details');

                const execution = await response.json();
                
                // Find related data
                const profile = profiles.find(p => p.id === execution.profileId);
                const profileName = profile ? profile.name : `Profile #${execution.profileId}`;

                // Setup download log button
                const downloadBtn = document.getElementById('download-log-btn');
                if (downloadBtn) {
                    downloadBtn.style.display = '';
                    // Remove previous listeners
                    const newBtn = downloadBtn.cloneNode(true);
                    downloadBtn.parentNode.replaceChild(newBtn, downloadBtn);
                    newBtn.onclick = function() {
                        downloadExecutionLog(execution.id, execution.startedAt);
                    };
                }
                
                // Fetch connection details if profile exists
                let connectionInfo = '-';
                let destinationInfo = '-';
                
                if (profile) {
                    // Fetch connection
                    try {
                        const connResponse = await fetch(`${API_BASE}/api/connections/${profile.connectionId}`, {
                            headers: getAuthHeaders()
                        });
                        if (connResponse.ok) {
                            const connection = await connResponse.json();
                            connectionInfo = `${escapeHtml(connection.name)} (${escapeHtml(connection.type)})`;
                        }
                    } catch (e) {
                        console.error('Error loading connection:', e);
                    }
                    
                    // Fetch destination
                    if (profile.outputDestinationId) {
                        try {
                            const destResponse = await fetch(`${API_BASE}/api/destinations/${profile.outputDestinationId}`, {
                                headers: getAuthHeaders()
                            });
                            if (destResponse.ok) {
                                const destination = await destResponse.json();
                                destinationInfo = `${escapeHtml(destination.name)} (${escapeHtml(destination.type)})`;
                            }
                        } catch (e) {
                            console.error('Error loading destination:', e);
                        }
                    }
                }
                
                // Find job if execution was triggered by one
                let jobInfo = '-';
                if (execution.jobId) {
                    const job = jobs.find(j => j.id === execution.jobId);
                    if (job) {
                        jobInfo = escapeHtml(job.name);
                    } else {
                        jobInfo = `Job #${execution.jobId}`;
                    }
                }

                let detailsHtml = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Profile</p>
                            <p class="mt-1 text-sm text-gray-900">${escapeHtml(profileName)}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Status</p>
                            <p class="mt-1">${getStatusBadge(execution.status)}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Connection</p>
                            <p class="mt-1 text-sm text-gray-900">${connectionInfo}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Destination</p>
                            <p class="mt-1 text-sm text-gray-900">${destinationInfo}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Job</p>
                            <p class="mt-1 text-sm text-gray-900">${jobInfo}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Triggered By</p>
                            <p class="mt-1 text-sm text-gray-900">${escapeHtml(execution.triggeredBy || 'System')}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Started At</p>
                            <p class="mt-1 text-sm text-gray-900">${parseDate(execution.startedAt)?.toLocaleString() || '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Completed At</p>
                            <p class="mt-1 text-sm text-gray-900">${execution.completedAt ? parseDate(execution.completedAt)?.toLocaleString() : 'Not yet'}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Execution Time</p>
                            <p class="mt-1 text-sm text-gray-900">${execution.executionTimeMs ? (execution.executionTimeMs / 1000).toFixed(2) + 's' : '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Row Count</p>
                            <p class="mt-1 text-sm text-gray-900">${execution.rowCount || 0}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">File Size</p>
                            <p class="mt-1 text-sm text-gray-900">${execution.fileSizeBytes ? formatBytes(execution.fileSizeBytes) : '-'}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Output File</p>
                            <p class="mt-1 text-sm text-gray-900 break-all">${execution.outputPath ? (() => {
                                const match = execution.outputPath.match(/exports\/[\d-]+\/([^\/]+)\//);
                                const token = match ? match[1] : '';
                                const filename = execution.outputPath.split('/').pop();
                                return token ? `<a href="/api/executions/download/${token}" class="text-blue-600 hover:underline" download>${escapeHtml(filename)}</a>` : escapeHtml(filename || '-');
                            })() : '-'}</p>
                        </div>
                    </div>
                    
                    ${execution.preProcessStatus ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center mb-3">
                                <i data-lucide="play" class="h-5 w-5 text-green-600 mr-2"></i>
                                <h4 class="text-sm font-semibold text-gray-700">Pre-Processing Phase</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Status</p>
                                    <p class="mt-1">${getStatusBadge(execution.preProcessStatus)}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Duration</p>
                                    <p class="mt-1 text-sm text-gray-900">${execution.preProcessTimeMs ? (execution.preProcessTimeMs / 1000).toFixed(2) + 's' : '-'}</p>
                                </div>
                                ${execution.preProcessStartedAt ? `
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Started</p>
                                        <p class="mt-1 text-sm text-gray-900">${parseDate(execution.preProcessStartedAt)?.toLocaleString() || '-'}</p>
                                    </div>
                                ` : ''}
                                ${execution.preProcessCompletedAt ? `
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Completed</p>
                                        <p class="mt-1 text-sm text-gray-900">${parseDate(execution.preProcessCompletedAt)?.toLocaleString() || '-'}</p>
                                    </div>
                                ` : ''}
                            </div>
                            ${execution.preProcessError ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-500 mb-2">Error</p>
                                    <div class="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-800 font-mono whitespace-pre-wrap">${escapeHtml(execution.preProcessError).trim()}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${execution.postProcessStatus ? `
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex items-center mb-3">
                                <i data-lucide="check-circle" class="h-5 w-5 text-blue-600 mr-2"></i>
                                <h4 class="text-sm font-semibold text-gray-700">Post-Processing Phase</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Status</p>
                                    <p class="mt-1">${getStatusBadge(execution.postProcessStatus)}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Duration</p>
                                    <p class="mt-1 text-sm text-gray-900">${execution.postProcessTimeMs ? (execution.postProcessTimeMs / 1000).toFixed(2) + 's' : '-'}</p>
                                </div>
                                ${execution.postProcessStartedAt ? `
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Started</p>
                                        <p class="mt-1 text-sm text-gray-900">${parseDate(execution.postProcessStartedAt)?.toLocaleString() || '-'}</p>
                                    </div>
                                ` : ''}
                                ${execution.postProcessCompletedAt ? `
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Completed</p>
                                        <p class="mt-1 text-sm text-gray-900">${parseDate(execution.postProcessCompletedAt)?.toLocaleString() || '-'}</p>
                                    </div>
                                ` : ''}
                            </div>
                            ${execution.postProcessError ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-500 mb-2">Error</p>
                                    <div class="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-800 font-mono whitespace-pre-wrap">${escapeHtml(execution.postProcessError).trim()}</div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${execution.errorMessage ? `
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-medium text-gray-500">Error Message</p>
                                <button onclick="copyToClipboard('${escapeHtml(execution.errorMessage).replace(/'/g, "\\'").replace(/\n/g, "\\n")}', this)" class="text-xs px-2 py-1 text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50 flex items-center">
                                    <i data-lucide="copy" class="h-3 w-3 mr-1"></i>
                                    Copy
                                </button>
                            </div>
                            <div class="p-3 bg-red-50 border border-red-200 rounded text-sm text-red-800 font-mono whitespace-pre-wrap">${escapeHtml(execution.errorMessage).trim()}</div>
                        </div>
                    ` : ''}
                    ${execution.outputMessage ? `
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-sm font-medium text-gray-500">Response</p>
                                <button onclick="copyToClipboard('${escapeHtml(execution.outputMessage).replace(/'/g, "\\'").replace(/\n/g, "\\n")}', this)" class="text-xs px-2 py-1 text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50 flex items-center">
                                    <i data-lucide="copy" class="h-3 w-3 mr-1"></i>
                                    Copy
                                </button>
                            </div>
                            <div class="p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800 font-mono whitespace-pre-wrap">${escapeHtml(execution.outputMessage).trim()}</div>
                        </div>
                    ` : ''}
                `;

                // Load split details if execution was split
                if (execution.wasSplit) {
                    detailsHtml += `
                        <div id="executionSplitDetails" class="mt-4 border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i data-lucide="scissors" class="w-4 h-4 mr-2"></i>
                                Split Details (${execution.splitSuccessCount || 0}/${execution.splitCount || 0} succeeded)
                            </h4>
                            <div id="splitDetailsList" class="space-y-2">
                                <div class="text-center py-2">
                                    <i data-lucide="loader" class="w-4 h-4 inline animate-spin text-gray-400"></i>
                                    <span class="text-sm text-gray-500 ml-2">Loading split details...</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('execution-details').innerHTML = detailsHtml;
                queueLucideRender();

                // Load split details asynchronously if needed
                if (execution.wasSplit) {
                    await loadSplitDetails(id);
                }
            } catch (error) {
                console.error('Error loading execution details:', error);
                document.getElementById('execution-details').innerHTML = `
                    <div class="text-center py-8">
                        <i data-lucide="alert-circle" class="h-8 w-8 inline text-red-400"></i>
                        <p class="mt-2 text-sm text-red-600">Failed to load execution details</p>
                    </div>
                `;
                queueLucideRender();
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function loadSplitDetails(executionId) {
            try {
                const response = await fetch(`${API_BASE}/api/profiles/executions/${executionId}/splits`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error(`Failed to load split details: ${response.status}`);

                const splits = await response.json();

                const container = document.getElementById('splitDetailsList');
                const detailsSection = document.getElementById('executionSplitDetails');

                if (!splits || splits.length === 0) {
                    // Hide the entire split details section if no records found
                    if (detailsSection) {
                        detailsSection.remove();
                    }
                    return;
                }

                // Ensure container exists before setting innerHTML
                if (!container) {
                    console.error('splitDetailsList container not found - split details section may not be in DOM');
                    return;
                }

                // Clear loading message and populate with split details
                container.innerHTML = splits.map(split => {
                    const statusBadge = split.status === 'Success' 
                        ? '<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Success</span>'
                        : split.status === 'Failed'
                        ? '<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">Failed</span>'
                        : '<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">Running</span>';
                    
                    const fileSizeText = split.fileSizeBytes ? `  ${formatBytes(split.fileSizeBytes)}` : '';
                    
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <code class="text-sm font-mono text-blue-600">${escapeHtml(split.splitKey)}</code>
                                    ${statusBadge}
                                    <span class="text-xs text-gray-500">${split.rowCount} rows${fileSizeText}</span>
                                </div>
                                ${split.outputPath ? `<div class="text-xs text-gray-500 mt-1">${escapeHtml(split.outputPath)}</div>` : ''}
                                ${split.errorMessage ? `<div class="text-xs text-red-600 mt-1">${escapeHtml(split.errorMessage)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                queueLucideRender();
            } catch (error) {
                console.error('Error loading split details:', error);
                const container = document.getElementById('splitDetailsList');
                if (container) {
                    container.innerHTML = '<p class="text-red-500 text-sm">Failed to load split details</p>';
                }
            }
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
        }

        function openExecuteModal() {
            // document.getElementById('execute-modal').classList.remove('hidden');
        }

        function closeExecuteModal() {
            document.getElementById('execute-modal').classList.add('hidden');
            document.getElementById('execute-form').reset();
        }

        document.getElementById('execute-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const profileId = document.getElementById('execute-profile').value;
            if (!profileId) {
                showMessage('Please select a profile', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('reef_token');
                const response = await fetch(`${API_BASE}/api/executions/execute/${profileId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) throw new Error('Failed to test profile');

                const result = await response.json();
                showMessage(`Profile test started. Execution ID: ${result.executionId}`, 'success');
                closeExecuteModal();
                await refreshExecutions();
                if (typeof updateApprovalBadge === 'function') {
                    // Small delay to ensure backend has processed the execution
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await updateApprovalBadge();
                }
            } catch (error) {
                console.error('Error executing profile:', error);
                showMessage(error.message, 'error');
            }
        });

        function openRunJobModal() {
            document.getElementById('run-job-modal').classList.remove('hidden');
        }

        function closeRunJobModal() {
            document.getElementById('run-job-modal').classList.add('hidden');
            document.getElementById('run-job-select').value = '';
        }

        document.getElementById('run-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const jobId = document.getElementById('run-job-select').value;
            if (!jobId) {
                showMessage('Please select a job', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('reef_token');
                const response = await fetch(`${API_BASE}/api/jobs/${jobId}/trigger`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) throw new Error('Failed to trigger job');

                const result = await response.json();
                showMessage(`Job triggered successfully. Execution ID: ${result.executionId}`, 'success');
                closeRunJobModal();
                await refreshExecutions();
                if (typeof updateApprovalBadge === 'function') {
                    // Small delay to ensure backend has processed the trigger
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await updateApprovalBadge();
                }
            } catch (error) {
                console.error('Error triggering job:', error);
                showMessage(error.message, 'error');
            }
        });

        async function refreshExecutions() {
            await loadExecutions();
        }

        async function checkRunningExecutions() {
            const runningExecutions = executions.filter(e => e.status === 'Running');
            if (runningExecutions.length > 0) {
                await refreshExecutions();
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const bgColor = type === 'success' ? 'bg-green-50 border-green-400 text-green-800' : 'bg-red-50 border-red-400 text-red-800';
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';

            container.innerHTML = `
                <div class="${bgColor} border-l-4 p-4 mb-4 rounded" role="alert">
                    <div class="flex items-center">
                        <i data-lucide="${icon}" class="h-5 w-5 mr-2"></i>
                        <p class="font-medium">${message}</p>
                    </div>
                </div>
            `;
            queueLucideRender();

            setTimeout(() => container.innerHTML = '', 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function copyToClipboard(text, button) {
            // Use global copyToClipboard from main.js (HTTP/HTTPS compatible)
            const success = await window.copyToClipboard(text);

            if (success) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i data-lucide="check" class="h-3 w-3 mr-1"></i>Copied!';
                queueLucideRender();
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    queueLucideRender();
                }, 2000);
            } else {
                console.error('Failed to copy');
                showMessage('Failed to copy to clipboard', 'error');
            }
        }

        let userMenuExpanded = false;

        // Toggle user menu
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            const chevron = document.getElementById('chevron-icon');
            userMenuExpanded = !userMenuExpanded;
            
            if (userMenuExpanded) {
                menu.classList.remove('user-menu-collapsed');
                menu.classList.add('user-menu-expanded');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                menu.classList.remove('user-menu-expanded');
                menu.classList.add('user-menu-collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
            
            // Re-render icons after DOM update
            setTimeout(() => queueLucideRender(), 50);
        }

        function logout() {
            clearAuth();
            redirectToLogin();
        }

        window.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
        // Helper to safely parse ISO date with long fractional seconds
        function formatIsoDate(dateStr) {
            if (!dateStr) return '-';
            // Truncate fractional seconds to 3 digits if present
            const fixed = dateStr.replace(/(\.\d{3})\d*(\+|\-|Z)/, '$1$2');
            const d = new Date(fixed);
            return isNaN(d) ? 'Invalid Date' : d.toLocaleString();
        }
    
        // Download execution log as JSON (global, not nested)
        window.downloadExecutionLog = async function(executionId, startedAt) {
            try {
                const response = await fetch(`${API_BASE}/api/executions/${executionId}`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error('Failed to fetch execution details');
                const execution = await response.json();
                // Format timestamp for filename (YYYYMMDD_HHmmss)
                let ts = '';
                if (startedAt) {
                    const d = new Date(startedAt);
                    ts = isNaN(d) ? '' : `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`;
                }
                const filename = `log_${executionId}${ts ? '_' + ts : ''}.json`;
                // Get domain (hostname only, no port, protocol, or path)
                let domain = window.location.hostname;
                // Wrap as requested: [ { id, timestamp, domain, details: { ...all fields... } } ]
                const wrapped = [{
                    id: execution.id,
                    timestamp: execution.startedAt || startedAt || null,
                    domain: domain,
                    details: execution
                }];
                const blob = new Blob([JSON.stringify(wrapped, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (err) {
                showToast('Failed to download log: ' + (err.message || err), 'error');
            }
        }
    </script>
</body>
</html>