@inject ConnectionService ConnectionService
@inject ToastService ToastService
@inject IJSRuntime JS

<form @onsubmit="HandleSubmit" class="space-y-4">
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" @bind="name" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="Production SQL Server">
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
        <select @bind="selectedType" required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="SqlServer">SQL Server</option>
            <option value="MySQL">MySQL</option>
            <option value="PostgreSQL">PostgreSQL</option>
        </select>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            Connection String
            <a href="https://www.connectionstrings.com/" target="_blank" rel="noopener noreferrer"
               class="ml-1 text-gray-400 hover:text-blue-600 cursor-help transition"
               title="Click to visit ConnectionStrings.com for examples">
                <i data-lucide="info" class="w-4 h-4"></i>
            </a>
            <button type="button" @onclick="GenerateConnectionStringExample"
                    class="ml-1 text-gray-400 hover:text-blue-600 cursor-pointer transition"
                    title="Generate connection string example">
                <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
        </label>
        <textarea @bind="connectionString" required rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                  placeholder="Server=myserver;Database=mydb;User Id=sa;Password=***;"></textarea>
        <p class="text-xs text-gray-500 mt-1">Connection string will be encrypted automatically</p>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tags (optional)</label>
        <input type="text" @bind="tags"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="production, crm, financial">
    </div>

    @if (Connection != null && Connection.Id > 0)
    {
        <div class="flex items-center p-3 bg-gray-50 rounded-md">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" @bind="isActive"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <span class="ml-2 text-sm font-medium text-gray-700">Connection is active</span>
            </label>
        </div>
    }

    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
        <button type="button" @onclick="TestConnection" disabled="@isTesting"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
            @if (isTesting)
            {
                <span class="inline-block animate-spin mr-2">
                    <i data-lucide="loader" class="h-4 w-4"></i>
                </span>
                <span>Testing...</span>
            }
            else
            {
                <span>Test Connection</span>
            }
        </button>
        <button type="button" @onclick="OnCancel"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancel
        </button>
        <button type="submit" disabled="@isSaving"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            @if (isSaving)
            {
                <span>Saving...</span>
            }
            else
            {
                <span>Save Connection</span>
            }
        </button>
    </div>
</form>

@code {
    [Parameter]
    public Connection? Connection { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string name = "";
    private string selectedType = "SqlServer";
    private string connectionString = "";
    private string tags = "";
    private bool isActive = true;
    private bool isTesting = false;
    private bool isSaving = false;

    protected override async Task OnParametersSetAsync()
    {
        if (Connection != null)
        {
            name = Connection.Name;
            selectedType = Connection.Type.ToString();
            connectionString = Connection.ConnectionString;
            tags = Connection.Tags ?? "";
            isActive = Connection.IsActive;
        }
        else
        {
            // Reset form for new connection
            name = "";
            selectedType = "SqlServer";
            connectionString = "";
            tags = "";
            isActive = true;
        }

        await JS.InvokeVoidAsync("initLucide");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("initLucide");
    }

    private void GenerateConnectionStringExample()
    {
        connectionString = selectedType switch
        {
            "SqlServer" => "Server=localhost;Database=mydb;User Id=sa;Password=***;TrustServerCertificate=True;",
            "MySQL" => "Server=localhost;Port=3306;Database=mydb;User=root;Password=***;",
            "PostgreSQL" => "Host=localhost;Database=mydb;Username=postgres;Password=***;",
            _ => "Server=localhost;Database=mydb;User Id=user;Password=***;"
        };

        ToastService.ShowSuccess("Connection string example generated!");
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrWhiteSpace(connectionString))
        {
            ToastService.ShowError("Please enter a connection string first");
            return;
        }

        isTesting = true;
        try
        {
            var testResult = await ConnectionService.TestConnectionAsync(selectedType, connectionString);

            if (testResult.Success)
            {
                ToastService.ShowSuccess($"Connection successful! ({testResult.ResponseTimeMs}ms)");
            }
            else
            {
                ToastService.ShowError($"Connection failed: {testResult.Message}");
            }
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to test connection");
            ToastService.ShowError($"Connection test failed: {ex.Message}");
        }
        finally
        {
            isTesting = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(connectionString))
        {
            ToastService.ShowError("Please fill in all required fields");
            return;
        }

        isSaving = true;
        try
        {
            var connection = new Connection
            {
                Id = Connection?.Id ?? 0,
                Name = name,
                Type = selectedType,
                ConnectionString = connectionString,
                Tags = tags ?? "",
                IsActive = isActive,
                Hash = "" // Will be generated by service
            };

            if (connection.Id > 0)
            {
                await ConnectionService.UpdateAsync(connection);
            }
            else
            {
                await ConnectionService.CreateAsync(connection, null); // null for createdByUserId (system user)
            }

            await OnSave.InvokeAsync();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to save connection");
            ToastService.ShowError("Failed to save connection");
        }
        finally
        {
            isSaving = false;
        }
    }
}
