@rendermode InteractiveServer
@inject IJSRuntime JS

<div class="grid grid-cols-2 gap-4">
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Host *</label>
        <input type="text" @bind="Config.Host" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               required
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="sftp.example.com" />
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
        <input type="number" @bind="Config.Port" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="22" />
    </div>
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
    <input type="text" @bind="Config.Username" @bind:event="oninput" @bind:after="NotifyConfigChanged"
           required
           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
           placeholder="sftpuser" />
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Authentication Type</label>
    <select @bind="authType" @bind:after="OnAuthTypeChanged"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="password">Password</option>
        <option value="privatekey">Private Key (SSH)</option>
    </select>
</div>

<!-- Password Auth -->
@if (authType == "password")
{
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
        <input type="password" @bind="Config.Password" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
    </div>
}

<!-- Private Key Auth -->
@if (authType == "privatekey")
{
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Private Key (PEM format) *</label>
        <textarea @bind="Config.PrivateKey" @bind:event="oninput" @bind:after="NotifyConfigChanged"
                  rows="8"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  placeholder="-----BEGIN RSA PRIVATE KEY-----&#10;MIIEpAIBAAKCAQEA...&#10;-----END RSA PRIVATE KEY-----"></textarea>
        <p class="text-xs text-gray-500 mt-1">Paste your private key content (supports RSA, DSA, ECDSA, ED25519)</p>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Passphrase (if encrypted)</label>
        <input type="password" @bind="Config.PrivateKeyPassphrase" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="Leave blank if key is not encrypted" />
        <p class="text-xs text-gray-500 mt-1">Only required if your private key is password-protected</p>
    </div>
}

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Remote Path</label>
    <input type="text" @bind="Config.RemotePath" @bind:event="oninput" @bind:after="NotifyConfigChanged"
           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
           placeholder="/uploads" />
</div>

@code {
    [Parameter] public DestinationConfiguration Config { get; set; } = new();
    [Parameter] public EventCallback<DestinationConfiguration> ConfigChanged { get; set; }

    private string authType = "password";

    protected override void OnInitialized()
    {
        // Set defaults
        if (Config.Port == null || Config.Port == 0)
            Config.Port = 22;

        // Determine auth type from existing config
        if (!string.IsNullOrWhiteSpace(Config.PrivateKey))
            authType = "privatekey";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("initLucide");
    }

    private async Task OnAuthTypeChanged()
    {
        // Clear opposite auth fields when switching
        if (authType == "password")
        {
            Config.PrivateKey = null;
            Config.PrivateKeyPassphrase = null;
        }
        else
        {
            Config.Password = null;
        }
        await NotifyConfigChanged();
    }

    private async Task NotifyConfigChanged()
    {
        await ConfigChanged.InvokeAsync(Config);
    }
}
