@rendermode InteractiveServer

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">URL *</label>
    <input type="url" @bind="Config.Url" @bind:event="oninput" @bind:after="NotifyConfigChanged"
           required
           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
           placeholder="https://api.example.com/upload" />
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">HTTP Method *</label>
    <select @bind="Config.Method" @bind:after="NotifyConfigChanged"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select method...</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="PATCH">PATCH</option>
    </select>
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Authentication Type</label>
    <select @bind="Config.AuthType" @bind:after="OnAuthTypeChanged"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="">None</option>
        <option value="Bearer">Bearer Token</option>
        <option value="ApiKey">API Key (Header)</option>
        <option value="Basic">Basic Auth</option>
    </select>
</div>

@if (!string.IsNullOrEmpty(Config.AuthType) && Config.AuthType != "None")
{
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
            @(Config.AuthType == "Bearer" ? "Bearer Token" : Config.AuthType == "Basic" ? "Username:Password (base64)" : "API Key")
        </label>
        <input type="password" @bind="Config.AuthToken" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="@(Config.AuthType == "ApiKey" ? "x-api-key: your-key-here" : "your-token-here")" />
        <p class="text-xs text-gray-500 mt-1">
            @if (Config.AuthType == "ApiKey")
            {
                <text>Format: header-name: value (e.g., x-api-key: abc123)</text>
            }
            else if (Config.AuthType == "Basic")
            {
                <text>Format: username:password or base64-encoded credentials</text>
            }
            else
            {
                <text>Leave unchanged to keep existing value</text>
            }
        </p>
    </div>
}

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Headers (Optional)</label>
    <textarea @bind="customHeadersText" @bind:event="oninput" @bind:after="ParseCustomHeaders"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Content-Type: application/json&#10;X-Custom-Header: value"></textarea>
    <p class="text-xs text-gray-500 mt-1">One header per line in format: Header-Name: value</p>
</div>

<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
    <div class="flex items-start">
        <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 mr-2 flex-shrink-0"></i>
        <div class="text-xs text-blue-800">
            <strong>Note:</strong> The file will be sent as multipart/form-data with the field name "file".
            The server should expect a standard file upload.
        </div>
    </div>
</div>

@code {
    [Parameter] public DestinationConfiguration Config { get; set; } = new();
    [Parameter] public EventCallback<DestinationConfiguration> ConfigChanged { get; set; }

    private string customHeadersText = "";

    protected override void OnInitialized()
    {
        // Set defaults
        if (string.IsNullOrEmpty(Config.Method))
            Config.Method = "POST";

        // Load custom headers into text format
        if (Config.Headers != null && Config.Headers.Count > 0)
        {
            customHeadersText = string.Join("\n", Config.Headers.Select(h => $"{h.Key}: {h.Value}"));
        }
    }

    private async Task OnAuthTypeChanged()
    {
        if (string.IsNullOrEmpty(Config.AuthType) || Config.AuthType == "None")
        {
            Config.AuthToken = null;
        }
        await NotifyConfigChanged();
    }

    private async Task ParseCustomHeaders()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(customHeadersText))
            {
                Config.Headers = null;
            }
            else
            {
                Config.Headers = new Dictionary<string, string>();
                var lines = customHeadersText.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                foreach (var line in lines)
                {
                    var parts = line.Split(':', 2, StringSplitOptions.TrimEntries);
                    if (parts.Length == 2)
                    {
                        Config.Headers[parts[0]] = parts[1];
                    }
                }
            }
            await NotifyConfigChanged();
        }
        catch
        {
            // Invalid format, ignore
        }
    }

    private async Task NotifyConfigChanged()
    {
        await ConfigChanged.InvokeAsync(Config);
    }
}
