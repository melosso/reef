@rendermode InteractiveServer
@inject IJSRuntime JS

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Bucket Name *</label>
    <input type="text" @bind="Config.BucketName" @bind:event="oninput" @bind:after="NotifyConfigChanged"
           required
           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
           placeholder="my-bucket-name" />
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Region *</label>
    <select @bind="Config.Region" @bind:after="NotifyConfigChanged"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="">Select region...</option>
        <option value="us-east-1">US East (N. Virginia)</option>
        <option value="us-east-2">US East (Ohio)</option>
        <option value="us-west-1">US West (N. California)</option>
        <option value="us-west-2">US West (Oregon)</option>
        <option value="ca-central-1">Canada (Central)</option>
        <option value="eu-west-1">EU (Ireland)</option>
        <option value="eu-central-1">EU (Frankfurt)</option>
        <option value="eu-west-2">EU (London)</option>
        <option value="ap-south-1">Asia Pacific (Mumbai)</option>
        <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
        <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
        <option value="ap-southeast-2">Asia Pacific (Sydney)</option>
        <option value="sa-east-1">South America (SÃ£o Paulo)</option>
    </select>
</div>

<div class="grid grid-cols-2 gap-4">
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Access Key *</label>
        <input type="text" @bind="Config.AccessKey" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
               placeholder="AKIAIOSFODNN7EXAMPLE" />
        <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Secret Key *</label>
        <input type="password" @bind="Config.SecretKey" @bind:event="oninput" @bind:after="NotifyConfigChanged"
               class="w-full px-3 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
        <p class="text-xs text-gray-500 mt-1">Leave unchanged to keep existing value</p>
    </div>
</div>

<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Prefix (Optional)</label>
    <input type="text" @bind="Config.Prefix" @bind:event="oninput" @bind:after="NotifyConfigChanged"
           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
           placeholder="exports/" />
    <p class="text-xs text-gray-500 mt-1">Folder path within bucket (e.g., exports/ or reports/2024/)</p>
</div>

<!-- Advanced Settings -->
<div class="border border-gray-200 rounded-lg">
    <button type="button" @onclick="ToggleAdvanced"
            class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 rounded-lg">
        <div class="flex items-center space-x-2">
            <i data-lucide="sliders" class="w-4 h-4 text-gray-600"></i>
            <span class="text-sm font-medium text-gray-700">Advanced Settings</span>
        </div>
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform @(showAdvanced ? "rotate-180" : "")"></i>
    </button>
    @if (showAdvanced)
    {
        <div class="px-4 pb-4 space-y-4 border-t border-gray-200 pt-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Storage Class</label>
                <select @bind="Config.StorageClass" @bind:after="NotifyConfigChanged"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">STANDARD (default)</option>
                    <option value="STANDARD_IA">STANDARD_IA (Infrequent Access)</option>
                    <option value="ONEZONE_IA">ONEZONE_IA</option>
                    <option value="GLACIER">GLACIER</option>
                    <option value="DEEP_ARCHIVE">DEEP_ARCHIVE</option>
                    <option value="INTELLIGENT_TIERING">INTELLIGENT_TIERING</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ACL (Access Control List)</label>
                <select @bind="Config.Acl" @bind:after="NotifyConfigChanged"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">private (default)</option>
                    <option value="public-read">public-read</option>
                    <option value="public-read-write">public-read-write</option>
                    <option value="authenticated-read">authenticated-read</option>
                    <option value="bucket-owner-read">bucket-owner-read</option>
                    <option value="bucket-owner-full-control">bucket-owner-full-control</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Custom Endpoint (for MinIO/S3-compatible)</label>
                <input type="text" @bind="Config.ServiceUrl" @bind:event="oninput" @bind:after="NotifyConfigChanged"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                       placeholder="https://minio.example.com:9000" />
                <p class="text-xs text-gray-500 mt-1">Leave blank for AWS S3, or specify URL for MinIO/other S3-compatible services</p>
            </div>

            <div class="flex items-start">
                <div class="flex items-center h-5">
                    <input type="checkbox" id="s3-encryption" @bind="Config.ServerSideEncryption" @bind:after="NotifyConfigChanged"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                </div>
                <div class="ml-3">
                    <label for="s3-encryption" class="text-sm font-medium text-gray-700">Server-Side Encryption (AES256)</label>
                    <p class="text-xs text-gray-500 mt-1">Encrypt files at rest using AWS S3-managed encryption keys</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public DestinationConfiguration Config { get; set; } = new();
    [Parameter] public EventCallback<DestinationConfiguration> ConfigChanged { get; set; }

    private bool showAdvanced = false;

    protected override void OnInitialized()
    {
        // Set defaults
        if (!Config.ServerSideEncryption)
            Config.ServerSideEncryption = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("initLucide");
    }

    private void ToggleAdvanced()
    {
        showAdvanced = !showAdvanced;
    }

    private async Task NotifyConfigChanged()
    {
        await ConfigChanged.InvokeAsync(Config);
    }
}
