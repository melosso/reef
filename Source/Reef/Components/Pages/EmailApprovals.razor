@page "/email-approvals"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject EmailApprovalService EmailApprovalService
@inject ProfileService ProfileService
@inject ToastService ToastService
@inject NavigationManager Nav
@using System.Timers
@using Reef.Core.Models

<PageTitle>Email Approvals · Reef</PageTitle>

<div>
    <!-- Header -->
    <div class="flex items-end justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Approvals</h1>
            <p class="text-sm text-gray-500 mt-1">Unified email approval workflow with queue management and audit history.</p>
        </div>
        <button @onclick="RefreshData"
                class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center">
            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>
            Refresh
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="surface-container p-4 border-l-4 border-amber-500">
            <p class="text-[11px] font-bold text-gray-400 uppercase">Pending</p>
            <p class="text-3xl font-semibold text-gray-900 mt-1">@statistics.PendingCount</p>
        </div>
        <div class="surface-container p-4 border-l-4 border-blue-500">
            <p class="text-[11px] font-bold text-gray-400 uppercase">Approved in Queue</p>
            <p class="text-3xl font-semibold text-gray-900 mt-1">@statistics.ApprovedCount</p>
        </div>
        <div class="surface-container p-4 border-l-4 border-green-500">
            <p class="text-[11px] font-bold text-gray-400 uppercase">Sent This Week</p>
            <p class="text-3xl font-semibold text-gray-900 mt-1">@statistics.SentThisWeek</p>
        </div>
        <div class="surface-container p-4 border-l-4 border-yellow-500">
            <p class="text-[11px] font-bold text-gray-400 uppercase">Skipped</p>
            <p class="text-3xl font-semibold text-gray-900 mt-1">@statistics.SkippedCount</p>
        </div>
        <div class="surface-container p-4 border-l-4 border-red-500">
            <p class="text-[11px] font-bold text-gray-400 uppercase">Rejected</p>
            <p class="text-3xl font-semibold text-gray-900 mt-1">@statistics.RejectedCount</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="surface-container overflow-hidden mb-6">
        <div class="border-b border-gray-200">
            <div class="flex">
                <button @onclick='() => SwitchTab("pending")'
                        class="px-6 py-3 text-sm font-medium @(currentTab == "pending" ? "text-gray-900 border-b-2 border-blue-500" : "text-gray-500 border-b-2 border-transparent hover:text-gray-700")">
                    Pending
                </button>
                <button @onclick='() => SwitchTab("approved")'
                        class="px-6 py-3 text-sm font-medium @(currentTab == "approved" ? "text-gray-900 border-b-2 border-blue-500" : "text-gray-500 border-b-2 border-transparent hover:text-gray-700")">
                    Queued
                </button>
                <button @onclick='() => SwitchTab("history")'
                        class="px-6 py-3 text-sm font-medium @(currentTab == "history" ? "text-gray-900 border-b-2 border-blue-500" : "text-gray-500 border-b-2 border-transparent hover:text-gray-700")">
                    History
                </button>
            </div>
        </div>

        <!-- Pending Tab -->
        @if (currentTab == "pending")
        {
            <!-- Bulk Actions Toolbar -->
            @if (selectedApprovals.Count > 0)
            {
                <div class="bg-blue-50 border-b border-blue-200 px-6 py-3 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium text-blue-900">
                            <span>@selectedApprovals.Count</span> selected
                        </span>
                        <button @onclick="ClearSelection" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                            Clear selection
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @onclick="BulkApprove"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-md flex items-center transition-colors">
                            <i data-lucide="check" class="h-4 w-4 mr-2"></i>
                            Approve Selected
                        </button>
                        <button @onclick="BulkReject"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md flex items-center transition-colors">
                            <i data-lucide="x" class="h-4 w-4 mr-2"></i>
                            Reject Selected
                        </button>
                    </div>
                </div>
            }

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50/50 border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-3">
                                <input type="checkbox"
                                       @onchange="ToggleSelectAll"
                                       checked="@IsAllSelected()"
                                       class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            </th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Profile</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Recipients</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Subject</th>
                            <th class="px-6 py-3 text-center text-[11px] font-bold text-gray-400 uppercase">
                                <i data-lucide="paperclip" class="h-4 w-4 inline-block"></i>
                            </th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Created</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        @if (GetPaginatedData("pending").Count == 0)
                        {
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    <i data-lucide="inbox" class="h-12 w-12 mx-auto mb-2 opacity-50 text-gray-400"></i>
                                    <p>No pending approvals</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var approval in GetPaginatedData("pending"))
                            {
                                <tr class="hover:bg-blue-50/30 transition-colors">
                                    <td class="px-6 py-4">
                                        <input type="checkbox"
                                               @onchange="() => ToggleApprovalSelection(approval.Guid)"
                                               checked="@selectedApprovals.Contains(approval.Guid)"
                                               class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-900">@GetProfileName(approval.ProfileId)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">
                                        @if (approval.Recipients == "[REDACTED]")
                                        {
                                            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">Redacted</span>
                                        }
                                        else
                                        {
                                            @Truncate(approval.Recipients, 30)
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">
                                        @if (approval.Subject == "[REDACTED]")
                                        {
                                            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">Redacted</span>
                                        }
                                        else
                                        {
                                            @Truncate(approval.Subject, 30)
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        @if (HasAttachments(approval))
                                        {
                                            <button @onclick="() => PreviewApproval(approval.Guid)" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="paperclip" class="h-4 w-4"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="text-gray-300">—</span>
                                        }
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-600">
                                        @FormatTimestamp(approval.CreatedAt)
                                    </td>
                                    <td class="px-6 py-4 text-sm">
                                        <div class="flex items-center space-x-2">
                                            <button @onclick="() => PreviewApproval(approval.Guid)"
                                                    class="p-2 text-gray-400 hover:text-blue-600 transition-colors"
                                                    title="Preview Email">
                                                <i data-lucide="eye" class="h-4 w-4"></i>
                                            </button>
                                            <button @onclick="() => OpenApprovalModal(approval.Guid)"
                                                    class="p-2 text-gray-400 hover:text-green-600 transition-colors"
                                                    title="Approve">
                                                <i data-lucide="check" class="h-4 w-4"></i>
                                            </button>
                                            <button @onclick="() => OpenSkipModal(approval.Guid)"
                                                    class="p-2 text-gray-400 hover:text-yellow-600 transition-colors"
                                                    title="Skip">
                                                <i data-lucide="skip-forward" class="h-4 w-4"></i>
                                            </button>
                                            <button @onclick="() => OpenRejectModal(approval.Guid)"
                                                    class="p-2 text-gray-400 hover:text-red-600 transition-colors"
                                                    title="Reject">
                                                <i data-lucide="x" class="h-4 w-4"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">@GetShowingFrom("pending")</span> to
                        <span class="font-medium">@GetShowingTo("pending")</span> of
                        <span class="font-medium">@GetTotalCount("pending")</span> results
                    </p>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-700">Per page:</label>
                        <select @onchange="@(e => ChangePendingPageSize(e))"
                                class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="25" selected="@(pageSizes["pending"] == 25)">25</option>
                            <option value="50" selected="@(pageSizes["pending"] == 50)">50</option>
                            <option value="100" selected="@(pageSizes["pending"] == 100)">100</option>
                        </select>
                    </div>
                </div>
                <div>
                    @RenderPaginationControls("pending")
                </div>
            </div>
        }

        <!-- Approved Tab -->
        @if (currentTab == "approved")
        {
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50/50 border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Profile</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Recipients</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Subject</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Approved By</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Approved At</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        @if (GetPaginatedData("approved").Count == 0)
                        {
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    <i data-lucide="check-circle" class="h-12 w-12 mx-auto mb-2 opacity-50 text-gray-400"></i>
                                    <p>Nothing in the outgoing queue</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var approval in GetPaginatedData("approved"))
                            {
                                <tr class="hover:bg-blue-50/30 transition-colors">
                                    <td class="px-6 py-4 text-sm text-gray-900">@GetProfileName(approval.ProfileId)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">@Truncate(approval.Recipients, 30)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">@Truncate(approval.Subject, 30)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@(approval.ApprovedByUserId?.ToString() ?? "N/A")</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@(approval.ApprovedAt.HasValue ? FormatTimestamp(approval.ApprovedAt.Value) : "N/A")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination for Approved -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">@GetShowingFrom("approved")</span> to
                        <span class="font-medium">@GetShowingTo("approved")</span> of
                        <span class="font-medium">@GetTotalCount("approved")</span> results
                    </p>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-700">Per page:</label>
                        <select @onchange="@(e => ChangeApprovedPageSize(e))"
                                class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="25" selected="@(pageSizes["approved"] == 25)">25</option>
                            <option value="50" selected="@(pageSizes["approved"] == 50)">50</option>
                            <option value="100" selected="@(pageSizes["approved"] == 100)">100</option>
                        </select>
                    </div>
                </div>
                <div>
                    @RenderPaginationControls("approved")
                </div>
            </div>
        }

        <!-- History Tab -->
        @if (currentTab == "history")
        {
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50/50 border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Profile</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Status</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Recipients</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Created</th>
                            <th class="px-6 py-3 text-[11px] font-bold text-gray-400 uppercase">Completed</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        @if (GetPaginatedData("history").Count == 0)
                        {
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    <i data-lucide="history" class="h-12 w-12 mx-auto mb-2 opacity-50 text-gray-400"></i>
                                    <p>No history available</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var approval in GetPaginatedData("history"))
                            {
                                <tr class="hover:bg-blue-50/30 transition-colors">
                                    <td class="px-6 py-4 text-sm text-gray-900">@GetProfileName(approval.ProfileId)</td>
                                    <td class="px-6 py-4 text-sm">
                                        <span class="px-2 py-1 rounded text-xs font-medium @GetStatusBadgeClass(approval.Status)">
                                            @approval.Status
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">@Truncate(approval.Recipients, 30)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@FormatTimestamp(approval.CreatedAt)</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@GetCompletedStatus(approval)</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination for History -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">@GetShowingFrom("history")</span> to
                        <span class="font-medium">@GetShowingTo("history")</span> of
                        <span class="font-medium">@GetTotalCount("history")</span> results
                    </p>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-700">Per page:</label>
                        <select @onchange="@(e => ChangeHistoryPageSize(e))"
                                class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="25" selected="@(pageSizes["history"] == 25)">25</option>
                            <option value="50" selected="@(pageSizes["history"] == 50)">50</option>
                            <option value="100" selected="@(pageSizes["history"] == 100)">100</option>
                        </select>
                    </div>
                </div>
                <div>
                    @RenderPaginationControls("history")
                </div>
            </div>
        }
    </div>
</div>

<!-- Email Preview Modal -->
@if (showPreviewModal && previewApproval != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" @onclick="ClosePreviewModal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" @onclick:stopPropagation>
            <div class="sticky top-0 bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Email Preview</h2>
                <button @onclick="ClosePreviewModal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700">Subject</label>
                    <p class="text-gray-900 mt-1 p-3 bg-gray-50 rounded border border-gray-200">
                        @if (previewApproval.Subject == "[REDACTED]")
                        {
                            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">Redacted</span>
                        }
                        else
                        {
                            @previewApproval.Subject
                        }
                    </p>
                </div>

                <div>
                    <label class="text-sm font-semibold text-gray-700">Recipients</label>
                    <p class="text-gray-900 mt-1 p-3 bg-gray-50 rounded border border-gray-200 text-sm break-all">
                        @if (previewApproval.Recipients == "[REDACTED]")
                        {
                            <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">Redacted</span>
                        }
                        else
                        {
                            @previewApproval.Recipients
                        }
                    </p>
                </div>

                <div>
                    <label class="text-sm font-semibold text-gray-700">CC</label>
                    <p class="text-gray-900 mt-1 p-3 bg-gray-50 rounded border border-gray-200 text-sm break-all">
                        @(previewApproval.CcAddresses ?? "(none)")
                    </p>
                </div>

                @if (HasAttachments(previewApproval))
                {
                    <div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-semibold text-gray-700">Attachments</label>
                            <button @onclick="ToggleAttachmentsList"
                                    class="flex items-center space-x-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors">
                                <i data-lucide="paperclip" class="h-4 w-4"></i>
                                <span>@GetAttachmentCount(previewApproval) files</span>
                                <i data-lucide="chevron-down" class="h-4 w-4 @(showAttachmentsList ? "rotate-180" : "")"></i>
                            </button>
                        </div>
                        @if (showAttachmentsList)
                        {
                            <div class="mt-2 p-3 bg-gray-50 rounded border border-gray-200">
                                <p class="text-xs text-gray-500 italic border-b border-gray-300 pb-2 mb-2">
                                    <i data-lucide="info" class="inline h-3 w-3 mr-1"></i>
                                    Attachments cannot be opened or downloaded from this preview for security reasons.
                                </p>
                            </div>
                        }
                    </div>
                }

                <div>
                    <label class="text-sm font-semibold text-gray-700">Email Body</label>
                    <div class="mt-1 p-3 bg-gray-50 rounded border border-gray-200" style="height: 300px;">
                        @if (previewApproval.HtmlBody == "[REDACTED]")
                        {
                            <div class="h-full flex items-center justify-center text-gray-600 font-mono text-sm">
                                Content Redacted
                            </div>
                        }
                        else
                        {
                            <iframe srcdoc="@previewApproval.HtmlBody" style="width:100%;height:100%;border:none;"></iframe>
                        }
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t border-gray-200">
                    <button @onclick="ApproveCurrentPreview"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="check" class="h-4 w-4"></i>
                        Approve
                    </button>
                    <button @onclick="SkipCurrentPreview"
                            class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="skip-forward" class="h-4 w-4"></i>
                        Skip
                    </button>
                    <button @onclick="RejectCurrentPreview"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="x" class="h-4 w-4"></i>
                        Reject
                    </button>
                    <button @onclick="ClosePreviewModal"
                            class="flex-1 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Approval Notes Modal -->
@if (showApprovalModal)
{
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-md mx-auto my-20">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                    <h2 class="text-lg font-semibold text-gray-900">Approve Email</h2>
                    <button @onclick="CloseApprovalModal" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="px-6 py-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Add approval notes (optional):
                    </label>
                    <textarea @bind="approvalNotes"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Add any notes about this approval..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                    <button @onclick="CloseApprovalModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @onclick="ConfirmApproval"
                            class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 flex items-center">
                        <i data-lucide="check" class="h-4 w-4 mr-2"></i>
                        Approve
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Rejection Reason Modal -->
@if (showRejectModal)
{
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-md mx-auto my-20">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                    <h2 class="text-lg font-semibold text-gray-900">Reject Email</h2>
                    <button @onclick="CloseRejectModal" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="px-6 py-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Rejection reason (optional):
                    </label>
                    <textarea @bind="rejectionReason"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Explain why this email is being rejected..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                    <button @onclick="CloseRejectModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @onclick="ConfirmRejection"
                            class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 flex items-center">
                        <i data-lucide="x" class="h-4 w-4 mr-2"></i>
                        Reject
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Skip Notes Modal -->
@if (showSkipModal)
{
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative w-full max-w-md mx-auto my-20">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                    <h2 class="text-lg font-semibold text-gray-900">Skip Email</h2>
                    <button @onclick="CloseSkipModal" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="px-6 py-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Skip notes (optional):
                    </label>
                    <textarea @bind="skipNotes"
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Explain why this email is being skipped..."></textarea>
                    <p class="text-sm text-gray-600 mt-2">
                        <i data-lucide="info" class="inline h-4 w-4 mr-1"></i>
                        The email will not be sent, but the delta sync hash will be committed to prevent future duplicates.
                    </p>
                </div>
                <div class="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
                    <button @onclick="CloseSkipModal"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @onclick="ConfirmSkip"
                            class="px-4 py-2 bg-yellow-600 text-white rounded-md text-sm font-medium hover:bg-yellow-700 flex items-center">
                        <i data-lucide="skip-forward" class="h-4 w-4 mr-2"></i>
                        Skip
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<PendingEmailApproval> allApprovals = new();
    private List<ProfileWithConnection> profiles = new();
    private EmailApprovalStatistics statistics = new();

    private string currentTab = "pending";
    private Dictionary<string, int> currentPages = new() { ["pending"] = 1, ["approved"] = 1, ["history"] = 1 };
    private Dictionary<string, int> pageSizes = new() { ["pending"] = 25, ["approved"] = 25, ["history"] = 25 };

    private HashSet<string> selectedApprovals = new();

    // Modals
    private bool showPreviewModal = false;
    private bool showApprovalModal = false;
    private bool showRejectModal = false;
    private bool showSkipModal = false;
    private bool showAttachmentsList = false;

    private PendingEmailApproval? previewApproval = null;
    private string? currentApprovalGuid = null;
    private string approvalNotes = "";
    private string rejectionReason = "";
    private string skipNotes = "";

    private System.Threading.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfiles();
        await LoadData();
        await LoadStatistics();

        // Auto-refresh every 10 seconds
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadData();
                await LoadStatistics();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(10));
    }

    private async Task LoadData()
    {
        try
        {
            var result = await EmailApprovalService.GetPendingApprovalsAsync(1, 1000);
            allApprovals = result.Item1;
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load email approvals");
            ToastService.ShowError("Failed to load email approvals");
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            statistics = await EmailApprovalService.GetStatisticsAsync();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load statistics");
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            profiles = await ProfileService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load profiles");
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        await LoadStatistics();
        ToastService.ShowSuccess("Approvals refreshed");
    }

    private void SwitchTab(string tab)
    {
        currentTab = tab;
        selectedApprovals.Clear();
    }

    private List<PendingEmailApproval> GetFilteredData(string tab)
    {
        return tab switch
        {
            "pending" => allApprovals.Where(a => a.Status == "Pending").ToList(),
            "approved" => allApprovals.Where(a => a.Status == "Approved").ToList(),
            "history" => allApprovals.Where(a => new[] { "Sent", "Failed", "Rejected", "Skipped" }.Contains(a.Status)).ToList(),
            _ => new()
        };
    }

    private List<PendingEmailApproval> GetPaginatedData(string tab)
    {
        var filtered = GetFilteredData(tab);
        var pageSize = pageSizes[tab];
        var page = currentPages[tab];
        var skip = (page - 1) * pageSize;
        return filtered.Skip(skip).Take(pageSize).ToList();
    }

    private int GetTotalCount(string tab) => GetFilteredData(tab).Count;
    private int GetShowingFrom(string tab)
    {
        var total = GetTotalCount(tab);
        return total > 0 ? ((currentPages[tab] - 1) * pageSizes[tab]) + 1 : 0;
    }
    private int GetShowingTo(string tab)
    {
        var total = GetTotalCount(tab);
        return Math.Min(currentPages[tab] * pageSizes[tab], total);
    }

    private int GetTotalPages(string tab)
    {
        var total = GetTotalCount(tab);
        return (int)Math.Ceiling((double)total / pageSizes[tab]);
    }

    private void ChangePageSize(string tab, int size)
    {
        pageSizes[tab] = size;
        currentPages[tab] = 1;
    }

    private void ChangePendingPageSize(ChangeEventArgs e)
    {
        ChangePageSize("pending", int.Parse(e.Value?.ToString() ?? "25"));
    }

    private void ChangeApprovedPageSize(ChangeEventArgs e)
    {
        ChangePageSize("approved", int.Parse(e.Value?.ToString() ?? "25"));
    }

    private void ChangeHistoryPageSize(ChangeEventArgs e)
    {
        ChangePageSize("history", int.Parse(e.Value?.ToString() ?? "25"));
    }

    private void GoToPage(string tab, int page)
    {
        if (page >= 1 && page <= GetTotalPages(tab))
        {
            currentPages[tab] = page;
        }
    }

    private RenderFragment RenderPaginationControls(string tab) => __builder =>
    {
        var totalPages = GetTotalPages(tab);
        var currentPage = currentPages[tab];

        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
            <button @onclick="() => GoToPage(tab, currentPage - 1)"
                    disabled="@(currentPage == 1)"
                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 @(currentPage == 1 ? "opacity-50 cursor-not-allowed" : "")">
                <i data-lucide="chevron-left" class="h-5 w-5"></i>
            </button>

            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
            {
                var pageNum = i;
                <button @onclick="() => GoToPage(tab, pageNum)"
                        class="relative inline-flex items-center px-4 py-2 border text-sm font-medium @(pageNum == currentPage ? "z-10 bg-blue-50 border-blue-500 text-blue-600" : "bg-white border-gray-300 text-gray-500 hover:bg-gray-50")">
                    @pageNum
                </button>
            }

            <button @onclick="() => GoToPage(tab, currentPage + 1)"
                    disabled="@(currentPage == totalPages || totalPages == 0)"
                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 @(currentPage == totalPages || totalPages == 0 ? "opacity-50 cursor-not-allowed" : "")">
                <i data-lucide="chevron-right" class="h-5 w-5"></i>
            </button>
        </nav>
    };

    // Selection methods
    private void ToggleApprovalSelection(string guid)
    {
        if (selectedApprovals.Contains(guid))
            selectedApprovals.Remove(guid);
        else
            selectedApprovals.Add(guid);
    }

    private void ToggleSelectAll()
    {
        var currentPageData = GetPaginatedData("pending");
        if (IsAllSelected())
        {
            foreach (var approval in currentPageData)
                selectedApprovals.Remove(approval.Guid);
        }
        else
        {
            foreach (var approval in currentPageData)
                selectedApprovals.Add(approval.Guid);
        }
    }

    private bool IsAllSelected()
    {
        var currentPageData = GetPaginatedData("pending");
        return currentPageData.Count > 0 && currentPageData.All(a => selectedApprovals.Contains(a.Guid));
    }

    private void ClearSelection()
    {
        selectedApprovals.Clear();
    }

    // Bulk actions
    private async Task BulkApprove()
    {
        if (selectedApprovals.Count == 0) return;

        var count = selectedApprovals.Count;
        foreach (var guid in selectedApprovals.ToList())
        {
            try
            {
                await EmailApprovalService.ApprovePendingEmailAsync(guid, userId: 1, approvalNotes: "Bulk approval");
            }
            catch (Exception ex)
            {
                Serilog.Log.Error(ex, $"Failed to approve {guid}");
            }
        }

        selectedApprovals.Clear();
        await LoadData();
        await LoadStatistics();
        ToastService.ShowSuccess($"Successfully approved {count} email(s)");
    }

    private async Task BulkReject()
    {
        if (selectedApprovals.Count == 0) return;

        var count = selectedApprovals.Count;
        foreach (var guid in selectedApprovals.ToList())
        {
            try
            {
                await EmailApprovalService.RejectPendingEmailAsync(guid, userId: 1, rejectionReason: "Bulk rejection");
            }
            catch (Exception ex)
            {
                Serilog.Log.Error(ex, $"Failed to reject {guid}");
            }
        }

        selectedApprovals.Clear();
        await LoadData();
        await LoadStatistics();
        ToastService.ShowSuccess($"Successfully rejected {count} email(s)");
    }

    // Preview modal
    private async Task PreviewApproval(string guid)
    {
        try
        {
            previewApproval = await EmailApprovalService.GetPreviewAsync(guid);
            showPreviewModal = true;
            currentApprovalGuid = guid;
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load preview");
            ToastService.ShowError("Failed to load preview");
        }
    }

    private void ClosePreviewModal()
    {
        showPreviewModal = false;
        previewApproval = null;
        showAttachmentsList = false;
    }

    private void ToggleAttachmentsList()
    {
        showAttachmentsList = !showAttachmentsList;
    }

    private async Task ApproveCurrentPreview()
    {
        if (currentApprovalGuid != null)
        {
            await OpenApprovalModal(currentApprovalGuid);
            ClosePreviewModal();
        }
    }

    private async Task SkipCurrentPreview()
    {
        if (currentApprovalGuid != null)
        {
            await OpenSkipModal(currentApprovalGuid);
            ClosePreviewModal();
        }
    }

    private async Task RejectCurrentPreview()
    {
        if (currentApprovalGuid != null)
        {
            await OpenRejectModal(currentApprovalGuid);
            ClosePreviewModal();
        }
    }

    // Approval modal
    private Task OpenApprovalModal(string guid)
    {
        currentApprovalGuid = guid;
        approvalNotes = "";
        showApprovalModal = true;
        return Task.CompletedTask;
    }

    private void CloseApprovalModal()
    {
        showApprovalModal = false;
        currentApprovalGuid = null;
        approvalNotes = "";
    }

    private async Task ConfirmApproval()
    {
        if (currentApprovalGuid == null) return;

        try
        {
            await EmailApprovalService.ApprovePendingEmailAsync(currentApprovalGuid, userId: 1, approvalNotes: string.IsNullOrWhiteSpace(approvalNotes) ? null : approvalNotes);
            ToastService.ShowSuccess("Email approved successfully");
            CloseApprovalModal();
            selectedApprovals.Remove(currentApprovalGuid);
            await LoadData();
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to approve email");
            ToastService.ShowError("Failed to approve email");
        }
    }

    // Reject modal
    private Task OpenRejectModal(string guid)
    {
        currentApprovalGuid = guid;
        rejectionReason = "";
        showRejectModal = true;
        return Task.CompletedTask;
    }

    private void CloseRejectModal()
    {
        showRejectModal = false;
        currentApprovalGuid = null;
        rejectionReason = "";
    }

    private async Task ConfirmRejection()
    {
        if (currentApprovalGuid == null) return;

        try
        {
            await EmailApprovalService.RejectPendingEmailAsync(currentApprovalGuid, userId: 1, rejectionReason: string.IsNullOrWhiteSpace(rejectionReason) ? null : rejectionReason);
            ToastService.ShowSuccess("Email rejected");
            CloseRejectModal();
            selectedApprovals.Remove(currentApprovalGuid);
            await LoadData();
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to reject email");
            ToastService.ShowError("Failed to reject email");
        }
    }

    // Skip modal
    private Task OpenSkipModal(string guid)
    {
        currentApprovalGuid = guid;
        skipNotes = "";
        showSkipModal = true;
        return Task.CompletedTask;
    }

    private void CloseSkipModal()
    {
        showSkipModal = false;
        currentApprovalGuid = null;
        skipNotes = "";
    }

    private async Task ConfirmSkip()
    {
        if (currentApprovalGuid == null) return;

        try
        {
            await EmailApprovalService.SkipPendingEmailAsync(currentApprovalGuid, userId: 1, skipNotes: string.IsNullOrWhiteSpace(skipNotes) ? null : skipNotes);
            ToastService.ShowSuccess("Email skipped (delta sync will be committed)");
            CloseSkipModal();
            selectedApprovals.Remove(currentApprovalGuid);
            await LoadData();
            await LoadStatistics();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to skip email");
            ToastService.ShowError("Failed to skip email");
        }
    }

    // Helper methods
    private string GetProfileName(int profileId)
    {
        var profile = profiles.FirstOrDefault(p => p.Id == profileId);
        return profile?.Name ?? $"Profile #{profileId}";
    }

    private bool HasAttachments(PendingEmailApproval approval)
    {
        if (string.IsNullOrWhiteSpace(approval.AttachmentConfig) || approval.AttachmentConfig == "null")
            return false;

        try
        {
            var config = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(approval.AttachmentConfig);
            // Check for attachments in various formats
            if (config.TryGetProperty("generatedAttachments", out var generated) && generated.GetArrayLength() > 0)
                return true;
            if (config.TryGetProperty("GeneratedAttachments", out var Generated) && Generated.GetArrayLength() > 0)
                return true;
            if (config.TryGetProperty("enabled", out var enabled) && enabled.GetBoolean())
                return true;
            if (config.TryGetProperty("Enabled", out var Enabled) && Enabled.GetBoolean())
                return true;
        }
        catch { }

        return false;
    }

    private int GetAttachmentCount(PendingEmailApproval approval)
    {
        if (string.IsNullOrWhiteSpace(approval.AttachmentConfig) || approval.AttachmentConfig == "null")
            return 0;

        try
        {
            var config = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(approval.AttachmentConfig);
            if (config.TryGetProperty("generatedAttachments", out var generated))
                return generated.GetArrayLength();
            if (config.TryGetProperty("GeneratedAttachments", out var Generated))
                return Generated.GetArrayLength();
            if (config.TryGetProperty("attachments", out var attachments))
                return attachments.GetArrayLength();
        }
        catch { }

        return 0;
    }

    private string Truncate(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text.Substring(0, maxLength) + "...";
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        return timestamp.ToString("MMM dd, yyyy HH:mm:ss");
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Sent" => "bg-green-50 text-green-700 border border-green-200",
            "Failed" => "bg-red-50 text-red-700 border border-red-200",
            "Rejected" => "bg-red-50 text-red-700 border border-red-200",
            "Skipped" => "bg-yellow-50 text-yellow-700 border border-yellow-200",
            "Approved" => "bg-blue-50 text-blue-700 border border-blue-200",
            "Pending" => "bg-amber-50 text-amber-700 border border-amber-200",
            _ => "bg-gray-50 text-gray-700 border border-gray-200"
        };
    }

    private string GetCompletedStatus(PendingEmailApproval approval)
    {
        if (approval.SentAt.HasValue)
            return FormatTimestamp(approval.SentAt.Value);

        return approval.Status switch
        {
            "Rejected" => "Not sent",
            "Skipped" => "Not sent",
            "Failed" => "Failed",
            _ => "Pending"
        };
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
