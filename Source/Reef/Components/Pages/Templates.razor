@page "/templates"
@rendermode InteractiveServer
@inject QueryTemplateService TemplateService
@inject ToastService ToastService
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Templates · Reef</PageTitle>

<div>
    <div class="flex items-end justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Query Templates</h1>
            <p class="text-sm text-gray-500 mt-1">Create and manage Scriban templates for data transformation and export.</p>
        </div>
        <div class="flex space-x-2">
            <button @onclick="OpenHelpModal"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center">
                <i data-lucide="help-circle" class="h-4 w-4 mr-2"></i>
                Help
            </button>
            <button @onclick="OpenAddTemplateModal"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center">
                <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                New Template
            </button>
        </div>
    </div>

    <!-- Metrics Grid (2 cards) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="surface-container p-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-[11px] font-bold text-gray-400 uppercase">Total Templates</p>
                <i data-lucide="file-text" class="h-4 w-4 text-gray-400"></i>
            </div>
            <p class="text-2xl font-semibold text-gray-900">@templates.Count</p>
            <p class="text-xs text-gray-500 mt-2">@activeCount active</p>
        </div>
        <div class="surface-container p-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-[11px] font-bold text-gray-400 uppercase">Active Templates</p>
                <i data-lucide="check-circle" class="h-4 w-4 text-gray-400"></i>
            </div>
            <p class="text-2xl font-semibold text-green-600">@activeCount</p>
            <p class="text-xs text-gray-500 mt-2">Ready for use</p>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="mb-6">
        <FilterBar OnFilterChange="HandleFilterChange"
                   SearchPlaceholder="Search templates by name, type, or tags..."
                   ShowStatusFilter="true"
                   ResultCount="filteredTemplates.Count" />
    </div>

    <!-- Templates Table -->
    <div class="surface-container overflow-hidden">
        @if (filteredTemplates.Count == 0)
        {
            <div class="p-12 text-center">
                <i data-lucide="inbox" class="h-12 w-12 text-gray-300 mx-auto mb-4"></i>
                <p class="text-gray-500 text-sm">
                    @if (string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <text>No templates found. Click "New Template" to create one.</text>
                    }
                    else
                    {
                        <text>No templates match your search.</text>
                    }
                </p>
            </div>
        }
        else
        {
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50/50 border-b border-gray-100">
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Name</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Type</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Output Format</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Tags</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Status</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    @foreach (var template in filteredTemplates)
                    {
                        <tr class="hover:bg-blue-50/30 transition-colors group">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">@template.Name</div>
                                @if (!string.IsNullOrWhiteSpace(template.Description))
                                {
                                    <div class="text-xs text-gray-500 mt-0.5">@template.Description</div>
                                }
                            </td>
                            <td class="px-6 py-4">
                                <StatusBadge Text="@GetTemplateTypeDisplay(template.Type)" Color="purple" />
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                @(template.OutputFormat ?? "N/A")
                            </td>
                            <td class="px-6 py-4">
                                @if (!string.IsNullOrWhiteSpace(template.Tags))
                                {
                                    <div class="flex flex-wrap gap-1">
                                        @foreach (var tag in template.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Take(3))
                                        {
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-700">
                                                @tag
                                            </span>
                                        }
                                        @if (template.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Length > 3)
                                        {
                                            <span class="text-xs text-gray-400">+@(template.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries).Length - 3)</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-xs text-gray-400">—</span>
                                }
                            </td>
                            <td class="px-6 py-4">
                                <StatusBadge
                                    Text="@(template.IsActive ? "Active" : "Inactive")"
                                    Color="@(template.IsActive ? "green" : "gray")"
                                    ShowDot="true" />
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end space-x-2">
                                    <button @onclick="() => EditTemplate(template)"
                                            class="opacity-0 group-hover:opacity-100 p-2 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-400 hover:text-blue-600"
                                            title="Edit">
                                        <i data-lucide="edit-2" class="h-4 w-4"></i>
                                    </button>
                                    <button @onclick="() => DeleteTemplate(template)"
                                            class="opacity-0 group-hover:opacity-100 p-2 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-400 hover:text-red-600"
                                            title="Delete">
                                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Template Modal -->
<Modal Title="@(editingTemplate == null ? "Add New Template" : "Edit Template")"
       IsVisible="showTemplateModal"
       OnClose="CloseTemplateModal"
       Size="extra-large">
    <TemplateForm Template="editingTemplate" OnSave="HandleTemplateSaved" OnCancel="CloseTemplateModal" />
</Modal>

<!-- Help Modal -->
<Modal Title="How to use Templates" IsVisible="showHelpModal" OnClose="CloseHelpModal">
    <div class="space-y-4 text-gray-700 text-sm">
        <p>The <b>Templates</b> page allows you to create and manage transformation templates for your data exports. Templates use the Scriban templating language to format your data into various output formats.</p>

        <h4 class="text-base font-semibold text-gray-800 mt-4">Things to know:</h4>
        <ul class="list-disc list-inside space-y-2 ml-4">
            <li><b>New Template:</b> Click the <b>"New Template"</b> button to create a new Scriban template.</li>
            <li><b>Edit/Delete:</b> Use the Edit and Delete icons that appear when hovering over a row to modify or remove templates.</li>
            <li><b>Template Types:</b> Supports Scriban templates, XSLT transforms, and SQL Server's FOR XML/JSON formats.</li>
            <li><b>Status:</b> Each template shows whether it is <span class="bg-green-100 text-green-800 px-1 rounded text-xs">Active</span> or <span class="bg-gray-200 text-gray-500 px-1 rounded text-xs">Inactive</span>.</li>
            <li><b>Scriban Syntax:</b> Use <code class="bg-gray-100 px-1 rounded">{{"{{"}}column_name{{"}}"}}</code> for placeholders. Variables are case-sensitive.</li>
            <li><b>Output Formats:</b> Templates can generate XML, JSON, CSV, Text, YAML, HTML, EDI, and more.</li>
        </ul>

        <div class="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50 rounded-r-md pr-2">
            <p class="text-blue-800"><strong>Tip:</strong> Test your templates with sample data before using them in profiles to ensure correct formatting.</p>
        </div>

        <h4 class="text-base font-semibold text-gray-800 mt-4">Example Scriban Template:</h4>
        <pre class="bg-gray-100 p-3 rounded text-xs font-mono overflow-x-auto">@("<orders>")
@("  {{ for item in items }}")
@("  <order>")
@("    <id>{{ item.OrderId }}</id>")
@("    <customer>{{ item.CustomerName }}</customer>")
@("    <total>{{ item.Total }}</total>")
@("  </order>")
@("  {{ end }}")
@("</orders>")</pre>
    </div>
</Modal>

<!-- Delete Confirmation Modal -->
<Modal Title="Confirm Delete" IsVisible="@(showDeleteConfirm && deletingTemplate != null)" OnClose="CancelDelete">
    <div class="space-y-4">
        <p class="text-gray-700">Are you sure you want to delete the template <b>"@(deletingTemplate?.Name)"</b>?</p>
        <p class="text-sm text-gray-500">This action cannot be undone. Any profiles using this template will need to be updated.</p>

        <div class="flex justify-end space-x-3 pt-4 border-t">
            <button @onclick="CancelDelete"
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
            <button @onclick="ConfirmDelete"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                Delete
            </button>
        </div>
    </div>
</Modal>

@code {
    private List<QueryTemplate> templates = new();
    private List<QueryTemplate> filteredTemplates = new();
    private int activeCount = 0;
    private string searchQuery = "";
    private string statusFilter = "All";

    private bool showTemplateModal = false;
    private bool showHelpModal = false;
    private bool showDeleteConfirm = false;
    private QueryTemplate? editingTemplate = null;
    private QueryTemplate? deletingTemplate = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initLucide");
        }
    }

    private async Task LoadTemplates()
    {
        try
        {
            var allTemplates = await TemplateService.GetAllAsync();
            templates = allTemplates.ToList();
            activeCount = templates.Count(t => t.IsActive);
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load templates");
            ToastService.ShowError("Failed to load templates");
        }
    }

    private void HandleFilterChange(FilterState filterState)
    {
        searchQuery = filterState.SearchTerm;
        statusFilter = filterState.Status;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredTemplates = templates.Where(t =>
        {
            // Search filter
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var query = searchQuery.ToLower();
                var matchesName = t.Name.ToLower().Contains(query);
                var matchesDescription = (t.Description ?? "").ToLower().Contains(query);
                var matchesType = t.Type.ToString().ToLower().Contains(query);
                var matchesTags = (t.Tags ?? "").ToLower().Contains(query);

                if (!matchesName && !matchesDescription && !matchesType && !matchesTags)
                    return false;
            }

            // Status filter
            if (statusFilter == "Active" && !t.IsActive)
                return false;
            if (statusFilter == "Inactive" && t.IsActive)
                return false;

            return true;
        }).ToList();
    }

    private void OpenAddTemplateModal()
    {
        editingTemplate = null;
        showTemplateModal = true;
    }

    private void EditTemplate(QueryTemplate template)
    {
        editingTemplate = template;
        showTemplateModal = true;
    }

    private void CloseTemplateModal()
    {
        showTemplateModal = false;
        editingTemplate = null;
    }

    private async Task HandleTemplateSaved()
    {
        showTemplateModal = false;
        editingTemplate = null;
        await LoadTemplates();
        ToastService.ShowSuccess("Template saved successfully");
    }

    private void DeleteTemplate(QueryTemplate template)
    {
        deletingTemplate = template;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        deletingTemplate = null;
    }

    private async Task ConfirmDelete()
    {
        if (deletingTemplate == null) return;

        try
        {
            var success = await TemplateService.DeleteAsync(deletingTemplate.Id);
            if (success)
            {
                ToastService.ShowSuccess($"Template '{deletingTemplate.Name}' deleted successfully");
                showDeleteConfirm = false;
                deletingTemplate = null;
                await LoadTemplates();
            }
            else
            {
                ToastService.ShowError("Failed to delete template");
            }
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to delete template {TemplateId}", deletingTemplate.Id);
            ToastService.ShowError("An error occurred while deleting the template");
        }
    }

    private void OpenHelpModal()
    {
        showHelpModal = true;
    }

    private void CloseHelpModal()
    {
        showHelpModal = false;
    }

    private string GetTemplateTypeDisplay(QueryTemplateType type)
    {
        return type switch
        {
            QueryTemplateType.ScribanTemplate => "Scriban",
            QueryTemplateType.DocumentTemplate => "Document",
            QueryTemplateType.XsltTransform => "XSLT",
            QueryTemplateType.ForXmlRaw => "FOR XML RAW",
            QueryTemplateType.ForXmlAuto => "FOR XML AUTO",
            QueryTemplateType.ForXmlPath => "FOR XML PATH",
            QueryTemplateType.ForXmlExplicit => "FOR XML EXPLICIT",
            QueryTemplateType.ForJson => "FOR JSON AUTO",
            QueryTemplateType.ForJsonPath => "FOR JSON PATH",
            _ => type.ToString()
        };
    }
}
