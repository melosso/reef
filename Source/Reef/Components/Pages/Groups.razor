@page "/groups"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject GroupService GroupService
@inject ProfileService ProfileService
@inject ToastService ToastService
@inject NavigationManager Nav

<PageTitle>Groups · Reef</PageTitle>

<div>
    <div class="flex items-end justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Groups</h1>
            <p class="text-sm text-gray-500 mt-1">Organize and categorize your profiles into logical groups.</p>
        </div>
        <div class="flex space-x-2">
            <button @onclick="OpenHelpModal"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all flex items-center">
                <i data-lucide="help-circle" class="h-4 w-4 mr-2"></i>
                Help
            </button>
            <button @onclick="OpenAddGroupModal"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center">
                <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                New Group
            </button>
        </div>
    </div>

    <!-- Metrics Grid (2 cards) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="surface-container p-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-[11px] font-bold text-gray-400 uppercase">Total Groups</p>
                <i data-lucide="folder" class="h-4 w-4 text-gray-400"></i>
            </div>
            <p class="text-2xl font-semibold text-gray-900">@groups.Count</p>
            <p class="text-xs text-gray-500 mt-2">@totalProfilesInGroups profiles organized</p>
        </div>
        <div class="surface-container p-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-[11px] font-bold text-gray-400 uppercase">Active Groups</p>
                <i data-lucide="check-circle" class="h-4 w-4 text-gray-400"></i>
            </div>
            <p class="text-2xl font-semibold text-green-600">@groups.Count</p>
            <p class="text-xs text-gray-500 mt-2">All groups active</p>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="mb-6">
        <FilterBar OnFilterChange="HandleFilterChange"
                   SearchPlaceholder="Search groups by name or description..."
                   ShowStatusFilter="false"
                   ResultCount="filteredGroups.Count" />
    </div>

    <!-- Groups Table -->
    <div class="surface-container overflow-hidden">
        @if (filteredGroups.Count == 0)
        {
            <div class="p-12 text-center">
                <i data-lucide="inbox" class="h-12 w-12 text-gray-300 mx-auto mb-4"></i>
                <p class="text-gray-500 text-sm">
                    @if (string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <text>No groups found. Click "New Group" to create one.</text>
                    }
                    else
                    {
                        <text>No groups match your search.</text>
                    }
                </p>
            </div>
        }
        else
        {
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50/50 border-b border-gray-100">
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Name</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Description</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase">Profiles</th>
                        <th class="px-6 py-4 text-[11px] font-bold text-gray-400 uppercase text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    @foreach (var group in filteredGroups)
                    {
                        var profileCount = profileCounts.ContainsKey(group.Id) ? profileCounts[group.Id] : 0;

                        <tr class="hover:bg-blue-50/30 transition-colors group">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <i data-lucide="folder" class="h-4 w-4 text-gray-400 mr-2"></i>
                                    <span class="font-medium text-gray-900">@group.Name</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                @(group.Description ?? "—")
                            </td>
                            <td class="px-6 py-4">
                                @if (profileCount > 0)
                                {
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-blue-100 text-blue-700">
                                        @profileCount profile@(profileCount > 1 ? "s" : "")
                                    </span>
                                }
                                else
                                {
                                    <span class="text-xs text-gray-400">No profiles</span>
                                }
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end space-x-2">
                                    <button @onclick="() => EditGroup(group)"
                                            class="opacity-0 group-hover:opacity-100 p-2 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-400 hover:text-blue-600"
                                            title="Edit">
                                        <i data-lucide="edit-2" class="h-4 w-4"></i>
                                    </button>
                                    <button @onclick="() => DeleteGroup(group)"
                                            class="opacity-0 group-hover:opacity-100 p-2 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-400 hover:text-red-600"
                                            title="Delete">
                                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<!-- Group Modal -->
<Modal Title="@(editingGroup == null ? "Add New Group" : "Edit Group")"
       IsVisible="showGroupModal"
       OnClose="CloseGroupModal"
       Size="medium">
    <GroupForm Group="editingGroup" OnSave="HandleGroupSaved" OnCancel="CloseGroupModal" />
</Modal>

<!-- Help Modal -->
<Modal Title="How to use Groups" IsVisible="showHelpModal" OnClose="CloseHelpModal">
    <div class="space-y-4 text-gray-700 text-sm">
        <p>The <b>Groups</b> page allows you to organize and categorize your profiles into logical groups for better management and organization.</p>

        <h4 class="text-base font-semibold text-gray-800 mt-4">Things to know:</h4>
        <ul class="list-disc list-inside space-y-2 ml-4">
            <li><b>New Group:</b> Click the <b>"New Group"</b> button to create a new group.</li>
            <li><b>Edit/Delete:</b> Use the Edit and Delete icons that appear when hovering over a row to modify or remove groups.</li>
            <li><b>Profile Assignment:</b> When creating or editing a profile, you can assign it to a group.</li>
            <li><b>Profile Count:</b> Each group displays the number of profiles it contains.</li>
            <li><b>Organization:</b> Groups help you organize profiles by department, project, data source, or any other logical categorization.</li>
        </ul>

        <div class="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50 rounded-r-md pr-2">
            <p class="text-blue-800"><strong>Tip:</strong> Use groups to organize profiles by business function (e.g., "Finance", "Sales", "Operations") for easier navigation and management.</p>
        </div>

        <h4 class="text-base font-semibold text-gray-800 mt-4">Example Groups:</h4>
        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
            <li>Finance Reports</li>
            <li>Customer Data Exports</li>
            <li>Inventory Management</li>
            <li>HR Department</li>
        </ul>
    </div>
</Modal>

<!-- Delete Confirmation Modal -->
<Modal Title="Confirm Delete" IsVisible="@(showDeleteConfirm && deletingGroup != null)" OnClose="CancelDelete">
    <div class="space-y-4">
        @{
            var profileCount = deletingGroup != null && profileCounts.ContainsKey(deletingGroup.Id) ? profileCounts[deletingGroup.Id] : 0;
        }
        <p class="text-gray-700">Are you sure you want to delete the group <b>"@(deletingGroup?.Name)"</b>?</p>
        @if (profileCount > 0)
        {
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-r-md">
                <p class="text-sm text-yellow-800">
                    <strong>Warning:</strong> This group contains @profileCount profile@(profileCount > 1 ? "s" : ""). Deleting this group will not delete the profiles, but they will be unassigned from this group.
                </p>
            </div>
        }

        <div class="flex justify-end space-x-3 pt-4 border-t">
            <button @onclick="CancelDelete"
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
            <button @onclick="ConfirmDelete"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                Delete
            </button>
        </div>
    </div>
</Modal>

@code {
    private List<ProfileGroup> groups = new();
    private List<ProfileGroup> filteredGroups = new();
    private Dictionary<int, int> profileCounts = new();
    private int totalProfilesInGroups = 0;
    private string searchQuery = "";

    private bool showGroupModal = false;
    private bool showHelpModal = false;
    private bool showDeleteConfirm = false;
    private ProfileGroup? editingGroup = null;
    private ProfileGroup? deletingGroup = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    private async Task LoadGroups()
    {
        try
        {
            // Load groups and profiles
            var groupsTask = GroupService.GetAllAsync();
            var profilesTask = ProfileService.GetAllAsync();

            await Task.WhenAll(groupsTask, profilesTask);

            groups = groupsTask.Result.ToList();
            var profiles = profilesTask.Result.ToList();

            // Calculate profile counts per group
            profileCounts = profiles
                .Where(p => p.GroupId.HasValue)
                .GroupBy(p => p.GroupId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());

            totalProfilesInGroups = profiles.Count(p => p.GroupId.HasValue);

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to load groups");
            ToastService.ShowError("Failed to load groups");
        }
    }

    private void HandleFilterChange(FilterState filterState)
    {
        searchQuery = filterState.SearchTerm;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredGroups = groups.Where(g =>
        {
            // Search filter
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                var query = searchQuery.ToLower();
                var matchesName = g.Name.ToLower().Contains(query);
                var matchesDescription = (g.Description ?? "").ToLower().Contains(query);

                if (!matchesName && !matchesDescription)
                    return false;
            }

            return true;
        }).ToList();
    }

    private void OpenAddGroupModal()
    {
        editingGroup = null;
        showGroupModal = true;
    }

    private void EditGroup(ProfileGroup group)
    {
        editingGroup = group;
        showGroupModal = true;
    }

    private void CloseGroupModal()
    {
        showGroupModal = false;
        editingGroup = null;
    }

    private async Task HandleGroupSaved()
    {
        showGroupModal = false;
        editingGroup = null;
        await LoadGroups();
        ToastService.ShowSuccess("Group saved successfully");
    }

    private void DeleteGroup(ProfileGroup group)
    {
        deletingGroup = group;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        deletingGroup = null;
    }

    private async Task ConfirmDelete()
    {
        if (deletingGroup == null) return;

        try
        {
            var success = await GroupService.DeleteAsync(deletingGroup.Id);
            if (success)
            {
                ToastService.ShowSuccess($"Group '{deletingGroup.Name}' deleted successfully");
                showDeleteConfirm = false;
                deletingGroup = null;
                await LoadGroups();
            }
            else
            {
                ToastService.ShowError("Failed to delete group");
            }
        }
        catch (Exception ex)
        {
            Serilog.Log.Error(ex, "Failed to delete group {GroupId}", deletingGroup.Id);
            ToastService.ShowError("An error occurred while deleting the group");
        }
    }

    private void OpenHelpModal()
    {
        showHelpModal = true;
    }

    private void CloseHelpModal()
    {
        showHelpModal = false;
    }
}
